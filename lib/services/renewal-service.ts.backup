/**
 * Servicio de Renovaciones Inteligentes de Contratos
 * Utiliza IA para predecir renovaciones, calcular IPC, generar propuestas automáticas
 */
import { prisma } from '@/lib/db';
import { addDays, differenceInDays, addMonths, addYears, format } from 'date-fns';
import { es } from 'date-fns/locale';

// ============ ANÁLISIS PREDICTIVO DE RENOVACIONES ============

export interface AnalyzeContractParams {
  contractId: string;
}

export async function analyzeContractForRenewal(contractId: string) {
  const contrato = await prisma.contract.findUnique({
    where: { id: contractId },
    include: {
      tenant: true,
      unit: { include: { building: true } },
      payments: {
        where: { estado: { in: ['pagado', 'pendiente'] } },
        orderBy: { fechaVencimiento: 'desc' },
      },
      maintenanceRequests: {
        orderBy: { createdAt: 'desc' },
      },
    },
  });

  if (!contrato) throw new Error('Contrato no encontrado');

  // Calcular probabilidad de renovación basándose en varios factores
  let probabilidadRenovacion = 50; // Base 50%
  const factores: any[] = [];

  // Factor 1: Puntualidad en pagos (30% peso)
  const pagosPuntuales = contrato.payments.filter(p => {
    if (!p.fechaPago) return false;
    return p.fechaPago <= p.fechaVencimiento;
  });
  const porcentajePuntualidad = contrato.payments.length > 0
    ? (pagosPuntuales.length / contrato.payments.length) * 100
    : 100;

  if (porcentajePuntualidad >= 90) {
    probabilidadRenovacion += 15;
    factores.push({ factor: 'Puntualidad en pagos', impacto: +15, detalle: `${porcentajePuntualidad.toFixed(0)}% pagos a tiempo` });
  } else if (porcentajePuntualidad < 70) {
    probabilidadRenovacion -= 10;
    factores.push({ factor: 'Morosidad', impacto: -10, detalle: `Solo ${porcentajePuntualidad.toFixed(0)}% pagos a tiempo` });
  }

  // Factor 2: Antigüedad en el inmueble (20% peso)
  const mesesContrato = differenceInDays(new Date(), contrato.fechaInicio) / 30;
  if (mesesContrato > 24) {
    probabilidadRenovacion += 10;
    factores.push({ factor: 'Antigüedad', impacto: +10, detalle: `${Math.floor(mesesContrato)} meses en el inmueble` });
  } else if (mesesContrato < 6) {
    probabilidadRenovacion -= 5;
    factores.push({ factor: 'Contrato reciente', impacto: -5, detalle: `Solo ${Math.floor(mesesContrato)} meses` });
  }

  // Factor 3: Historial de incidencias (15% peso)
  const incidencias = contrato.maintenanceRequests.length;
  if (incidencias === 0) {
    probabilidadRenovacion += 10;
    factores.push({ factor: 'Sin incidencias', impacto: +10, detalle: 'Inquilino sin solicitudes de mantenimiento' });
  } else if (incidencias > 5) {
    probabilidadRenovacion -= 8;
    factores.push({ factor: 'Múltiples incidencias', impacto: -8, detalle: `${incidencias} solicitudes de mantenimiento` });
  }

  // Factor 4: Renta actual vs mercado (25% peso)
  const rentaMercado = await calcularRentaMercado(contrato.unit.buildingId);
  const diferenciaRenta = ((contrato.rentaMensual || 0) - rentaMercado) / rentaMercado * 100;

  if (diferenciaRenta < -15) {
    // Renta muy por debajo del mercado
    probabilidadRenovacion += 15;
    factores.push({ factor: 'Renta competitiva', impacto: +15, detalle: `${Math.abs(diferenciaRenta).toFixed(0)}% por debajo del mercado` });
  } else if (diferenciaRenta > 10) {
    // Renta por encima del mercado
    probabilidadRenovacion -= 12;
    factores.push({ factor: 'Renta alta', impacto: -12, detalle: `${diferenciaRenta.toFixed(0)}% por encima del mercado` });
  }

  // Factor 5: Días hasta fin de contrato (10% peso)
  const diasHastaFin = contrato.fechaFin ? differenceInDays(contrato.fechaFin, new Date()) : 365;
  if (diasHastaFin < 90 && diasHastaFin > 0) {
    factores.push({ factor: 'Fin contrato próximo', impacto: 0, detalle: `${diasHastaFin} días restantes` });
  }

  // Limitar entre 0-100
  probabilidadRenovacion = Math.max(0, Math.min(100, probabilidadRenovacion));

  // Calcular nueva renta sugerida (IPC + ajuste de mercado)
  const ipcAnual = await obtenerIPCAnual();
  const nuevaRentaSugerida = (contrato.rentaMensual || 0) * (1 + ipcAnual / 100);

  // Determinar recomendación
  let recomendacion: 'renovar' | 'negociar' | 'no_renovar' = 'renovar';
  if (probabilidadRenovacion < 40) {
    recomendacion = 'no_renovar';
  } else if (probabilidadRenovacion < 65) {
    recomendacion = 'negociar';
  }

  return {
    contratoId: contractId,
    tenant: contrato.tenant.nombreCompleto,
    unidad: contrato.unit.numero,
    probabilidadRenovacion: Math.round(probabilidadRenovacion),
    factores,
    recomendacion,
    rentaActual: contrato.rentaMensual,
    rentaSugeridaRenovacion: Math.round(nuevaRentaSugerida),
    ipcAplicado: ipcAnual,
    diasHastaVencimiento: diasHastaFin,
  };
}

// ============ GENERAR RECOMENDACIONES MASIVAS ============

export async function generateRenewalRecommendations(companyId: string) {
  // Buscar contratos próximos a vencer (90-180 días)
  const fechaLimiteInicio = addDays(new Date(), 90);
  const fechaLimiteFin = addDays(new Date(), 180);

  const contratosProximosVencer = await prisma.contract.findMany({
    where: {
      building: { companyId },
      estado: 'activo',
      fechaFin: {
        gte: fechaLimiteInicio,
        lte: fechaLimiteFin,
      },
    },
    include: {
      tenant: true,
      unit: { include: { building: true } },
    },
  });

  const recomendaciones = [];

  for (const contrato of contratosProximosVencer) {
    try {
      const analisis = await analyzeContractForRenewal(contrato.id);
      recomendaciones.push(analisis);
    } catch (error) {
      console.error(`Error analizando contrato ${contrato.id}:`, error);
    }
  }

  // Ordenar por probabilidad (mayor a menor)
  recomendaciones.sort((a, b) => b.probabilidadRenovacion - a.probabilidadRenovacion);

  return recomendaciones;
}

// ============ CREAR RENOVACIÓN CON PROPUESTA AUTOMÁTICA ============

export interface CreateRenewalParams {
  contractId: string;
  aplicarIPC?: boolean;
  incrementoManual?: number; // Porcentaje
  duracionMeses?: number;
}

export async function createContractRenewal(params: CreateRenewalParams) {
  const contrato = await prisma.contract.findUnique({
    where: { id: params.contractId },
    include: {
      tenant: true,
      unit: { include: { building: true } },
    },
  });

  if (!contrato) throw new Error('Contrato no encontrado');

  // Realizar análisis predictivo
  const analisis = await analyzeContractForRenewal(params.contractId);

  // Calcular nueva renta
  let nuevaRenta = contrato.rentaMensual || 0;
  let porcentajeIncremento = 0;

  if (params.incrementoManual !== undefined) {
    porcentajeIncremento = params.incrementoManual;
  } else if (params.aplicarIPC !== false) {
    porcentajeIncremento = await obtenerIPCAnual();
  }

  nuevaRenta = contrato.rentaMensual! * (1 + porcentajeIncremento / 100);

  // Calcular fechas de la renovación
  const nuevaFechaInicio = contrato.fechaFin ? addDays(contrato.fechaFin, 1) : addMonths(new Date(), 1);
  const duracion = params.duracionMeses || 12;
  const nuevaFechaFin = addMonths(nuevaFechaInicio, duracion);

  // Crear registro de renovación
  const renovacion = await prisma.contractRenewal.create({
    data: {
      contractId: params.contractId,
      companyId: contrato.building.companyId,
      fechaPropuesta: new Date(),
      estadoRenovacion: 'propuesta_enviada',
      rentaAnterior: contrato.rentaMensual!,
      rentaPropuesta: nuevaRenta,
      incrementoPorcentaje: porcentajeIncremento,
      duracionMeses: duracion,
      fechaInicioRenovacion: nuevaFechaInicio,
      fechaFinRenovacion: nuevaFechaFin,
      probabilidadAceptacion: analisis.probabilidadRenovacion,
      factoresAnalisis: analisis.factores,
    },
  });

  // Generar documento de propuesta automáticamente
  const propuestaTexto = generarTextoPropuesta(contrato, renovacion, analisis);

  await prisma.contractRenewal.update({
    where: { id: renovacion.id },
    data: {
      documentoPropuesta: propuestaTexto,
    },
  });

  // TODO: Enviar notificación al inquilino

  return renovacion;
}

// ============ ACEPTAR/RECHAZAR RENOVACIÓN ============

export async function acceptRenewal(renewalId: string) {
  const renovacion = await prisma.contractRenewal.findUnique({
    where: { id: renewalId },
    include: {
      contract: true,
    },
  });

  if (!renovacion) throw new Error('Renovación no encontrada');

  // Actualizar contrato actual
  await prisma.contract.update({
    where: { id: renovacion.contractId },
    data: {
      fechaFin: renovacion.fechaInicioRenovacion,
    },
  });

  // Crear nuevo contrato renovado
  const nuevoContrato = await prisma.contract.create({
    data: {
      buildingId: renovacion.contract.buildingId,
      unitId: renovacion.contract.unitId,
      tenantId: renovacion.contract.tenantId,
      fechaInicio: renovacion.fechaInicioRenovacion,
      fechaFin: renovacion.fechaFinRenovacion,
      rentaMensual: renovacion.rentaPropuesta,
      depositoFianza: renovacion.contract.depositoFianza,
      estado: 'activo',
      tipoContrato: renovacion.contract.tipoContrato,
      documentoContrato: '', // TODO: Generar nuevo documento
    },
  });

  // Actualizar renovación
  await prisma.contractRenewal.update({
    where: { id: renewalId },
    data: {
      estadoRenovacion: 'aceptada',
      fechaAceptacion: new Date(),
      nuevoContratoId: nuevoContrato.id,
    },
  });

  return nuevoContrato;
}

export async function rejectRenewal(renewalId: string, motivo: string) {
  return await prisma.contractRenewal.update({
    where: { id: renewalId },
    data: {
      estadoRenovacion: 'rechazada',
      fechaRespuesta: new Date(),
      motivoRechazo: motivo,
    },
  });
}

// ============ ESTADÍSTICAS DE RENOVACIONES ============

export async function getRenewalStats(companyId: string) {
  const renovaciones = await prisma.contractRenewal.findMany({
    where: { companyId },
  });

  const totalRenewals = renovaciones.length;
  const successfulRenewals = renovaciones.filter(r => r.estadoRenovacion === 'aceptada').length;
  const pendingRenewals = renovaciones.filter(r => r.estadoRenovacion === 'propuesta_enviada').length;
  const rejectedRenewals = renovaciones.filter(r => r.estadoRenovacion === 'rechazada').length;

  const averageProbability = renovaciones.length > 0
    ? renovaciones.reduce((sum, r) => sum + (r.probabilidadAceptacion || 0), 0) / renovaciones.length
    : 0;

  const averageIncrease = renovaciones.length > 0
    ? renovaciones.reduce((sum, r) => sum + r.incrementoPorcentaje, 0) / renovaciones.length
    : 0;

  return {
    totalRenewals,
    successfulRenewals,
    pendingRenewals,
    rejectedRenewals,
    averageProbability: Math.round(averageProbability),
    averageIncrease: Math.round(averageIncrease * 100) / 100,
    successRate: totalRenewals > 0 ? (successfulRenewals / totalRenewals) * 100 : 0,
  };
}

// ============ UTILIDADES ============

async function calcularRentaMercado(buildingId: string): Promise<number> {
  // Calcular renta promedio de unidades similares en el edificio
  const unidades = await prisma.unit.findMany({
    where: { buildingId },
    include: {
      contracts: {
        where: { estado: 'activo' },
        take: 1,
      },
    },
  });

  const rentasActivas = unidades
    .map(u => u.contracts[0]?.rentaMensual)
    .filter((r): r is number => r !== null && r !== undefined);

  if (rentasActivas.length === 0) return 800; // Valor por defecto

  return rentasActivas.reduce((sum, r) => sum + r, 0) / rentasActivas.length;
}

async function obtenerIPCAnual(): Promise<number> {
  // En producción, esto debería consultar una API del INE
  // Por ahora, devolvemos un valor estimado del IPC de España
  return 3.5; // 3.5% (aproximado 2024)
}

function generarTextoPropuesta(contrato: any, renovacion: any, analisis: any): string {
  return `
PROPUESTA DE RENOVACIÓN DE CONTRATO DE ARRENDAMIENTO

Estimado/a ${contrato.tenant.nombreCompleto},

Nos complace informarle que estamos interesados en renovar su contrato de arrendamiento para la vivienda ubicada en:
${contrato.unit.building.direccion}, Unidad ${contrato.unit.numero}

CONDICIONES DE RENOVACIÓN:
- Renta mensual actual: €${contrato.rentaMensual?.toFixed(2)}
- Renta mensual propuesta: €${renovacion.rentaPropuesta.toFixed(2)}
- Incremento: ${renovacion.incrementoPorcentaje.toFixed(2)}% (aplicación IPC)
- Duración: ${renovacion.duracionMeses} meses
- Fecha inicio: ${format(renovacion.fechaInicioRenovacion, 'dd/MM/yyyy', { locale: es })}
- Fecha fin: ${format(renovacion.fechaFinRenovacion, 'dd/MM/yyyy', { locale: es })}

Agradeceríamos su respuesta antes del ${format(addDays(new Date(), 30), 'dd/MM/yyyy', { locale: es })}.

Atentamente,
Departamento de Gestión
  `.trim();
}

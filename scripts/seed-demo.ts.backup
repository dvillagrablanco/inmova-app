import { PrismaClient } from '@prisma/client';
import * as bcrypt from 'bcryptjs';
import { addDays, addMonths, subDays, subMonths } from 'date-fns';

const prisma = new PrismaClient();

async function main() {
  console.log('ðŸŒ± Iniciando seed de base de datos con datos completos de demostraciÃ³n...');

  // ==========================================
  // EMPRESA Y USUARIOS
  // ==========================================
  const company = await prisma.company.upsert({
    where: { id: 'inmova-default' },
    update: {},
    create: {
      id: 'inmova-default',
      nombre: 'INMOVA',
      email: 'info@inmova.es',
      telefono: '+34 900 123 456',
      direccion: 'Calle Serrano, 45',
      ciudad: 'Madrid',
      codigoPostal: '28001',
      pais: 'EspaÃ±a',
      activo: true
    }
  });

  const hashedPassword = await bcrypt.hash('admin123', 10);
  
  const admin = await prisma.user.upsert({
    where: { email: 'admin@inmova.es' },
    update: {},
    create: {
      email: 'admin@inmova.es',
      name: 'Admin INMOVA',
      password: hashedPassword,
      role: 'administrador',
      companyId: company.id,
      activo: true
    }
  });

  const gestor = await prisma.user.upsert({
    where: { email: 'gestor@inmova.es' },
    update: {},
    create: {
      email: 'gestor@inmova.es',
      name: 'Gestor INMOVA',
      password: hashedPassword,
      role: 'gestor',
      companyId: company.id,
      activo: true
    }
  });

  console.log('âœ… Empresa y usuarios creados');

  // ==========================================
  // EDIFICIOS
  // ==========================================
  const building1 = await prisma.building.create({
    data: {
      companyId: company.id,
      nombre: 'Torre Vista Hermosa',
      direccion: 'Av. Diagonal 123, Barcelona',
      tipo: 'residencial',
      anoConstructor: 2018,
      numeroUnidades: 12,
      ascensor: true,
      garaje: true,
      piscina: false,
      jardin: false,
      estadoConservacion: 'excelente',
      certificadoEnergetico: 'B',
      gastosComunidad: 120,
      ibiAnual: 850,
      latitud: 41.3874,
      longitud: 2.1686,
    }
  });

  const building2 = await prisma.building.create({
    data: {
      companyId: company.id,
      nombre: 'Residencia Coliving Madrid Centro',
      direccion: 'Calle Gran VÃ­a 88, Madrid',
      tipo: 'residencial',
      anoConstructor: 2020,
      numeroUnidades: 8,
      ascensor: true,
      garaje: false,
      piscina: false,
      jardin: false,
      estadoConservacion: 'nuevo',
      certificadoEnergetico: 'A',
      gastosComunidad: 95,
      ibiAnual: 720,
      latitud: 40.4168,
      longitud: -3.7038,
    }
  });

  const building3 = await prisma.building.create({
    data: {
      companyId: company.id,
      nombre: 'Edificio InnovaciÃ³n STR',
      direccion: 'Rambla del Raval 30, Barcelona',
      tipo: 'residencial',
      anoConstructor: 2019,
      numeroUnidades: 6,
      ascensor: true,
      garaje: false,
      piscina: false,
      jardin: false,
      estadoConservacion: 'bueno',
      certificadoEnergetico: 'B',
      gastosComunidad: 80,
      ibiAnual: 640,
      latitud: 41.3797,
      longitud: 2.1707,
    }
  });

  console.log('âœ… Edificios creados (3)');

  // ==========================================
  // UNIDADES
  // ==========================================
  const units = await Promise.all([
    // Unidades tradicionales
    prisma.unit.create({
      data: {
        buildingId: building1.id,
        numero: '3A',
        tipo: 'vivienda',
        superficie: 85,
        habitaciones: 3,
        banos: 2,
        rentaMensual: 1200,
        estado: 'ocupada',
      }
    }),
    prisma.unit.create({
      data: {
        buildingId: building1.id,
        numero: '5B',
        tipo: 'vivienda',
        superficie: 95,
        habitaciones: 3,
        banos: 2,
        rentaMensual: 1350,
        estado: 'disponible',
      }
    }),
    // Unidad coliving con habitaciones
    prisma.unit.create({
      data: {
        buildingId: building2.id,
        numero: 'Loft 2',
        tipo: 'vivienda',
        superficie: 200,
        habitaciones: 5,
        banos: 3,
        rentaMensual: 2500,
        estado: 'ocupada',
      }
    }),
    // Unidades STR
    prisma.unit.create({
      data: {
        buildingId: building3.id,
        numero: 'Studio 1',
        tipo: 'vivienda',
        superficie: 45,
        habitaciones: 1,
        banos: 1,
        rentaMensual: 80,
        estado: 'disponible',
      }
    }),
    prisma.unit.create({
      data: {
        buildingId: building3.id,
        numero: 'Penthouse',
        tipo: 'vivienda',
        superficie: 120,
        habitaciones: 2,
        banos: 2,
        rentaMensual: 150,
        estado: 'ocupada',
      }
    }),
  ]);

  console.log('âœ… Unidades creadas (5)');

  // ==========================================
  // HABITACIONES (para Coliving)
  // ==========================================
  const colivingUnit = units[2];
  const rooms = await Promise.all([
    prisma.room.create({
      data: {
        companyId: company.id,
        unitId: colivingUnit.id,
        numero: 'R1',
        nombre: 'HabitaciÃ³n Premium',
        tipoHabitacion: 'individual',
        superficie: 25,
        precioPorMes: 650,
        precioPorSemana: 170,
        estado: 'ocupada',
        bajoPrivado: true,
        balcon: true,
        amueblada: true,
        escritorio: true,
        armarioEmpotrado: true,
        cama: 'doble',
      }
    }),
    prisma.room.create({
      data: {
        companyId: company.id,
        unitId: colivingUnit.id,
        numero: 'R2',
        nombre: 'HabitaciÃ³n EstÃ¡ndar',
        tipoHabitacion: 'individual',
        superficie: 18,
        precioPorMes: 500,
        precioPorSemana: 130,
        estado: 'ocupada',
        bajoPrivado: false,
        amueblada: true,
        escritorio: true,
        armarioEmpotrado: true,
        cama: 'individual',
      }
    }),
    prisma.room.create({
      data: {
        companyId: company.id,
        unitId: colivingUnit.id,
        numero: 'R3',
        nombre: 'HabitaciÃ³n Vista Ciudad',
        tipoHabitacion: 'individual',
        superficie: 22,
        precioPorMes: 580,
        precioPorSemana: 150,
        estado: 'disponible',
        bajoPrivado: false,
        balcon: true,
        amueblada: true,
        escritorio: true,
        armarioEmpotrado: true,
        cama: 'doble',
      }
    }),
  ]);

  console.log('âœ… Habitaciones creadas (3)');

  // ==========================================
  // INQUILINOS
  // ==========================================
  const tenants = await Promise.all([
    prisma.tenant.create({
      data: {
        companyId: company.id,
        nombre: 'MarÃ­a GarcÃ­a',
        apellidos: 'LÃ³pez',
        email: 'maria.garcia@example.com',
        telefono: '+34 654 321 098',
        dni: '12345678A',
        fechaNacimiento: new Date('1990-05-15'),
        nacionalidad: 'EspaÃ±ola',
        profesion: 'Ingeniera de Software',
        empresaActual: 'Tech Solutions SL',
        ingresosMensuales: 3500,
        estadoCivil: 'soltera',
      }
    }),
    prisma.tenant.create({
      data: {
        companyId: company.id,
        nombre: 'Carlos MartÃ­nez',
        apellidos: 'SÃ¡nchez',
        email: 'carlos.martinez@example.com',
        telefono: '+34 678 901 234',
        dni: '87654321B',
        fechaNacimiento: new Date('1988-08-22'),
        nacionalidad: 'EspaÃ±ola',
        profesion: 'DiseÃ±ador GrÃ¡fico',
        empresaActual: 'Freelance',
        ingresosMensuales: 2800,
        estadoCivil: 'casado',
      }
    }),
    prisma.tenant.create({
      data: {
        companyId: company.id,
        nombre: 'Ana RodrÃ­guez',
        apellidos: 'FernÃ¡ndez',
        email: 'ana.rodriguez@example.com',
        telefono: '+34 612 345 678',
        dni: '11223344C',
        fechaNacimiento: new Date('1995-03-10'),
        nacionalidad: 'EspaÃ±ola',
        profesion: 'Estudiante MÃ¡ster',
        empresaActual: 'Universidad Complutense',
        ingresosMensuales: 1200,
        estadoCivil: 'soltera',
      }
    }),
    prisma.tenant.create({
      data: {
        companyId: company.id,
        nombre: 'David Chen',
        apellidos: 'Wang',
        email: 'david.chen@example.com',
        telefono: '+34 645 789 012',
        dni: '55667788D',
        fechaNacimiento: new Date('1992-11-28'),
        nacionalidad: 'China',
        profesion: 'Consultor',
        empresaActual: 'McKinsey & Company',
        ingresosMensuales: 4200,
        estadoCivil: 'soltero',
      }
    }),
  ]);

  console.log('âœ… Inquilinos creados (4)');

  // ==========================================
  // CONTRATOS
  // ==========================================
  const contracts = await Promise.all([
    // Contrato tradicional
    prisma.contract.create({
      data: {
        companyId: company.id,
        unitId: units[0].id,
        tenantId: tenants[0].id,
        fechaInicio: subMonths(new Date(), 6),
        fechaFin: addMonths(new Date(), 6),
        rentaMensual: 1200,
        deposito: 2400,
        diaPago: 1,
        estado: 'activo',
        tipo: 'residencial',
      }
    }),
    // Otro contrato tradicional
    prisma.contract.create({
      data: {
        companyId: company.id,
        unitId: units[4].id,
        tenantId: tenants[3].id,
        fechaInicio: subMonths(new Date(), 3),
        fechaFin: addMonths(new Date(), 9),
        rentaMensual: 1350,
        deposito: 2700,
        diaPago: 5,
        estado: 'activo',
        tipo: 'residencial',
      }
    }),
  ]);

  console.log('âœ… Contratos creados (2)');

  // ==========================================
  // CONTRATOS DE HABITACIONES (Coliving)
  // ==========================================
  const roomContracts = await Promise.all([
    prisma.roomContract.create({
      data: {
        companyId: company.id,
        roomId: rooms[0].id,
        tenantId: tenants[1].id,
        fechaInicio: subMonths(new Date(), 4),
        fechaFin: addMonths(new Date(), 8),
        rentaMensual: 650,
        deposito: 650,
        diaPago: 1,
        estado: 'activo',
        gastosIncluidos: true,
        normasConvivencia: '# Normas de Convivencia\n\n1. Respeto mutuo\n2. Limpieza comÃºn\n3. Silencio nocturno 23:00-07:00'
      }
    }),
    prisma.roomContract.create({
      data: {
        companyId: company.id,
        roomId: rooms[1].id,
        tenantId: tenants[2].id,
        fechaInicio: subMonths(new Date(), 2),
        fechaFin: addMonths(new Date(), 10),
        rentaMensual: 500,
        deposito: 500,
        diaPago: 1,
        estado: 'activo',
        gastosIncluidos: true,
        normasConvivencia: '# Normas de Convivencia\n\n1. Respeto mutuo\n2. Limpieza comÃºn\n3. Silencio nocturno 23:00-07:00'
      }
    }),
  ]);

  console.log('âœ… Contratos de habitaciones creados (2)');

  // ==========================================
  // PAGOS
  // ==========================================
  const payments = await Promise.all([
    // Pago realizado
    prisma.payment.create({
      data: {
        companyId: company.id,
        contractId: contracts[0].id,
        monto: 1200,
        concepto: 'Renta Noviembre 2025',
        fechaVencimiento: subDays(new Date(), 5),
        fechaPago: subDays(new Date(), 2),
        estado: 'pagado',
        metodoPago: 'transferencia',
      }
    }),
    // Pago pendiente
    prisma.payment.create({
      data: {
        companyId: company.id,
        contractId: contracts[0].id,
        monto: 1200,
        concepto: 'Renta Diciembre 2025',
        fechaVencimiento: addDays(new Date(), 2),
        estado: 'pendiente',
      }
    }),
    // Pago vencido
    prisma.payment.create({
      data: {
        companyId: company.id,
        contractId: contracts[1].id,
        monto: 1350,
        concepto: 'Renta Noviembre 2025',
        fechaVencimiento: subDays(new Date(), 10),
        estado: 'pendiente',
      }
    }),
  ]);

  console.log('âœ… Pagos creados (3)');

  // ==========================================
  // PROVEEDORES
  // ==========================================
  const providers = await Promise.all([
    prisma.provider.create({
      data: {
        companyId: company.id,
        nombre: 'FontanerÃ­a MartÃ­nez',
        tipo: 'fontaneria',
        contacto: 'Juan MartÃ­nez',
        email: 'juan@fontaneria-martinez.es',
        telefono: '+34 678 123 456',
        valoracion: 4.8,
        numeroTrabajos: 45,
        activo: true,
      }
    }),
    prisma.provider.create({
      data: {
        companyId: company.id,
        nombre: 'Electricidad GarcÃ­a',
        tipo: 'electricidad',
        contacto: 'Pedro GarcÃ­a',
        email: 'pedro@electricidad-garcia.es',
        telefono: '+34 612 987 654',
        valoracion: 4.9,
        numeroTrabajos: 78,
        activo: true,
      }
    }),
  ]);

  console.log('âœ… Proveedores creados (2)');

  // ==========================================
  // SOLICITUDES DE MANTENIMIENTO
  // ==========================================
  await Promise.all([
    prisma.maintenanceRequest.create({
      data: {
        companyId: company.id,
        buildingId: building1.id,
        unitId: units[0].id,
        titulo: 'Fuga de agua en baÃ±o principal',
        prioridad: 'alta',
        estado: 'pendiente',
        categoriaMantenimiento: 'fontaneria',
        reportadoPor: tenants[0].id,
      }
    }),
    prisma.maintenanceRequest.create({
      data: {
        companyId: company.id,
        buildingId: building2.id,
        titulo: 'RevisiÃ³n ascensor',
        prioridad: 'media',
        estado: 'en_progreso',
        categoriaMantenimiento: 'otros',
        asignadoA: providers[1].id,
      }
    }),
  ]);

  console.log('âœ… Solicitudes de mantenimiento creadas (2)');

  // ==========================================
  // NOTIFICACIONES
  // ==========================================
  await Promise.all([
    prisma.notification.create({
      data: {
        companyId: company.id,
        userId: admin.id,
        tipo: 'payment_reminder',
        titulo: 'Pago pendiente',
        mensaje: 'Tienes 1 pago vencido que requiere atenciÃ³n',
        prioridad: 'alta',
        leido: false,
        entityType: 'payment',
        entityId: payments[2].id,
      }
    }),
    prisma.notification.create({
      data: {
        companyId: company.id,
        userId: admin.id,
        tipo: 'maintenance_assigned',
        titulo: 'Nueva solicitud de mantenimiento',
        mensaje: 'Se ha reportado una fuga de agua en Torre Vista Hermosa 3A',
        prioridad: 'media',
        leido: false,
        entityType: 'maintenance',
      }
    }),
  ]);

  console.log('âœ… Notificaciones creadas (2)');

  // ==========================================
  // RESUMEN FINAL
  // ==========================================
  console.log('\nðŸŽ‰ SEED COMPLETADO EXITOSAMENTE!\n');
  console.log('==========================================')
  console.log('ðŸ“Š RESUMEN DE BASE DE DATOS');
  console.log('==========================================')
  console.log('ðŸ‘¤ Usuarios: 2 (admin, gestor)');
  console.log('ðŸ¢ Edificios: 3');
  console.log('ðŸ  Unidades: 5 (tradicional + coliving + STR)');
  console.log('ðŸ›ï¸ Habitaciones: 3 (coliving)');
  console.log('ðŸ‘¥ Inquilinos: 4');
  console.log('ðŸ“„ Contratos: 2 tradicionales + 2 por habitaciÃ³n');
  console.log('ðŸ’³ Pagos: 3 (1 pagado, 1 pendiente, 1 vencido)');
  console.log('ðŸ”§ Proveedores: 2');
  console.log('ðŸ› ï¸ Mantenimiento: 2 solicitudes');
  console.log('ðŸ”” Notificaciones: 2');
  console.log('==========================================')
  console.log('\nðŸ” CREDENCIALES:');
  console.log('ðŸ“§ Admin: admin@inmova.es / admin123');
  console.log('ðŸ“§ Gestor: gestor@inmova.es / admin123');
  console.log('==========================================')
  console.log('\nðŸŒ Acceder en: https://homming-vidaro-6q1wdi.abacusai.app');
  console.log('==========================================\n');
}

main()
  .catch((e) => {
    console.error('âŒ Error al poblar la base de datos:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });

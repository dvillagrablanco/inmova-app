#!/bin/bash
# Script de AnÃ¡lisis de Bundle Size
# OptimizaciÃ³n Sprint 3

set -e

echo "======================================================================="
echo "ðŸ“Š ANÃLISIS DE BUNDLE SIZE - INMOVA APP"
echo "======================================================================="

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ============================================================================
# PASO 1: Build con anÃ¡lisis
# ============================================================================

echo ""
echo "ðŸ—ï¸ Building con anÃ¡lisis de bundle..."

# Instalar herramientas si no existen
if ! command -v next &> /dev/null; then
    echo "âŒ Next.js no encontrado. Instala dependencias primero: npm install"
    exit 1
fi

# Build
ANALYZE=true npm run build

# ============================================================================
# PASO 2: Analizar tamaÃ±os
# ============================================================================

echo ""
echo "ðŸ“¦ Analizando tamaÃ±os de archivos..."

# Buscar .next/static
if [ -d ".next/static" ]; then
    echo ""
    echo "=== JavaScript Bundles ==="
    find .next/static/chunks -name "*.js" -type f -exec du -h {} + | sort -rh | head -20
    
    echo ""
    echo "=== CSS Files ==="
    find .next/static/css -name "*.css" -type f -exec du -h {} + | sort -rh 2>/dev/null || echo "No CSS files found"
    
    echo ""
    echo "=== Total Size por Directorio ==="
    du -sh .next/static/*
    
    echo ""
    echo "=== TamaÃ±o Total de .next ==="
    du -sh .next
else
    echo "âŒ Directorio .next no encontrado. Build fallÃ³?"
    exit 1
fi

# ============================================================================
# PASO 3: Verificar lÃ­mites
# ============================================================================

echo ""
echo "âš ï¸ VERIFICANDO LÃMITES RECOMENDADOS"
echo "======================================================================="

# Obtener tamaÃ±o de First Load JS (del build output)
FIRST_LOAD=$(grep -oP "First Load JS.*\K[0-9.]+ [kM]B" .next/build-manifest.json 2>/dev/null || echo "N/A")

# Umbrales recomendados
echo "Umbrales Recomendados:"
echo "  - First Load JS: < 200 kB (ideal)"
echo "  - Individual chunk: < 244 kB (lÃ­mite Vercel)"
echo "  - Total bundle: < 5 MB"

echo ""
echo "TamaÃ±os Actuales:"
echo "  - First Load JS: $FIRST_LOAD"

# Verificar chunks grandes
echo ""
echo "ðŸ” Chunks > 200 kB (revisar):"
find .next/static/chunks -name "*.js" -type f -size +200k -exec du -h {} \; 2>/dev/null || echo "  âœ… Ninguno"

# ============================================================================
# PASO 4: Recomendaciones
# ============================================================================

echo ""
echo "ðŸ’¡ RECOMENDACIONES DE OPTIMIZACIÃ“N"
echo "======================================================================="

# Buscar dependencias pesadas en node_modules
if command -v ncdu &> /dev/null; then
    echo "Top 10 dependencias mÃ¡s pesadas:"
    du -sh node_modules/* | sort -rh | head -10
else
    echo "Instala 'ncdu' para anÃ¡lisis detallado de node_modules: brew install ncdu"
fi

echo ""
echo "Acciones recomendadas:"
echo "  1. Revisar imports de librerÃ­as pesadas (lucide-react, recharts)"
echo "  2. Lazy load componentes pesados con dynamic()"
echo "  3. Verificar que tree-shaking funcione correctamente"
echo "  4. Considerar code splitting adicional"
echo "  5. Analizar con @next/bundle-analyzer: ANALYZE=true npm run build"

# ============================================================================
# PASO 5: Generar reporte
# ============================================================================

echo ""
echo "ðŸ“„ Generando reporte..."

cat > bundle-analysis-report.txt << EOF
BUNDLE ANALYSIS REPORT - $(date)
=================================

First Load JS: $FIRST_LOAD

TOP 20 LARGEST FILES:
$(find .next/static/chunks -name "*.js" -type f -exec du -h {} + | sort -rh | head -20)

TOTAL SIZES:
$(du -sh .next/static/*)

RECOMMENDATIONS:
- Review heavy dependencies
- Implement lazy loading for heavy components
- Verify tree-shaking is working
- Consider additional code splitting

Generated by: scripts/analyze-bundle.sh
EOF

echo "âœ… Reporte guardado en: bundle-analysis-report.txt"

echo ""
echo "======================================================================="
echo "âœ… ANÃLISIS COMPLETADO"
echo "======================================================================="

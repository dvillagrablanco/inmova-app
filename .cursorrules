# üèóÔ∏è REGLAS DE ARQUITECTURA - INMOVA APP

---

## üéØ ROL

Eres un **Arquitecto de Software Senior especializado en Next.js 15, React 19, TypeScript y Vercel Serverless**.

Tu misi√≥n es:
- Escribir c√≥digo de producci√≥n robusto, escalable y mantenible.
- Optimizar para **Vercel Serverless** (Edge Functions, timeouts, cold starts).
- Seguir las mejores pr√°cticas de **Next.js App Router**.
- Garantizar **seguridad, rendimiento y experiencia de usuario**.

---

## üìö STACK TECNOL√ìGICO DETECTADO

### Core Framework
- **Next.js**: 15.5.9 (App Router, Server Components, Server Actions)
- **React**: 19.2.3
- **TypeScript**: 5.2.2 (modo permisivo: `strict: false`)
- **Node.js**: >= 18.0.0

### UI & Styling
- **Shadcn/ui**: Componentes basados en Radix UI
- **Radix UI**: Primitivos accesibles (@radix-ui/react-*)
- **Tailwind CSS**: 3.3.3 + tailwindcss-animate
- **Iconos**: lucide-react 0.446.0
- **Animaciones**: Framer Motion 12.23.25
- **Utilidades CSS**: class-variance-authority, tailwind-merge, clsx

### Database & ORM
- **ORM**: Prisma 6.7.0
- **Base de Datos**: PostgreSQL
- **Adaptador Auth**: @next-auth/prisma-adapter

### Autenticaci√≥n & Seguridad
- **NextAuth.js**: 4.24.11 (configurado en `lib/auth-options.ts`)
- **Encriptaci√≥n**: bcryptjs
- **2FA**: speakeasy, otpauth
- **Rate Limiting**: @upstash/ratelimit + rate-limiter-flexible
- **Validaci√≥n**: Zod 3.23.8, Yup 1.3.0
- **Sanitizaci√≥n**: isomorphic-dompurify

### State Management
- **Server State**: @tanstack/react-query 5.0.0
- **Client State**: Zustand 5.0.3, Jotai 2.6.0
- **Forms**: React Hook Form 7.53.0 + @hookform/resolvers

### Integraciones & Servicios
- **Pagos**: Stripe (stripe, @stripe/stripe-js, @stripe/react-stripe-js)
- **Email**: Nodemailer 7.0.11
- **SMS**: Twilio 5.10.7
- **Storage**: AWS S3 (@aws-sdk/client-s3, @aws-sdk/s3-request-presigner)
- **Cache/Queue**: BullMQ 5.65.1, ioredis 5.8.2, @upstash/redis
- **Monitoring**: @sentry/nextjs 10.32.1
- **AI**: @anthropic-ai/sdk 0.71.2
- **Push Notifications**: web-push
- **Maps**: mapbox-gl

### Testing
- **Unit Tests**: Vitest 4.0.15 + @vitest/ui
- **Integration Tests**: Jest 30.2.0 + Testing Library
- **E2E Tests**: Playwright 1.57.0
- **Accessibility**: @axe-core/cli, pa11y

### Herramientas de Desarrollo
- **Linting**: ESLint 9.24.0 + @typescript-eslint
- **Formatting**: Prettier 3.7.4
- **Pre-commit**: Husky 9.1.7 + lint-staged
- **Build Analysis**: @next/bundle-analyzer
- **Logging**: winston 3.18.3

---

## ‚ö° REGLAS CR√çTICAS DE INFRAESTRUCTURA VERCEL

### üö® REGLA #1: TIMEOUTS SERVERLESS (CR√çTICO)

**PROBLEMA**: Las funciones serverless de Vercel tienen l√≠mites estrictos:
- **Free/Hobby**: 10 segundos
- **Pro**: 60 segundos (configurado en `vercel.json`)
- **Enterprise**: 900 segundos

**SOLUCI√ìN OBLIGATORIA**:

‚úÖ **Para tareas r√°pidas (< 10s)**:
```typescript
// ‚úÖ CORRECTO: API Route simple
export async function GET() {
  const data = await prisma.user.findMany({ take: 100 });
  return NextResponse.json(data);
}
```

‚ùå **Para tareas largas (> 10s) - NUNCA HACER**:
```typescript
// ‚ùå INCORRECTO: Esto fallar√° con timeout
export async function POST() {
  await processLargeDataset(); // 5 minutos
  return NextResponse.json({ success: true });
}
```

‚úÖ **SOLUCI√ìN 1: Dividir en chunks**:
```typescript
// ‚úÖ CORRECTO: Procesar en lotes
export async function POST(req: Request) {
  const { batch, page } = await req.json();
  await processBatch(batch, page); // < 10s
  return NextResponse.json({ nextPage: page + 1 });
}
```

‚úÖ **SOLUCI√ìN 2: Background Jobs con BullMQ**:
```typescript
// ‚úÖ CORRECTO: Queue para tareas largas
import { queue } from '@/lib/queues/queue-config';

export async function POST() {
  await queue.add('process-large-dataset', { userId: '...' });
  return NextResponse.json({ status: 'queued' });
}
```

‚úÖ **SOLUCI√ìN 3: Streaming Response**:
```typescript
// ‚úÖ CORRECTO: Stream de datos
export async function GET() {
  const stream = new ReadableStream({
    async start(controller) {
      for await (const chunk of dataGenerator()) {
        controller.enqueue(chunk);
      }
      controller.close();
    }
  });
  return new Response(stream);
}
```

‚úÖ **SOLUCI√ìN 4: Vercel Cron Jobs**:
```typescript
// ‚úÖ CORRECTO: Tarea programada en vercel.json
{
  "crons": [{
    "path": "/api/cron/daily-report",
    "schedule": "0 0 * * *"
  }]
}
```

### üö® REGLA #2: SISTEMA DE ARCHIVOS EF√çMERO (CR√çTICO)

**PROBLEMA**: El sistema de archivos en Vercel es **ef√≠mero y read-only** (excepto `/tmp`).

‚ùå **NUNCA HACER**:
```typescript
// ‚ùå INCORRECTO: Guardar archivos localmente
import fs from 'fs';
fs.writeFileSync('./uploads/file.pdf', data); // ¬°FALLAR√Å!
```

‚úÖ **SOLUCI√ìN 1: AWS S3 (YA CONFIGURADO)**:
```typescript
// ‚úÖ CORRECTO: Guardar en S3
import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';

const s3 = new S3Client({ region: process.env.AWS_REGION });
await s3.send(new PutObjectCommand({
  Bucket: process.env.AWS_BUCKET,
  Key: `uploads/${filename}`,
  Body: buffer,
}));
```

‚úÖ **SOLUCI√ìN 2: Base de Datos para archivos peque√±os**:
```typescript
// ‚úÖ CORRECTO: Guardar en Prisma (solo archivos peque√±os < 1MB)
await prisma.document.create({
  data: {
    name: filename,
    content: buffer, // Bytes
    mimeType: 'application/pdf',
  }
});
```

‚úÖ **SOLUCI√ìN 3: /tmp para archivos temporales**:
```typescript
// ‚úÖ CORRECTO: /tmp SOLO para procesamiento temporal
import { writeFile, unlink } from 'fs/promises';
import path from 'path';

const tmpPath = path.join('/tmp', `temp-${Date.now()}.pdf`);
await writeFile(tmpPath, buffer);
await processPDF(tmpPath); // Procesar
await unlink(tmpPath); // SIEMPRE limpiar
```

### üö® REGLA #3: OPTIMIZACI√ìN DE COLD STARTS

**PROBLEMA**: Las funciones serverless tienen "cold starts" (arranque lento).

‚úÖ **MEJORES PR√ÅCTICAS**:

```typescript
// ‚úÖ Top-level imports (se cachean)
import { prisma } from '@/lib/db';
import { redis } from '@/lib/redis';

// ‚ùå EVITAR: Imports din√°micos innecesarios
const { prisma } = await import('@/lib/db'); // M√°s lento

// ‚úÖ Lazy loading de librer√≠as pesadas
const pdf = await import('jspdf'); // Solo cuando se necesita

// ‚úÖ Singleton de conexiones
// Ya implementado en lib/db.ts
export const prisma = globalForPrisma.prisma ?? getPrismaClient();

// ‚úÖ Minimizar dependencias en APIs cr√≠ticas
// No importar librer√≠as pesadas en rutas de autenticaci√≥n
```

### üö® REGLA #4: EDGE RUNTIME vs NODE RUNTIME

**CU√ÅNDO USAR EDGE RUNTIME** (m√°s r√°pido, pero limitado):
```typescript
// ‚úÖ EDGE: APIs simples, solo lectura, sin DB compleja
export const runtime = 'edge';

export async function GET() {
  // Solo fetch, KV stores, operaciones simples
  return NextResponse.json({ status: 'ok' });
}
```

**CU√ÅNDO USAR NODE RUNTIME** (por defecto):
```typescript
// ‚úÖ NODE: Cuando necesitas Prisma, FS, librer√≠as nativas
// No declarar runtime = usa Node por defecto

export async function POST() {
  const data = await prisma.user.create({ ... });
  return NextResponse.json(data);
}
```

### üö® REGLA #5: RATE LIMITING (YA IMPLEMENTADO)

```typescript
// ‚úÖ Usar el rate limiter configurado
import { rateLimit } from '@/lib/rate-limiting';

export async function POST(req: Request) {
  const rateLimitResult = await rateLimit(req);
  if (!rateLimitResult.success) {
    return NextResponse.json(
      { error: 'Too many requests' },
      { status: 429 }
    );
  }
  
  // Tu l√≥gica...
}
```

**Configuraci√≥n actual** (en `lib/rate-limiting.ts`):
- Auth: 500 requests / 5min
- Payment: 100 requests / min
- API: 1000 requests / min
- Admin: 5000 requests / min

---

## üé® GU√çAS DE ESTILO Y ARQUITECTURA

### 1. Estructura de Archivos

```
app/
  ‚îú‚îÄ‚îÄ (auth)/           # Rutas de autenticaci√≥n
  ‚îú‚îÄ‚îÄ (dashboard)/      # Rutas protegidas
  ‚îú‚îÄ‚îÄ api/              # API Routes
  ‚îÇ   ‚îú‚îÄ‚îÄ [resource]/
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ route.ts           # GET, POST
  ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/route.ts      # GET, PUT, DELETE
  ‚îÇ   ‚îî‚îÄ‚îÄ auth/[...nextauth]/route.ts
  ‚îú‚îÄ‚îÄ layout.tsx
  ‚îî‚îÄ‚îÄ page.tsx

components/
  ‚îú‚îÄ‚îÄ ui/               # Componentes Shadcn
  ‚îú‚îÄ‚îÄ layout/           # Header, Footer, Sidebar
  ‚îú‚îÄ‚îÄ [feature]/        # Componentes por feature
  ‚îî‚îÄ‚îÄ shared/           # Componentes reutilizables

lib/
  ‚îú‚îÄ‚îÄ [service].ts      # Servicios de negocio
  ‚îú‚îÄ‚îÄ db.ts             # Prisma Client
  ‚îú‚îÄ‚îÄ auth-options.ts   # NextAuth config
  ‚îú‚îÄ‚îÄ utils.ts          # Utilidades
  ‚îî‚îÄ‚îÄ validations/      # Schemas Zod/Yup

types/
  ‚îú‚îÄ‚îÄ [feature].d.ts    # Tipos por feature
  ‚îî‚îÄ‚îÄ prisma-types.ts   # Re-exports de Prisma
```

### 2. Convenciones de C√≥digo

#### Nombres de Archivos
- **Componentes React**: `PascalCase.tsx` ‚Üí `UserProfile.tsx`
- **API Routes**: `route.ts` (Next.js 15 App Router)
- **Utilities/Services**: `kebab-case.ts` ‚Üí `auth-service.ts`
- **Hooks**: `useCamelCase.ts` ‚Üí `useUserProfile.ts`
- **Types**: `kebab-case.d.ts` ‚Üí `user-types.d.ts`

#### Imports
```typescript
// ‚úÖ ORDEN CORRECTO DE IMPORTS:
// 1. React/Next.js
import { useState } from 'react';
import { NextRequest, NextResponse } from 'next/server';

// 2. Librer√≠as externas
import { z } from 'zod';
import { toast } from 'sonner';

// 3. Alias internos (@/)
import { prisma } from '@/lib/db';
import { Button } from '@/components/ui/button';

// 4. Relativos (si es necesario)
import { helper } from './utils';

// 5. Types (al final)
import type { User } from '@/types/prisma-types';
```

### 3. Patrones de Componentes React

#### Server Components (por defecto)
```typescript
// ‚úÖ app/dashboard/page.tsx
import { prisma } from '@/lib/db';

export default async function DashboardPage() {
  // Fetch directo en Server Component
  const users = await prisma.user.findMany();
  
  return <div>{/* Renderizar */}</div>;
}
```

#### Client Components (cuando sea necesario)
```typescript
// ‚úÖ components/UserForm.tsx
'use client'; // Obligatorio para hooks, eventos, state

import { useState } from 'react';
import { useForm } from 'react-hook-form';

export function UserForm() {
  const [loading, setLoading] = useState(false);
  const form = useForm();
  
  return <form>{/* Form */}</form>;
}
```

#### Optimizaci√≥n con Dynamic Imports
```typescript
// ‚úÖ app/admin/page.tsx
import dynamic from 'next/dynamic';

// Lazy load de componentes pesados
const AdminChart = dynamic(() => import('@/components/AdminChart'), {
  loading: () => <p>Cargando gr√°fico...</p>,
  ssr: false, // No renderizar en servidor
});
```

### 4. API Routes Pattern

```typescript
// ‚úÖ app/api/users/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth-options';
import { prisma } from '@/lib/db';
import { z } from 'zod';

// CR√çTICO: Marcar como din√°mico
export const dynamic = 'force-dynamic';

// Schema de validaci√≥n
const createUserSchema = z.object({
  email: z.string().email(),
  name: z.string().min(2),
});

export async function GET(request: NextRequest) {
  try {
    // 1. Autenticaci√≥n
    const session = await getServerSession(authOptions);
    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    // 2. Rate limiting (si aplica)
    // const rateLimitResult = await rateLimit(request);

    // 3. L√≥gica de negocio
    const users = await prisma.user.findMany({
      where: { companyId: session.user.companyId },
      take: 100,
    });

    // 4. Respuesta
    return NextResponse.json({ users });
  } catch (error: any) {
    console.error('[API Error]:', error);
    return NextResponse.json(
      { error: 'Error interno del servidor' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    // Validaci√≥n
    const body = await request.json();
    const validatedData = createUserSchema.parse(body);

    // L√≥gica
    const user = await prisma.user.create({
      data: {
        ...validatedData,
        companyId: session.user.companyId,
      },
    });

    return NextResponse.json(user, { status: 201 });
  } catch (error: any) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Datos inv√°lidos', details: error.errors },
        { status: 400 }
      );
    }
    
    console.error('[API Error]:', error);
    return NextResponse.json(
      { error: 'Error interno del servidor' },
      { status: 500 }
    );
  }
}
```

### 5. Server Actions Pattern

```typescript
// ‚úÖ app/actions/user-actions.ts
'use server';

import { revalidatePath } from 'next/cache';
import { prisma } from '@/lib/db';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth-options';

export async function createUser(formData: FormData) {
  // Autenticaci√≥n
  const session = await getServerSession(authOptions);
  if (!session) {
    throw new Error('No autenticado');
  }

  // Validaci√≥n
  const email = formData.get('email') as string;
  const name = formData.get('name') as string;

  if (!email || !name) {
    throw new Error('Campos requeridos');
  }

  // L√≥gica
  const user = await prisma.user.create({
    data: { email, name, companyId: session.user.companyId },
  });

  // Revalidar cache
  revalidatePath('/dashboard/users');

  return user;
}
```

### 6. Manejo de Errores

```typescript
// ‚úÖ components/ErrorBoundary.tsx (ya existe)
'use client';

import { useEffect } from 'react';

export default function ErrorBoundary({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    // Log a Sentry
    console.error('Error capturado:', error);
  }, [error]);

  return (
    <div>
      <h2>Algo sali√≥ mal</h2>
      <button onClick={reset}>Reintentar</button>
    </div>
  );
}
```

### 7. Prisma Best Practices

```typescript
// ‚úÖ SIEMPRE usar tipos importados de @/types/prisma-types
// NO importar directamente de @prisma/client en APIs
import type { User, UserRole } from '@/types/prisma-types';

// ‚úÖ Usar transacciones para operaciones m√∫ltiples
await prisma.$transaction(async (tx) => {
  const user = await tx.user.create({ ... });
  await tx.auditLog.create({ ... });
});

// ‚úÖ Usar select para optimizar queries
const users = await prisma.user.findMany({
  select: {
    id: true,
    email: true,
    name: true,
    // No traer password u otros campos sensibles
  },
});

// ‚úÖ Implementar paginaci√≥n
const users = await prisma.user.findMany({
  skip: (page - 1) * limit,
  take: limit,
  orderBy: { createdAt: 'desc' },
});
```

### 8. TypeScript Guidelines

```typescript
// ‚úÖ Usar tipos expl√≠citos en funciones p√∫blicas
export async function getUser(id: string): Promise<User | null> {
  return await prisma.user.findUnique({ where: { id } });
}

// ‚úÖ Usar Zod para validaci√≥n runtime + tipos
const userSchema = z.object({
  email: z.string().email(),
  name: z.string(),
});

type UserInput = z.infer<typeof userSchema>; // Tipo inferido

// ‚úÖ Usar type guards
function isAdmin(user: User): user is User & { role: 'ADMIN' } {
  return user.role === 'ADMIN';
}

// ‚úÖ Usar utility types de TypeScript
type PartialUser = Partial<User>;
type RequiredUser = Required<User>;
type UserWithoutPassword = Omit<User, 'password'>;
```

### 9. Accesibilidad (a11y)

```typescript
// ‚úÖ Shadcn ya incluye accesibilidad, pero verifica:
<Button
  aria-label="Cerrar modal"
  aria-pressed={isActive}
  disabled={loading}
>
  Acci√≥n
</Button>

// ‚úÖ Usar semantic HTML
<main>
  <article>
    <header>
      <h1>T√≠tulo</h1>
    </header>
    <section>
      <p>Contenido</p>
    </section>
  </article>
</main>

// ‚úÖ Focus management
<Dialog>
  <DialogTrigger asChild>
    <Button>Abrir</Button>
  </DialogTrigger>
  <DialogContent> {/* Radix maneja focus autom√°ticamente */}
    <DialogTitle>T√≠tulo</DialogTitle>
  </DialogContent>
</Dialog>
```

### 10. Performance & SEO

```typescript
// ‚úÖ Metadata en Server Components
import { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Dashboard | Inmova',
  description: 'Panel de control',
};

// ‚úÖ Loading states
// app/dashboard/loading.tsx
export default function Loading() {
  return <Skeleton />;
}

// ‚úÖ Suspense para streaming
import { Suspense } from 'react';

export default function Page() {
  return (
    <Suspense fallback={<Loading />}>
      <HeavyComponent />
    </Suspense>
  );
}

// ‚úÖ Imagen optimizada
import Image from 'next/image';

<Image
  src="/logo.png"
  alt="Logo de Inmova"
  width={200}
  height={100}
  priority // Para above-the-fold
/>
```

---

## üîê SEGURIDAD

### 1. Autenticaci√≥n
- **SIEMPRE** verificar sesi√≥n en Server Components y API Routes
- **NUNCA** confiar en datos del cliente sin validaci√≥n
- **USAR** `getServerSession(authOptions)` (ya configurado)

### 2. Validaci√≥n de Entrada
- **SIEMPRE** validar con Zod antes de usar datos
- **SANITIZAR** HTML con DOMPurify (isomorphic-dompurify)
- **PREVENIR** SQL Injection (Prisma lo hace autom√°ticamente)

### 3. Variables de Entorno
```typescript
// ‚úÖ Acceder solo en server-side
const apiKey = process.env.API_KEY;

// ‚úÖ Para cliente, usar prefijo NEXT_PUBLIC_
const publicKey = process.env.NEXT_PUBLIC_STRIPE_KEY;
```

### 4. CORS y Headers (ya configurado en vercel.json)
```json
{
  "headers": [
    {
      "key": "X-Content-Type-Options",
      "value": "nosniff"
    },
    {
      "key": "X-Frame-Options",
      "value": "DENY"
    }
  ]
}
```

---

## üìä MONITORING & LOGGING

```typescript
// ‚úÖ Logging estructurado (winston ya configurado)
import logger from '@/lib/logger';

logger.info('Usuario creado', { userId: user.id });
logger.error('Error en payment', { error: e.message });

// ‚úÖ Sentry para errores (ya configurado)
import * as Sentry from '@sentry/nextjs';

Sentry.captureException(error, {
  extra: { userId: session.user.id },
});
```

---

## ‚úÖ CHECKLIST DE C√ìDIGO

Antes de cada commit, verifica:

- [ ] ¬øAPI Routes marcadas con `export const dynamic = 'force-dynamic'`?
- [ ] ¬øNo hay operaciones que excedan 60 segundos?
- [ ] ¬øNo estoy guardando archivos en el filesystem (excepto `/tmp` temporal)?
- [ ] ¬øValid√© inputs con Zod/Yup?
- [ ] ¬øVerifiqu√© autenticaci√≥n con `getServerSession`?
- [ ] ¬øUs√© tipos de `@/types/prisma-types` en lugar de `@prisma/client`?
- [ ] ¬øOptimic√© imports (no importar librer√≠as pesadas innecesariamente)?
- [ ] ¬øAgregu√© logging para debugging?
- [ ] ¬øManej√© errores con try/catch?
- [ ] ¬øRetorn√© c√≥digos HTTP apropiados (200, 201, 400, 401, 500)?

---

## üöÄ COMANDOS √öTILES

```bash
# Desarrollo
yarn dev

# Build local (tarda por Prisma, preferir deploy en Vercel)
yarn build

# Testing
yarn test:unit        # Vitest
yarn test:e2e         # Playwright
yarn test:e2e:ui      # Playwright UI

# Database
yarn prisma studio    # UI para DB
yarn prisma migrate dev
yarn db:backup        # Backup script

# Linting y formato
yarn lint:fix
yarn format

# An√°lisis
yarn analyze          # Bundle size
```

---

## üéì RECURSOS Y DOCUMENTACI√ìN

- **Next.js 15**: https://nextjs.org/docs
- **Prisma**: https://www.prisma.io/docs
- **Shadcn/ui**: https://ui.shadcn.com
- **Vercel Limits**: https://vercel.com/docs/limits
- **React Query**: https://tanstack.com/query/latest
- **Zod**: https://zod.dev

---

## üí° FILOSOF√çA DE DESARROLLO

1. **Simplicidad sobre complejidad**: C√≥digo claro > C√≥digo "inteligente"
2. **Serverless First**: Dise√±ar para funciones ef√≠meras y stateless
3. **Type Safety**: TypeScript + Zod para prevenir errores en runtime
4. **Performance**: Lazy loading, caching, optimizaci√≥n de queries
5. **DX (Developer Experience)**: C√≥digo auto-documentado y f√°cil de mantener
6. **Seguridad**: Nunca confiar en inputs del cliente
7. **Monitoreo**: Logging y error tracking desde el d√≠a 1

---

**√öltima actualizaci√≥n**: 29 de diciembre de 2025
**Versi√≥n**: 1.0.0
**Mantenido por**: Equipo Inmova

generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/homming_vidaro/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum UserRole {
  super_admin
  administrador
  gestor
  operador
  soporte
  community_manager
}

enum BusinessVertical {
  alquiler_tradicional
  str_vacacional
  coliving
  construccion
  flipping
  servicios_profesionales
  mixto
}

enum CompanyCategory {
  enterprise
  pyme
  startup
  trial
  premium
  standard
}

enum SuggestionStatus {
  pendiente
  en_revision
  resuelta
  rechazada
}

enum SuggestionPriority {
  baja
  media
  alta
  critica
}

enum BuildingType {
  residencial
  mixto
  comercial
}

enum UnitType {
  vivienda
  local
  garaje
  trastero
}

enum UnitStatus {
  ocupada
  disponible
  en_mantenimiento
}

enum ContractStatus {
  activo
  vencido
  cancelado
}

enum ContractType {
  residencial
  comercial
  temporal
}

enum PaymentStatus {
  pendiente
  pagado
  atrasado
}

enum RiskLevel {
  bajo
  medio
  alto
  critico
}

enum MaintenancePriority {
  alta
  media
  baja
}

enum MaintenanceStatus {
  pendiente
  en_progreso
  programado
  completado
}

enum DocumentType {
  contrato
  dni
  nomina
  certificado_energetico
  ite
  seguro
  factura
  otro
}

enum ExpenseCategory {
  mantenimiento
  impuestos
  seguros
  servicios
  reparaciones
  comunidad
  otro
}

enum RoomStatus {
  disponible
  ocupada
  mantenimiento
  reservada
}

enum RoomContractStatus {
  activo
  vencido
  cancelado
  pendiente
}

enum RoomPaymentMethod {
  transferencia
  efectivo
  tarjeta
  domiciliacion
}

enum NotificationType {
  pago_atrasado
  contrato_vencimiento
  mantenimiento_urgente
  mantenimiento_preventivo
  documento_vencer
  unidad_vacante
  inspeccion_programada
  alerta_sistema
  info
}

enum SituacionLaboral {
  empleado
  autonomo
  estudiante
  jubilado
  desempleado
}

enum EstadoCivil {
  soltero
  casado
  divorciado
  viudo
}

enum CandidateStatus {
  nuevo
  en_revision
  preseleccionado
  aprobado
  rechazado
}

enum IncrementoType {
  porcentaje
  ipc
  fijo
}

enum MessageStatus {
  enviado
  leido
}

enum TemplateType {
  contrato
  email
  recibo
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  name             String
  password         String
  role             UserRole          @default(gestor)
  companyId        String
  activo           Boolean           @default(true)
  businessVertical BusinessVertical?
  setupProgress    String?           // JSON string con las acciones completadas del onboarding
  resetToken       String?           @unique
  resetTokenExpiry DateTime?
  
  // Multi-Factor Authentication (MFA)
  mfaEnabled       Boolean           @default(false)
  mfaSecret        String?           // Encrypted TOTP secret
  mfaBackupCodes   String[]          @default([]) // Encrypted backup codes
  mfaVerifiedAt    DateTime?
  mfaRecoveryCodes Int               @default(10) // Count of remaining codes
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  company              Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  notifications        Notification[]
  tasksAsignadas       Task[]                   @relation("TaskAssignedTo")
  tasksCreadas         Task[]                   @relation("TaskCreatedBy")
  auditLogs            AuditLog[]
  preferences          UserPreference?
  securityEvents       SecurityEvent[]
  chatbotConversations ChatbotConversation[]
  documentosCreados    DocumentoFirma[]         @relation("DocumentosCreados")
  dashboardPreference  UserDashboardPreference?
  dashboardWidgets     DashboardWidget[]
  searchHistory        SearchHistory[]
  savedSearches        SavedSearch[]

  // Nuevos Módulos Estratégicos Fase 2
  aiConversations        AIConversation[]        @relation("UserAIConversations")
  voiceInteractions      VoiceInteraction[]      @relation("UserVoiceInteractions")
  biometricVerifications BiometricVerification[] @relation("UserBiometricVerifications")
  gdprConsents           GDPRConsent[]           @relation("UserGDPRConsents")

  // Multi-empresa
  companyAccess UserCompanyAccess[]

  // Sugerencias
  suggestions Suggestion[]

  // CRM - Leads
  leadsAsignados  Lead[]
  actividadesLead LeadActivity[]
  documentosLead  LeadDocument[]

  // Push Notifications
  pushSubscriptions PushSubscription[]

  // Bank Connections
  bankConnections BankConnection[]

  // Automatización de onboarding y soporte
  onboardingProgress OnboardingProgress[]
  supportTickets     SupportTicket[]

  // Portal Inquilino - Mejoras Críticas
  tenantInvitations TenantInvitation[]

  // Sistema de Automatizaciones Inteligentes
  automations Automation[]

  // Sistema de Notificaciones Avanzado - Fase 2
  notificationLogs         NotificationLog[]
  userNotificationSettings UserNotificationSettings?
  
  // Soporte e interacciones de ayuda
  supportInteractions SupportInteraction[]

  @@index([email])
  @@index([companyId])
  @@index([role, companyId])
  @@index([activo])
  @@index([createdAt])
  @@map("users")
}

model Building {
  id                    String       @id @default(cuid())
  companyId             String
  nombre                String
  direccion             String
  tipo                  BuildingType
  anoConstructor        Int
  numeroUnidades        Int
  estadoConservacion    String?
  certificadoEnergetico String?
  ascensor              Boolean      @default(false)
  garaje                Boolean      @default(false)
  trastero              Boolean      @default(false)
  piscina               Boolean      @default(false)
  jardin                Boolean      @default(false)
  gastosComunidad       Float?
  ibiAnual              Float?
  latitud               Float?
  longitud              Float?
  imagenes              String[]     @default([])
  etiquetas             String[]     @default([])
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  company              Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  units                Unit[]
  expenses             Expense[]
  documents            Document[]
  maintenanceSchedules MaintenanceSchedule[]
  serviceQuotes        ServiceQuote[]
  serviceJobs          ServiceJob[]
  energyReadings       EnergyReading[]
  energyAlerts         EnergyAlert[]
  insurancePolicies    InsurancePolicy[]

  // Prioridades Medias
  valoraciones  ValoracionPropiedad[]
  publicaciones PublicacionPortal[]

  // Fase 1
  calendarEvents CalendarEvent[]

  // Fase 2
  commonSpaces CommonSpace[]
  insurances   Insurance[]

  // Fase 3
  communityIncidents     CommunityIncident[]
  communityVotes         CommunityVote[]
  communityAnnouncements CommunityAnnouncement[]
  communityMeetings      CommunityMeeting[]
  providerWorkOrders     ProviderWorkOrder[]

  // Nuevos Módulos Estratégicos
  iotDevices           IoTDevice[]           @relation("BuildingIoTDevices")
  virtualTours         VirtualTour[]         @relation("BuildingVirtualTours")
  carbonFootprints     CarbonFootprint[]     @relation("BuildingCarbonFootprints")
  decarbonizationPlans DecarbonizationPlan[] @relation("BuildingDecarbonizationPlans")
  esgCertifications    ESGCertification[]    @relation("BuildingESGCertifications")

  // Nuevos Módulos Estratégicos Fase 2
  propertyTokens  PropertyToken[]  @relation("BuildingPropertyTokens")
  nftCertificates NFTCertificate[] @relation("BuildingNFTCertificates")

  urbanGardens     UrbanGarden[]     @relation("BuildingUrbanGardens")
  recyclingMetrics RecyclingMetric[] @relation("BuildingRecyclingMetrics")

  socialPosts           SocialPost[]     @relation("BuildingSocialPosts")
  communityEventsPhase2 CommunityEvent[] @relation("BuildingCommunityEvents")
  ambassadors           Ambassador[]     @relation("BuildingAmbassadors")

  flippingProjects     FlippingProject[]     @relation
  constructionProjects ConstructionProject[] @relation

  // Portal Propietario - Asignación de Edificios
  ownerBuildings OwnerBuilding[]

  // Gestión de Comunidades
  communityMinutes     CommunityMinute[]
  communityFees        CommunityFee[]
  communityFunds       CommunityFund[]
  financialAlerts      FinancialAlert[]
  cashFlowForecasts    CashFlowForecast[]
  buildingInspections  BuildingInspection[]

  // Coliving
  colivingGroups        ColivingGroup[]
  colivingActivityPosts ColivingActivityPost[]
  colivingEvents        ColivingEvent[]
  smartLocks            SmartLock[]
  colivingPackages      ColivingPackage[]

  // Índices optimizados para consultas frecuentes
  @@index([companyId])
  @@index([tipo, companyId])
  @@index([companyId, createdAt])
  @@index([companyId, tipo, anoConstructor]) // Nuevo: búsqueda por tipo y año
  @@map("buildings")
  // Administrador de Fincas
  communityManagement CommunityManagement?
}

model Tenant {
  id                    String            @id @default(cuid())
  companyId             String
  nombreCompleto        String
  dni                   String            @unique
  email                 String            @unique
  telefono              String
  fechaNacimiento       DateTime
  nacionalidad          String?
  estadoCivil           EstadoCivil?
  numeroOcupantes       Int?
  direccionActual       String?
  situacionLaboral      SituacionLaboral?
  empresa               String?
  puesto                String?
  antiguedad            Int?
  ingresosMensuales     Float?
  ratioRentaIngresos    Float?
  scoring               Int               @default(50)
  nivelRiesgo           RiskLevel         @default(medio)
  password              String?
  notas                 String?           @db.Text
  // Integraciones de Contabilidad
  contasimpleCustomerId String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  company               Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  units                 Unit[]
  contracts             Contract[]
  documents             Document[]
  messagesReceived      Message[]             @relation("MessageRecipient")
  messagesSent          Message[]             @relation("MessageSender")
  stripeCustomer        StripeCustomer?
  documentShares        DocumentShare[]
  chatbotConversations  ChatbotConversation[]
  morosidadPredicciones MorosidadPrediccion[]
  morosidadHistorial    MorosidadHistorial[]
  documentosFirma       DocumentoFirma[]

  // Prioridades Medias
  smsLogs SMSLog[]

  // Fase 1
  calendarEvents  CalendarEvent[]
  bankConnections BankConnection[]

  // Fase 2
  spaceReservations SpaceReservation[]

  // Nuevos Módulos Estratégicos
  marketplaceBookings MarketplaceBooking[] @relation("TenantMarketplaceBookings")
  marketplaceLoyalty  MarketplaceLoyalty?  @relation("TenantMarketplaceLoyalty")

  // Nuevos Módulos Estratégicos Fase 2
  tokenHoldings TokenHolder[] @relation("TenantTokenHoldings")

  aiConversations AIConversation[] @relation("TenantAIConversations")

  circularItems CircularItem[] @relation("TenantCircularItems")
  gardenPlots   GardenPlot[]   @relation("TenantGardenPlots")

  socialPosts    SocialPost[]      @relation("TenantSocialPosts")
  socialComments SocialComment[]   @relation("TenantSocialComments")
  reputation     TenantReputation? @relation("TenantReputation")
  p2pServices    P2PService[]      @relation("TenantP2PServices")
  p2pBookings    P2PBooking[]      @relation("TenantP2PBookings")
  ambassador     Ambassador?       @relation("TenantAmbassador")

  biometricVerifications BiometricVerification[] @relation("TenantBiometricVerifications")
  gdprConsents           GDPRConsent[]           @relation("TenantGDPRConsents")

  // Room Rental Module
  roomContracts RoomContract[]

  // Portal Inquilino - Mejoras Críticas
  invitation          TenantInvitation?
  passwordResetTokens PasswordResetToken[]
  serviceRatings      ServiceRating[]
  onboarding          TenantOnboarding?

  // Coliving
  colivingProfile         ColivingProfile?
  colivingServiceBookings ColivingServiceBooking[]
  colivingCheckInOuts     ColivingCheckInOut[]
  smartLockAccesses       SmartLockAccess[]
  colivingPackages        ColivingPackage[]

  // Coliving - Analytics y Métricas Avanzadas
  npsSurveys          NPSSurvey[]
  tenantProfile       TenantProfile?
  spaceWaitlists      SpaceWaitlist[]
  reservationCredits  ReservationCredits?
  spaceRatings        SpaceRating[]

  // Community Management - Pack 1
  eventAttendances        EventAttendee[]
  eventComments           EventComment[]
  postReactions           PostReaction[]
  announcementConfirmations AnnouncementConfirmation[]

  // Índices optimizados para consultas frecuentes
  @@index([companyId])
  @@index([email])
  @@index([dni])
  @@index([companyId, scoring])
  @@index([companyId, createdAt]) // Nuevo: tenants por fecha de creación
  @@map("tenants")
}

model Unit {
  id                String     @id @default(cuid())
  numero            String
  buildingId        String
  tipo              UnitType
  estado            UnitStatus @default(disponible)
  superficie        Float
  superficieUtil    Float?
  habitaciones      Int?
  banos             Int?
  planta            Int?
  orientacion       String?
  rentaMensual      Float
  tenantId          String?
  aireAcondicionado Boolean    @default(false)
  calefaccion       Boolean    @default(false)
  terraza           Boolean    @default(false)
  balcon            Boolean    @default(false)
  amueblado         Boolean    @default(false)
  imagenes          String[]   @default([])
  tourVirtual       String?
  planos            String[]   @default([])
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  building             Building              @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  tenant               Tenant?               @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  contracts            Contract[]
  maintenanceRequests  MaintenanceRequest[]
  maintenanceSchedules MaintenanceSchedule[]
  expenses             Expense[]
  documents            Document[]
  candidates           Candidate[]
  serviceQuotes        ServiceQuote[]
  serviceJobs          ServiceJob[]
  energyReadings       EnergyReading[]
  energyAlerts         EnergyAlert[]

  // Prioridades Medias
  valoraciones  ValoracionPropiedad[]
  publicaciones PublicacionPortal[]

  // Fase 1
  calendarEvents CalendarEvent[]

  // Fase 2
  insurances         Insurance[]
  energyCertificates EnergyCertificate[]

  // Fase 3
  communityIncidents CommunityIncident[]
  providerWorkOrders ProviderWorkOrder[]
  propertyGallery    PropertyGallery?

  // Nuevos Módulos Estratégicos
  iotDevices          IoTDevice[]          @relation("UnitIoTDevices")
  virtualTours        VirtualTour[]        @relation("UnitVirtualTours")
  arVisualizations    ARVisualization[]    @relation("UnitARVisualizations")
  marketplaceBookings MarketplaceBooking[] @relation("UnitMarketplaceBookings")
  pricingAnalysis     PricingAnalysis[]    @relation("UnitPricingAnalysis")
  pricingStrategies   PricingStrategy[]    @relation("UnitPricingStrategies")

  // Nuevos Módulos Estratégicos Fase 2
  propertyTokens  PropertyToken[]  @relation("UnitPropertyTokens")
  nftCertificates NFTCertificate[] @relation("UnitNFTCertificates")

  strListings      STRListing[]      @relation
  flippingProjects FlippingProject[] @relation

  // Room Rental Module
  rooms            Room[]
  roomSharedSpaces RoomSharedSpace[]

  // Gestión de Comunidades
  communityFees              CommunityFee[]
  habitabilityCertificates   HabitabilityCertificate[]

  // Coliving
  colivingCheckInOuts ColivingCheckInOut[]
  smartLocks          SmartLock[]

  @@unique([buildingId, numero])
  // Índices optimizados para consultas frecuentes
  @@index([buildingId, estado])
  @@index([estado])
  @@index([tenantId])
  @@index([tipo, estado])
  @@index([buildingId, tipo, estado]) // Nuevo: búsqueda compuesta por edificio, tipo y estado
  @@index([rentaMensual, estado]) // Nuevo: búsqueda por rango de renta
  @@map("units")
}

model Contract {
  id                   String         @id @default(cuid())
  unitId               String
  tenantId             String
  fechaInicio          DateTime
  fechaFin             DateTime
  rentaMensual         Float
  diaPago              Int            @default(1)
  deposito             Float
  mesesFianza          Int            @default(1)
  renovacionAutomatica Boolean        @default(false)
  incrementoType       IncrementoType @default(ipc)
  incrementoValor      Float?
  gastosIncluidos      String[]       @default([])
  gastosExcluidos      String[]       @default([])
  clausulasAdicionales String?        @db.Text
  estado               ContractStatus @default(activo)
  tipo                 ContractType   @default(residencial)
  contractPdfPath      String?
  legalTemplateId      String?
  contasimpleInvoiceId String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  unit                  Unit                  @relation(fields: [unitId], references: [id], onDelete: Cascade)
  tenant                Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legalTemplate         LegalTemplate?        @relation(fields: [legalTemplateId], references: [id], onDelete: SetNull)
  payments              Payment[]
  documents             Document[]
  stripeSubscription    StripeSubscription?
  morosidadPredicciones MorosidadPrediccion[]
  documentosFirma       DocumentoFirma[]

  // Fase 1
  calendarEvents CalendarEvent[]

  // Gestión de Comunidades
  depositManagement DepositManagement?

  // Índices optimizados para consultas frecuentes
  @@index([tenantId, estado])
  @@index([unitId, estado])
  @@index([estado])
  @@index([fechaInicio, fechaFin])
  @@index([tenantId, fechaInicio])
  @@index([estado, fechaFin]) // Nuevo: contratos activos próximos a vencer
  @@index([unitId, fechaInicio, fechaFin]) // Nuevo: historial de contratos por unidad
  @@map("contracts")
}

enum StripePaymentStatus {
  pending
  processing
  succeeded
  failed
  canceled
  refunded
}

model Payment {
  id               String        @id @default(cuid())
  contractId       String
  periodo          String
  monto            Float
  fechaVencimiento DateTime
  fechaPago        DateTime?
  estado           PaymentStatus @default(pendiente)
  metodoPago       String?
  reciboPdfPath    String?
  nivelRiesgo      RiskLevel     @default(bajo)

  // Stripe integration fields
  stripePaymentIntentId String?              @unique
  stripePaymentStatus   StripePaymentStatus?
  stripeClientSecret    String?
  stripeFee             Float?
  stripeNetAmount       Float?

  contasimplePaymentId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  contract             Contract             @relation(fields: [contractId], references: [id], onDelete: Cascade)
  stripeSubscription   StripeSubscription?  @relation(fields: [stripeSubscriptionId], references: [id], onDelete: SetNull)
  stripeSubscriptionId String?
  bankTransactions     BankTransaction[]
  morosidadHistorial   MorosidadHistorial[]
  conciliacionesManual ConciliacionManual[]

  // Fase 1
  calendarEvents CalendarEvent[]

  // Gestión de Comunidades
  badDebtProvision BadDebtProvision?

  // Índices optimizados para consultas frecuentes
  @@index([contractId, estado])
  @@index([estado])
  @@index([fechaVencimiento])
  @@index([fechaPago])
  @@index([contractId, fechaVencimiento])
  @@index([estado, fechaVencimiento]) // Nuevo: pagos pendientes ordenados por fecha
  @@index([nivelRiesgo, estado]) // Nuevo: análisis de riesgo de morosidad
  @@map("payments")
}

model StripeSubscription {
  id                   String    @id @default(cuid())
  contractId           String    @unique
  stripeSubscriptionId String    @unique
  stripeCustomerId     String
  stripePriceId        String?
  status               String // active, canceled, past_due, etc.
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean   @default(false)
  canceledAt           DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  contract Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@map("stripe_subscriptions")
}

model StripeCustomer {
  id               String   @id @default(cuid())
  tenantId         String   @unique
  stripeCustomerId String   @unique
  email            String
  name             String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("stripe_customers")
}

model StripeWebhookEvent {
  id              String    @id @default(cuid())
  stripeEventId   String    @unique
  type            String
  data            String    @db.Text
  processed       Boolean   @default(false)
  processingError String?   @db.Text
  createdAt       DateTime  @default(now())
  processedAt     DateTime?

  @@index([processed, createdAt])
  @@map("stripe_webhook_events")
}

model MaintenanceRequest {
  id                 String              @id @default(cuid())
  unitId             String
  titulo             String
  descripcion        String              @db.Text
  prioridad          MaintenancePriority @default(media)
  estado             MaintenanceStatus   @default(pendiente)
  fechaSolicitud     DateTime            @default(now())
  fechaProgramada    DateTime?
  fechaCompletada    DateTime?
  providerId         String?
  costoEstimado      Float?
  costoReal          Float?
  fotosProblem       String[]            @default([])
  fotosCompletado    String[]            @default([])
  valoracion         Int?
  comentarios        String?             @db.Text
  requiereAprobacion Boolean             @default(false)
  estadoAprobacion   ApprovalStatus?     @default(pendiente)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  unit      Unit       @relation(fields: [unitId], references: [id], onDelete: Cascade)
  provider  Provider?  @relation(fields: [providerId], references: [id], onDelete: SetNull)
  approvals Approval[]

  // Fase 1
  calendarEvents CalendarEvent[]

  // Fase 3
  workOrders ProviderWorkOrder[]

  @@index([unitId])
  @@index([estado])
  @@index([prioridad])
  @@index([unitId, estado])
  @@index([estado, prioridad])
  @@index([fechaProgramada])
  @@index([createdAt])
  @@map("maintenance_requests")
}

model Provider {
  id        String  @id @default(cuid())
  companyId String
  nombre    String
  tipo      String
  telefono  String
  email     String?
  direccion String?
  rating    Float?
  notas     String? @db.Text

  // Autenticación para Portal del Proveedor
  password     String? // Hash de la contraseña
  activo       Boolean   @default(true)
  ultimoAcceso DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company              Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  maintenanceRequests  MaintenanceRequest[]
  maintenanceSchedules MaintenanceSchedule[]
  expenses             Expense[]
  serviceQuotes        ServiceQuote[]
  serviceJobs          ServiceJob[]
  serviceReviews       ServiceReview[]
  workOrders           ProviderWorkOrder[]

  // Nuevos Módulos Estratégicos
  marketplaceServices MarketplaceService[] @relation("ProviderMarketplaceServices")

  // Portal de Proveedores - Mejoras
  passwordResetTokens ProviderPasswordResetToken[]
  availability        ProviderAvailability[]
  invoices            ProviderInvoice[]
  quotes              ProviderQuote[]
  reviews             ProviderReview[]
  chatConversations   ProviderChatConversation[]

  @@map("providers")
}

enum ApprovalStatus {
  pendiente
  aprobado
  rechazado
}

model Expense {
  id                   String          @id @default(cuid())
  buildingId           String?
  unitId               String?
  providerId           String?
  concepto             String
  categoria            ExpenseCategory
  monto                Float
  fecha                DateTime
  facturaPdfPath       String?
  notas                String?         @db.Text
  requiereAprobacion   Boolean         @default(false)
  estadoAprobacion     ApprovalStatus? @default(pendiente)
  contasimpleExpenseId String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  building             Building?            @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit                 Unit?                @relation(fields: [unitId], references: [id], onDelete: Cascade)
  provider             Provider?            @relation(fields: [providerId], references: [id], onDelete: SetNull)
  approvals            Approval[]
  bankTransactions     BankTransaction[]
  conciliacionesManual ConciliacionManual[]

  @@index([buildingId])
  @@index([unitId])
  @@index([providerId])
  @@index([categoria])
  @@index([fecha])
  @@index([buildingId, categoria])
  @@index([buildingId, fecha])
  @@index([createdAt])
  @@map("expenses")
}

model Document {
  id               String       @id @default(cuid())
  nombre           String
  tipo             DocumentType
  cloudStoragePath String
  tenantId         String?
  unitId           String?
  buildingId       String?
  contractId       String?
  folderId         String?
  versionActual    Int          @default(1)
  tags             String[]     @default([])
  descripcion      String?      @db.Text
  fechaSubida      DateTime     @default(now())
  fechaVencimiento DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  tenant   Tenant?           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unit     Unit?             @relation(fields: [unitId], references: [id], onDelete: Cascade)
  building Building?         @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  contract Contract?         @relation(fields: [contractId], references: [id], onDelete: Cascade)
  folder   DocumentFolder?   @relation("FolderDocuments", fields: [folderId], references: [id], onDelete: SetNull)
  versions DocumentVersion[]
  shares   DocumentShare[]

  @@index([buildingId])
  @@index([unitId])
  @@index([tenantId])
  @@index([contractId])
  @@index([tipo])
  @@index([folderId])
  @@index([createdAt])
  @@index([fechaVencimiento])
  @@map("documents")
}

model Notification {
  id          String           @id @default(cuid())
  companyId   String
  tipo        NotificationType
  titulo      String
  mensaje     String           @db.Text
  leida       Boolean          @default(false)
  prioridad   RiskLevel        @default(bajo)
  fechaLimite DateTime?
  entityId    String?
  entityType  String?
  userId      String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([leida])
  @@index([userId, leida])
  @@index([companyId, leida])
  @@index([companyId, createdAt])
  @@index([tipo])
  @@index([createdAt])
  @@map("notifications")
}

model Candidate {
  id                String            @id @default(cuid())
  unitId            String
  nombreCompleto    String
  dni               String
  email             String
  telefono          String
  fechaNacimiento   DateTime
  situacionLaboral  SituacionLaboral?
  ingresosMensuales Float?
  scoring           Int               @default(0)
  estado            CandidateStatus   @default(nuevo)
  documentos        String[]          @default([])
  notas             String?           @db.Text
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  unit   Unit    @relation(fields: [unitId], references: [id], onDelete: Cascade)
  visits Visit[]

  // Prioridades Medias
  screening ScreeningCandidato?

  @@map("candidates")
}

model Visit {
  id          String   @id @default(cuid())
  candidateId String
  fechaVisita DateTime
  confirmada  Boolean  @default(false)
  asistio     Boolean?
  feedback    String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  // Fase 1
  calendarEvents CalendarEvent[]

  @@map("visits")
}

model Message {
  id          String        @id @default(cuid())
  senderId    String
  recipientId String
  asunto      String
  mensaje     String        @db.Text
  estado      MessageStatus @default(enviado)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  sender    Tenant @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient Tenant @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Template {
  id        String       @id @default(cuid())
  nombre    String
  tipo      TemplateType
  contenido String       @db.Text
  variables String[]     @default([])
  activo    Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("templates")
}

model Company {
  id              String  @id @default(cuid())
  nombre          String  @default("INMOVA")
  cif             String?
  direccion       String?
  telefono        String?
  email           String?
  logoUrl         String?
  codigoPostal    String?
  ciudad          String?
  pais            String  @default("España")
  iban            String?
  colorPrimario   String? @default("#000000")
  colorSecundario String? @default("#FFFFFF")
  pieDocumento    String? @db.Text
  activo          Boolean @default(true)

  // Gestión de Clientes (Multi-tenant)
  dominioPersonalizado String? @unique // ej: cliente.inmova.com
  estadoCliente        String? @default("activo") // activo, suspendido, prueba
  contactoPrincipal    String? // Nombre del contacto principal
  emailContacto        String? // Email del contacto
  telefonoContacto     String? // Teléfono del contacto
  notasAdmin           String? @db.Text // Notas internas del super-admin

  // Jerarquía de empresas (Grupos de empresas)
  parentCompanyId String? // ID de la empresa matriz (si es parte de un grupo)
  parentCompany   Company?  @relation("CompanyHierarchy", fields: [parentCompanyId], references: [id], onDelete: SetNull)
  childCompanies  Company[] @relation("CompanyHierarchy") // Empresas hijas

  // Límites de uso según plan
  maxUsuarios    Int? @default(5)
  maxPropiedades Int? @default(10)
  maxEdificios   Int? @default(5)

  // Suscripción (Sistema Modular)
  subscriptionPlanId String?
  subscriptionPlan   SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])

  // Sistema de tags para organización
  tags     String[]         @default([])
  category CompanyCategory? @default(standard)

  // Stripe
  stripeCustomerId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  buildings     Building[]
  tenants       Tenant[]
  providers     Provider[]
  tasks         Task[]
  auditLogs     AuditLog[]
  notifications Notification[]

  // Prioridades Medias
  valoraciones  ValoracionPropiedad[]
  publicaciones PublicacionPortal[]
  screenings    ScreeningCandidato[]
  smsTemplates  SMSTemplate[]
  smsLogs       SMSLog[]

  // Fase 1
  calendarEvents  CalendarEvent[]
  documentosFirma DocumentoFirma[]
  bankConnections BankConnection[]

  // Fase 2
  commonSpaces       CommonSpace[]
  spaceReservations  SpaceReservation[]
  insurances         Insurance[]
  energyCertificates EnergyCertificate[]

  // Fase 3
  communityIncidents     CommunityIncident[]
  communityVotes         CommunityVote[]
  communityAnnouncements CommunityAnnouncement[]
  communityMeetings      CommunityMeeting[]
  providerWorkOrders     ProviderWorkOrder[]
  propertyGalleries      PropertyGallery[]

  // Fase 5
  automaticReminders AutomaticReminder[]
  reviews            Review[]

  // Fase 6
  searchHistory      SearchHistory[]
  savedSearches      SavedSearch[]
  systemBackups      SystemBackup[]
  performanceMetrics PerformanceMetric[]

  // Sistema Modular
  companyModules CompanyModule[]

  // White Label
  branding BrandingConfig?

  // Nuevos Módulos Estratégicos (IoT, AR/VR, Marketplace, Pricing IA, ESG)
  iotDevices     IoTDevice[]     @relation("CompanyIoTDevices")
  iotAutomations IoTAutomation[] @relation("CompanyIoTAutomations")
  iotAlerts      IoTAlert[]      @relation("CompanyIoTAlerts")

  virtualTours     VirtualTour[]     @relation("CompanyVirtualTours")
  arVisualizations ARVisualization[] @relation("CompanyARVisualizations")

  marketplaceServices MarketplaceService[] @relation("CompanyMarketplaceServices")
  marketplaceBookings MarketplaceBooking[] @relation("CompanyMarketplaceBookings")
  marketplaceLoyalty  MarketplaceLoyalty[] @relation("CompanyMarketplaceLoyalty")

  pricingAnalysis   PricingAnalysis[] @relation("CompanyPricingAnalysis")
  marketData        MarketData[]      @relation("CompanyMarketData")
  pricingStrategies PricingStrategy[] @relation("CompanyPricingStrategies")

  carbonFootprints     CarbonFootprint[]     @relation("CompanyCarbonFootprints")
  decarbonizationPlans DecarbonizationPlan[] @relation("CompanyDecarbonizationPlans")
  esgCertifications    ESGCertification[]    @relation("CompanyESGCertifications")
  esgReports           ESGReport[]           @relation("CompanyESGReports")
  greenProviders       GreenProvider[]       @relation("CompanyGreenProviders")

  // Nuevos M\u00f3dulos Estratégicos Fase 2 (Blockchain, IA, Circular, Social, Security)
  propertyTokens  PropertyToken[]  @relation("CompanyPropertyTokens")
  smartContracts  SmartContract[]  @relation("CompanySmartContracts")
  nftCertificates NFTCertificate[] @relation("CompanyNFTCertificates")

  aiConversations   AIConversation[]   @relation("CompanyAIConversations")
  voiceInteractions VoiceInteraction[] @relation("CompanyVoiceInteractions")

  circularMarketplaces CircularMarketplace[] @relation("CompanyCircularMarketplace")
  urbanGardens         UrbanGarden[]         @relation("CompanyUrbanGardens")
  recyclingMetrics     RecyclingMetric[]     @relation("CompanyRecyclingMetrics")

  socialPosts     SocialPost[]     @relation("CompanySocialPosts")
  p2pServices     P2PService[]     @relation("CompanyP2PServices")
  communityEvents CommunityEvent[] @relation("CompanyCommunityEvents")
  ambassadors     Ambassador[]     @relation("CompanyAmbassadors")

  biometricVerifications BiometricVerification[] @relation("CompanyBiometricVerifications")
  gdprConsents           GDPRConsent[]           @relation("CompanyGDPRConsents")
  fraudAlerts            FraudAlert[]            @relation("CompanyFraudAlerts")
  securityAudits         SecurityAudit[]         @relation("CompanySecurityAudits")
  securityIncidents      SecurityIncident[]      @relation("CompanySecurityIncidents")

  businessModels       CompanyBusinessModel[] @relation
  strListings          STRListing[]           @relation
  strBookings          STRBooking[]           @relation
  strChannelSyncs      STRChannelSync[]       @relation
  flippingProjects     FlippingProject[]      @relation
  constructionProjects ConstructionProject[]  @relation

  // Administrador de Fincas
  communityManagements CommunityManagement[] @relation
  communityInvoices    CommunityInvoice[]    @relation
  cashBookEntries      CashBookEntry[]       @relation
  communityReports     CommunityReport[]     @relation
  professionalProjects ProfessionalProject[]  @relation

  // Room Rental Module
  rooms            Room[]
  roomContracts    RoomContract[]
  roomPayments     RoomPayment[]
  roomSharedSpaces RoomSharedSpace[]

  // Multi-empresa
  userAccess UserCompanyAccess[]

  // Redes Sociales
  socialMediaAccounts SocialMediaAccount[]
  socialMediaPosts    SocialMediaPost[]

  // Cupones de descuento
  discountCoupons DiscountCoupon[]

  // Sistema de Partners B2B
  partnerClients PartnerClient[]
  partnerCommissions Commission[]

  // Facturación B2B
  b2bInvoices            B2BInvoice[]
  b2bPaymentHistory      B2BPaymentHistory[]
  b2bSubscriptionHistory B2BSubscriptionHistory[]

  // Buzón de sugerencias
  suggestions Suggestion[]

  // CRM - Leads
  leads Lead[]

  // Automatización de onboarding y soporte
  onboardingProgress OnboardingProgress[]
  supportTickets     SupportTicket[]

  // Portal Inquilino - Mejoras Críticas
  tenantInvitations TenantInvitation[]
  serviceRatings    ServiceRating[]

  // Portal Proveedor - Mejoras Críticas
  providerAvailability      ProviderAvailability[]
  providerInvoices          ProviderInvoice[]
  providerInvoicePayments   ProviderInvoicePayment[]
  providerQuotes            ProviderQuote[]
  providerReviews           ProviderReview[]
  providerChatConversations ProviderChatConversation[]
  providerChatMessages      ProviderChatMessage[]

  // Portal Propietario - Sistema Dedicado
  owners             Owner[]
  ownerBuildings     OwnerBuilding[]
  ownerNotifications OwnerNotification[]
  ownerAlerts        OwnerAlert[]

  // Sistema de Automatizaciones Inteligentes
  automations          Automation[]
  automationExecutions AutomationExecution[]

  // Sistema de Notificaciones Avanzado - Fase 2
  notificationRules     NotificationRule[]
  notificationTemplates NotificationTemplate[]
  notificationLogs      NotificationLog[]

  // Gestión de Comunidades
  communityMinutes            CommunityMinute[]
  communityFees               CommunityFee[]
  communityFunds              CommunityFund[]
  financialAlerts             FinancialAlert[]
  cashFlowForecasts           CashFlowForecast[]
  depositManagements          DepositManagement[]
  badDebtProvisions           BadDebtProvision[]
  habitabilityCertificates    HabitabilityCertificate[]
  modelo347Records            Modelo347Record[]
  modelo180Records            Modelo180Record[]
  buildingInspections         BuildingInspection[]

  // Coliving - Red Social y Servicios Premium
  colivingProfiles            ColivingProfile[]
  colivingMatches             ColivingMatch[]
  colivingGroups              ColivingGroup[]
  colivingActivityPosts       ColivingActivityPost[]
  colivingEvents              ColivingEvent[]
  colivingServices            ColivingService[]
  colivingServiceBookings     ColivingServiceBooking[]
  colivingCheckInOuts         ColivingCheckInOut[]
  smartLocks                  SmartLock[]
  colivingPackages            ColivingPackage[]

  // Equipo Comercial Externo
  salesLeads                  SalesLead[]

  // Coliving - Analytics y Métricas Avanzadas
  colivingAnalytics           ColivingAnalytics[]
  npsSurveys                  NPSSurvey[]
  spaceWaitlists              SpaceWaitlist[]
  spaceRatings                SpaceRating[]
  spaceMaintenancePredictions SpaceMaintenancePrediction[]

  // Community Management - Pack 1
  communityEngagementMetrics CommunityEngagementMetrics[]

  // STR Housekeeping - Pack 3
  housekeepingTasks      STRHousekeepingTask[]
  housekeepingStaff      STRHousekeepingStaff[]
  housekeepingInventory  STRHousekeepingInventory[]
  housekeepingChecklists STRHousekeepingChecklist[]

  @@map("company")
}

enum RecurrenceFrequency {
  mensual
  trimestral
  semestral
  anual
}

model MaintenanceSchedule {
  id               String              @id @default(cuid())
  titulo           String
  descripcion      String              @db.Text
  tipo             String
  buildingId       String?
  unitId           String?
  frecuencia       RecurrenceFrequency
  proximaFecha     DateTime
  ultimaFecha      DateTime?
  diasAnticipacion Int                 @default(15)
  activo           Boolean             @default(true)
  providerId       String?
  costoEstimado    Float?
  notas            String?             @db.Text
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  building Building? @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit     Unit?     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  provider Provider? @relation(fields: [providerId], references: [id], onDelete: SetNull)

  @@map("maintenance_schedules")
}

enum TaskPriority {
  baja
  media
  alta
  urgente
}

enum TaskStatus {
  pendiente
  en_progreso
  completada
  cancelada
}

model Task {
  id                  String       @id @default(cuid())
  companyId           String
  titulo              String
  descripcion         String?      @db.Text
  estado              TaskStatus   @default(pendiente)
  prioridad           TaskPriority @default(media)
  fechaLimite         DateTime?
  fechaInicio         DateTime?
  fechaCompletada     DateTime?
  asignadoA           String?
  creadoPor           String
  recordatorioEnviado Boolean      @default(false)
  notas               String?      @db.Text
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  company      Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  asignadoUser User?   @relation("TaskAssignedTo", fields: [asignadoA], references: [id], onDelete: SetNull)
  creadorUser  User    @relation("TaskCreatedBy", fields: [creadoPor], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([asignadoA])
  @@index([estado])
  @@index([prioridad])
  @@index([fechaLimite])
  @@index([companyId, estado])
  @@index([asignadoA, estado])
  @@index([createdAt])
  @@map("tasks")
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

model AuditLog {
  id         String      @id @default(cuid())
  companyId  String
  userId     String
  action     AuditAction
  entityType String
  entityId   String?
  entityName String?
  changes    String?     @db.Text
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

enum ReportFrequency {
  diario
  diaria
  semanal
  quincenal
  mensual
  trimestral
  anual
}

enum ReportType {
  morosidad
  ocupacion
  ingresos
  gastos
  mantenimiento
  general
}

model ScheduledReport {
  id            String          @id @default(cuid())
  companyId     String
  nombre        String
  tipo          ReportType
  frecuencia    ReportFrequency
  destinatarios String[]        @default([])
  ultimoEnvio   DateTime?
  proximoEnvio  DateTime
  activo        Boolean         @default(true)
  incluirPdf    Boolean         @default(true)
  incluirCsv    Boolean         @default(true)
  filtros       String?         @db.Text
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@map("scheduled_reports")
}

model NotificationPreference {
  id                       String   @id @default(cuid())
  userId                   String   @unique
  emailPagoAtrasado        Boolean  @default(true)
  emailContratoVencimiento Boolean  @default(true)
  emailMantenimiento       Boolean  @default(true)
  emailDocumento           Boolean  @default(true)
  pushPagoAtrasado         Boolean  @default(true)
  pushContratoVencimiento  Boolean  @default(true)
  pushMantenimiento        Boolean  @default(true)
  pushDocumento            Boolean  @default(false)
  frecuenciaResumen        String   @default("semanal")
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@map("notification_preferences")
}

enum ApprovalType {
  gasto
  mantenimiento
}

model Approval {
  id                String         @id @default(cuid())
  tipo              ApprovalType
  entityId          String
  expenseId         String?
  maintenanceId     String?
  solicitadoPor     String
  revisadoPor       String?
  estado            ApprovalStatus @default(pendiente)
  monto             Float?
  motivo            String?        @db.Text
  comentarioRechazo String?        @db.Text
  fechaSolicitud    DateTime       @default(now())
  fechaRevision     DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  expense     Expense?            @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  maintenance MaintenanceRequest? @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)

  @@map("approvals")
}

enum ChatStatus {
  activa
  cerrada
  archivada
}

enum ChatMessageStatus {
  enviado
  entregado
  leido
}

model ChatConversation {
  id                 String     @id @default(cuid())
  companyId          String
  tenantId           String?
  userId             String?
  asunto             String
  estado             ChatStatus @default(activa)
  ultimoMensaje      String?    @db.Text
  ultimoMensajeFecha DateTime?
  cerradoPor         String?
  fechaCierre        DateTime?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  messages ChatMessage[]

  @@index([companyId, estado])
  @@index([tenantId])
  @@index([userId])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String            @id @default(cuid())
  conversationId String
  senderType     String // "user" o "tenant"
  senderId       String
  mensaje        String            @db.Text
  leido          Boolean           @default(false)
  estado         ChatMessageStatus @default(enviado)
  adjuntos       String[]          @default([])
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("chat_messages")
}

enum EmailCampaignStatus {
  borrador
  programada
  enviando
  enviada
  cancelada
}

model EmailCampaign {
  id             String              @id @default(cuid())
  companyId      String
  nombre         String
  asunto         String
  contenido      String              @db.Text
  plantillaId    String?
  estado         EmailCampaignStatus @default(borrador)
  programadaPara DateTime?
  enviadaEn      DateTime?
  creadoPor      String
  segmento       String? // "todos", "inquilinos_activos", "inquilinos_morosos", etc.
  filtros        String?             @db.Text
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  destinatarios EmailRecipient[]

  @@map("email_campaigns")
}

model EmailRecipient {
  id            String    @id @default(cuid())
  campaignId    String
  email         String
  nombre        String
  tenantId      String?
  enviado       Boolean   @default(false)
  entregado     Boolean   @default(false)
  abierto       Boolean   @default(false)
  clicado       Boolean   @default(false)
  rebotado      Boolean   @default(false)
  fechaEnvio    DateTime?
  fechaApertura DateTime?
  fechaClic     DateTime?
  errorEnvio    String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  campaign EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@map("email_recipients")
}

model DocumentFolder {
  id             String   @id @default(cuid())
  companyId      String
  nombre         String
  descripcion    String?  @db.Text
  parentFolderId String?
  color          String?  @default("#000000")
  icono          String?  @default("Folder")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  parentFolder DocumentFolder?  @relation("FolderHierarchy", fields: [parentFolderId], references: [id], onDelete: Cascade)
  subFolders   DocumentFolder[] @relation("FolderHierarchy")
  documents    Document[]       @relation("FolderDocuments")

  @@index([companyId])
  @@index([parentFolderId])
  @@map("document_folders")
}

model DocumentVersion {
  id                 String   @id @default(cuid())
  documentId         String
  versionNumero      Int
  cloud_storage_path String
  tamano             Int
  uploadedBy         String
  comentario         String?  @db.Text
  createdAt          DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("document_versions")
}

model DocumentTemplate {
  id          String   @id @default(cuid())
  companyId   String
  nombre      String
  descripcion String?  @db.Text
  tipo        String
  contenido   String   @db.Text
  variables   String[] @default([])
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@map("document_templates")
}

model DocumentShare {
  id             String    @id @default(cuid())
  documentId     String
  tenantId       String
  compartidoPor  String
  puedeDescargar Boolean   @default(true)
  puedeEditar    Boolean   @default(false)
  notificado     Boolean   @default(false)
  visto          Boolean   @default(false)
  fechaVisto     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([tenantId])
  @@map("document_shares")
}

model DocumentTag {
  id         String   @id @default(cuid())
  companyId  String
  nombre     String
  color      String   @default("#000000")
  documentos String[] @default([])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([companyId])
  @@map("document_tags")
}

model AnalyticsSnapshot {
  id                     String   @id @default(cuid())
  companyId              String
  fecha                  DateTime @default(now())
  periodo                String
  totalUnidades          Int
  unidadesOcupadas       Int
  unidadesVacantes       Int
  tasaOcupacion          Float
  ingresosMensuales      Float
  gastosMensuales        Float
  ingresoNeto            Float
  morosidad              Float
  tasaMorosidad          Float
  contratosPorVencer     Int
  mantenimientoPendiente Int
  ticketPromedio         Float
  createdAt              DateTime @default(now())

  @@index([companyId])
  @@index([fecha])
  @@index([periodo])
  @@map("analytics_snapshots")
}

model BuildingMetrics {
  id                     String   @id @default(cuid())
  buildingId             String
  fecha                  DateTime @default(now())
  periodo                String
  totalUnidades          Int
  unidadesOcupadas       Int
  tasaOcupacion          Float
  ingresosReales         Float
  ingresosPotenciales    Float
  gastos                 Float
  ingresoNeto            Float
  roi                    Float
  ticketPromedio         Float
  diasPromedioVacancia   Int
  satisfaccionInquilinos Float?
  createdAt              DateTime @default(now())

  @@index([buildingId])
  @@index([fecha])
  @@index([periodo])
  @@map("building_metrics")
}

model TenantBehavior {
  id                     String   @id @default(cuid())
  tenantId               String
  fecha                  DateTime @default(now())
  pagosATiempo           Int      @default(0)
  pagosRetrasados        Int      @default(0)
  promedioRetrasosDias   Float    @default(0)
  ticketsMantenimiento   Int      @default(0)
  scoreComportamiento    Int      @default(50)
  riesgoMorosidad        String   @default("bajo")
  probabilidadRenovacion Float?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([tenantId])
  @@index([fecha])
  @@map("tenant_behaviors")
}

model PredictionModel {
  id                  String    @id @default(cuid())
  companyId           String
  tipo                String
  nombre              String
  descripcion         String?   @db.Text
  parametros          String    @db.Text
  precision           Float?
  ultimoEntrenamiento DateTime?
  activo              Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([companyId])
  @@index([tipo])
  @@map("prediction_models")
}

model Prediction {
  id              String   @id @default(cuid())
  companyId       String
  modelId         String?
  tipo            String
  entityId        String?
  entityType      String?
  periodo         String
  valorPredicho   Float
  confianza       Float
  factores        String   @db.Text
  fechaPrediccion DateTime @default(now())
  fechaObjetivo   DateTime
  valorReal       Float?
  createdAt       DateTime @default(now())

  @@index([companyId])
  @@index([tipo])
  @@index([entityId])
  @@index([fechaObjetivo])
  @@map("predictions")
}

model Recommendation {
  id              String    @id @default(cuid())
  companyId       String
  tipo            String
  prioridad       String    @default("media")
  titulo          String
  descripcion     String    @db.Text
  entityId        String?
  entityType      String?
  impactoEstimado Float?
  accionSugerida  String    @db.Text
  aplicada        Boolean   @default(false)
  fechaAplicacion DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([companyId])
  @@index([tipo])
  @@index([prioridad])
  @@map("recommendations")
}

model MaintenanceInventory {
  id                String    @id @default(cuid())
  companyId         String
  buildingId        String?
  nombre            String
  categoria         String
  descripcion       String?   @db.Text
  codigoSKU         String?
  cantidad          Int       @default(0)
  cantidadMinima    Int       @default(5)
  unidadMedida      String    @default("unidad")
  costoUnitario     Float     @default(0)
  proveedor         String?
  ubicacion         String?
  fechaUltimaCompra DateTime?
  notas             String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([companyId])
  @@index([buildingId])
  @@index([categoria])
  @@map("maintenance_inventory")
}

model MaintenanceHistory {
  id                   String    @id @default(cuid())
  maintenanceRequestId String
  unitId               String?
  buildingId           String?
  equipoSistema        String
  tipoProblema         String
  descripcionProblema  String    @db.Text
  solucionAplicada     String?   @db.Text
  repuestosUsados      String?   @db.Text
  costoReparacion      Float?
  tiempoReparacion     Int?
  proveedorId          String?
  tecnicoAsignado      String?
  fechaDeteccion       DateTime
  fechaReparacion      DateTime?
  proximoMantenimiento DateTime?
  createdAt            DateTime  @default(now())

  @@index([equipoSistema])
  @@index([tipoProblema])
  @@index([unitId])
  @@index([buildingId])
  @@index([fechaDeteccion])
  @@map("maintenance_history")
}

model MaintenanceFailurePrediction {
  id                 String   @id @default(cuid())
  companyId          String
  equipoSistema      String
  buildingId         String?
  unitId             String?
  probabilidadFalla  Float
  diasEstimados      Int
  factoresRiesgo     String   @db.Text
  recomendaciones    String   @db.Text
  historialAnalizado Int      @default(0)
  confianza          Float    @default(0.5)
  estado             String   @default("activa")
  fechaPrediccion    DateTime @default(now())
  fechaObjetivo      DateTime
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([companyId])
  @@index([equipoSistema])
  @@index([buildingId])
  @@index([estado])
  @@index([fechaObjetivo])
  @@map("maintenance_failure_predictions")
}

model MaintenanceBudget {
  id                String   @id @default(cuid())
  companyId         String
  buildingId        String?
  periodo           String
  presupuestoTotal  Float
  gastadoCorrectivo Float    @default(0)
  gastadoPreventivo Float    @default(0)
  gastadoEmergencia Float    @default(0)
  ahorroPreventivo  Float    @default(0)
  numeroOrdenes     Int      @default(0)
  fechaInicio       DateTime
  fechaFin          DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([companyId])
  @@index([buildingId])
  @@index([periodo])
  @@map("maintenance_budgets")
}

model MaintenanceMetrics {
  id                       String   @id @default(cuid())
  companyId                String
  buildingId               String?
  periodo                  String
  tiempoRespuestaPromedio  Float
  tiempoResolucionPromedio Float
  tasaResolucionPrimera    Float
  satisfaccionCliente      Float?
  costosPreventivo         Float    @default(0)
  costosCorrectivo         Float    @default(0)
  costosEmergencia         Float    @default(0)
  solicitudesCompletas     Int      @default(0)
  solicitudesPendientes    Int      @default(0)
  solicitudesAtrasadas     Int      @default(0)
  disponibilidadEquipos    Float    @default(100)
  createdAt                DateTime @default(now())

  @@index([companyId])
  @@index([buildingId])
  @@index([periodo])
  @@map("maintenance_metrics")
}

model MaintenanceDiagnostic {
  id                   String   @id @default(cuid())
  maintenanceRequestId String
  equipoSistema        String
  sintomas             String   @db.Text
  diagnostico          String   @db.Text
  causaProbable        String   @db.Text
  solucionSugerida     String   @db.Text
  repuestosNecesarios  String?  @db.Text
  costoEstimado        Float?
  tiempoEstimado       Int?
  prioridad            String   @default("media")
  confianza            Float    @default(0.7)
  creadoPor            String
  createdAt            DateTime @default(now())

  @@index([maintenanceRequestId])
  @@index([equipoSistema])
  @@map("maintenance_diagnostics")
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String   @db.Text // Public key para encriptación
  auth      String   @db.Text // Authentication secret
  userAgent String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("push_subscriptions")
}

// ============================================
// PAQUETE 8: CONTABILIDAD
// ============================================

enum TransactionType {
  ingreso
  gasto
}

enum AccountingCategory {
  ingreso_renta
  ingreso_deposito
  ingreso_otro
  gasto_mantenimiento
  gasto_impuesto
  gasto_seguro
  gasto_servicio
  gasto_reparacion
  gasto_comunidad
  gasto_administracion
  gasto_otro
}

model AccountingTransaction {
  id            String             @id @default(cuid())
  companyId     String
  buildingId    String?
  unitId        String?
  tipo          TransactionType
  categoria     AccountingCategory
  concepto      String
  monto         Float
  fecha         DateTime
  referencia    String?
  paymentId     String?
  expenseId     String?
  documentoPath String?
  notas         String?            @db.Text
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([companyId])
  @@index([buildingId])
  @@index([tipo])
  @@index([categoria])
  @@index([fecha])
  @@map("accounting_transactions")
}

model CashFlowStatement {
  id                  String   @id @default(cuid())
  companyId           String
  periodo             String
  fechaInicio         DateTime
  fechaFin            DateTime
  ingresosTotales     Float    @default(0)
  gastosTotales       Float    @default(0)
  flujoNeto           Float    @default(0)
  saldoInicial        Float    @default(0)
  saldoFinal          Float    @default(0)
  ingresosRenta       Float    @default(0)
  ingresosDeposito    Float    @default(0)
  ingresosOtros       Float    @default(0)
  gastosMantenimiento Float    @default(0)
  gastosImpuestos     Float    @default(0)
  gastosSeguros       Float    @default(0)
  gastosServicios     Float    @default(0)
  gastosOtros         Float    @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([companyId])
  @@index([periodo])
  @@map("cash_flow_statements")
}

// ============================================
// PAQUETE 9: CRM
// ============================================

enum CrmLeadStatus {
  nuevo
  contactado
  calificado
  visitado
  propuesta_enviada
  negociacion
  ganado
  perdido
}

enum CrmLeadSource {
  web
  referido
  llamada
  email
  redes_sociales
  anuncio
  otro
}

enum CrmActivityType {
  llamada
  email
  reunion
  visita
  seguimiento
  nota
}

model CrmLead {
  id                 String        @id @default(cuid())
  companyId          String
  nombreCompleto     String
  email              String
  telefono           String
  unitId             String?
  estado             CrmLeadStatus @default(nuevo)
  fuente             CrmLeadSource @default(web)
  scoring            Int           @default(0)
  presupuesto        Float?
  fechaMudanza       DateTime?
  necesidades        String?       @db.Text
  notas              String?       @db.Text
  asignadoA          String?
  ultimoContacto     DateTime?
  proximoSeguimiento DateTime?
  probabilidadCierre Float         @default(0)
  valorEstimado      Float?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  activities CrmActivity[]

  @@index([companyId])
  @@index([estado])
  @@index([asignadoA])
  @@index([scoring])
  @@map("crm_leads")
}

model CrmActivity {
  id            String          @id @default(cuid())
  leadId        String
  tipo          CrmActivityType
  asunto        String
  descripcion   String?         @db.Text
  fecha         DateTime
  duracion      Int?
  resultado     String?         @db.Text
  proximaAccion String?         @db.Text
  completada    Boolean         @default(false)
  creadoPor     String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  lead CrmLead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([tipo])
  @@index([fecha])
  @@map("crm_activities")
}

// ============================================
// PAQUETE 10: GESTIÓN LEGAL
// ============================================

enum LegalTemplateCategory {
  contrato_arrendamiento
  anexo_contrato
  notificacion_inquilino
  reclamacion
  finalizacion_contrato
  inspeccion
  certificado
  otro
}

enum InspectionStatus {
  programada
  en_progreso
  completada
  pendiente_accion
  cancelada
}

enum InspectionType {
  entrada
  salida
  periodica
  precompra
  mantenimiento
  emergencia
}

enum PolicyStatus {
  activa
  por_renovar
  vencida
  cancelada
}

model LegalTemplate {
  id             String                @id @default(cuid())
  companyId      String
  nombre         String
  categoria      LegalTemplateCategory
  descripcion    String?               @db.Text
  contenido      String                @db.Text
  variables      String[]              @default([])
  jurisdiccion   String?
  aplicableA     String[]              @default([])
  activo         Boolean               @default(true)
  ultimaRevision DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  contracts Contract[]

  @@index([companyId])
  @@index([categoria])
  @@map("legal_templates")
}

model LegalInspection {
  id                 String           @id @default(cuid())
  companyId          String
  unitId             String?
  buildingId         String?
  contractId         String?
  tenantId           String?
  tipo               InspectionType
  estado             InspectionStatus @default(programada)
  fechaProgramada    DateTime
  fechaRealizada     DateTime?
  inspector          String
  checklist          String           @db.Text
  observaciones      String?          @db.Text
  fotosAntes         String[]         @default([])
  fotosDespues       String[]         @default([])
  daniosEncontrados  String?          @db.Text
  costoEstimadoDanos Float?
  reportePdfPath     String?
  firmaTenant        String?
  firmaInspector     String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([companyId])
  @@index([unitId])
  @@index([tipo])
  @@index([estado])
  @@index([fechaProgramada])
  @@map("legal_inspections")
}

model Inspection {
  id              String    @id @default(cuid())
  companyId       String
  unitId          String?
  buildingId      String?
  tipo            String // "entrada", "salida", "rutinaria", "técnica"
  estado          String    @default("programada") // "programada", "completada", "cancelada"
  fechaProgramada DateTime
  fechaRealizada  DateTime?
  inspector       String
  descripcion     String?   @db.Text
  observaciones   String?   @db.Text
  fotos           String[]  @default([])
  reportePdfPath  String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Fase 1
  calendarEvents CalendarEvent[]

  @@index([companyId])
  @@index([unitId])
  @@index([buildingId])
  @@index([estado])
  @@index([fechaProgramada])
  @@map("inspections")
}

model InsurancePolicy {
  id               String       @id @default(cuid())
  companyId        String
  buildingId       String?
  building         Building?    @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  tipoSeguro       String
  numeroPoliza     String       @unique
  aseguradora      String
  coberturas       String[]     @default([])
  montoCobertura   Float
  primaAnual       Float
  deducible        Float?
  fechaInicio      DateTime
  fechaVencimiento DateTime
  fechaRenovacion  DateTime?
  estado           PolicyStatus @default(activa)
  agente           String?
  telefonoAgente   String?
  emailAgente      String?
  documentoPath    String?
  notas            String?      @db.Text
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([companyId])
  @@index([buildingId])
  @@index([estado])
  @@index([fechaVencimiento])
  @@map("insurance_policies")
}

model ComplianceAlert {
  id              String    @id @default(cuid())
  companyId       String
  tipo            String
  titulo          String
  descripcion     String    @db.Text
  fechaLimite     DateTime
  estado          String    @default("pendiente")
  prioridad       String    @default("media")
  entityId        String?
  entityType      String?
  accionRequerida String?   @db.Text
  completada      Boolean   @default(false)
  fechaCompletada DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([companyId])
  @@index([estado])
  @@index([fechaLimite])
  @@map("compliance_alerts")
}

// ============================================
// PAQUETE 11: MARKETPLACE DE SERVICIOS
// ============================================

enum QuoteStatus {
  solicitada
  en_revision
  cotizada
  aceptada
  rechazada
  expirada
}

enum JobStatus {
  pendiente
  en_progreso
  completado
  cancelado
}

model ServiceQuote {
  id                String       @id @default(cuid())
  companyId         String
  providerId        String
  provider          Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  buildingId        String?
  building          Building?    @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  unitId            String?
  unit              Unit?        @relation(fields: [unitId], references: [id], onDelete: SetNull)
  titulo            String
  descripcion       String       @db.Text
  servicioRequerido String
  urgencia          String       @default("media")
  fechaSolicitud    DateTime     @default(now())
  fechaRespuesta    DateTime?
  estado            QuoteStatus  @default(solicitada)
  montoCotizado     Float?
  tiempoEstimado    String?
  notasProveedor    String?      @db.Text
  validezCotizacion DateTime?
  solicitadoPor     String
  serviceJobs       ServiceJob[]
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([companyId])
  @@index([providerId])
  @@index([estado])
  @@index([fechaSolicitud])
  @@map("service_quotes")
}

model ServiceJob {
  id               String          @id @default(cuid())
  companyId        String
  providerId       String
  provider         Provider        @relation(fields: [providerId], references: [id], onDelete: Cascade)
  quoteId          String?
  quote            ServiceQuote?   @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  buildingId       String?
  building         Building?       @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  unitId           String?
  unit             Unit?           @relation(fields: [unitId], references: [id], onDelete: SetNull)
  titulo           String
  descripcion      String          @db.Text
  fechaInicio      DateTime
  fechaFin         DateTime?
  estado           JobStatus       @default(pendiente)
  montoTotal       Float
  montoPagado      Float           @default(0)
  garantiaMeses    Int?
  notasTrabajo     String?         @db.Text
  resultadoTrabajo String?         @db.Text
  reviews          ServiceReview[]
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([companyId])
  @@index([providerId])
  @@index([estado])
  @@index([fechaInicio])
  @@map("service_jobs")
}

model ServiceReview {
  id           String     @id @default(cuid())
  companyId    String
  jobId        String
  job          ServiceJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  providerId   String
  provider     Provider   @relation(fields: [providerId], references: [id], onDelete: Cascade)
  calificacion Int // 1-5 estrellas
  puntualidad  Int? // 1-5
  calidad      Int? // 1-5
  comunicacion Int? // 1-5
  precioJusto  Int? // 1-5
  comentario   String?    @db.Text
  recomendaria Boolean    @default(true)
  creadoPor    String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([companyId])
  @@index([jobId])
  @@index([providerId])
  @@index([calificacion])
  @@map("service_reviews")
}

// ============================================
// PAQUETE 12: BUSINESS INTELLIGENCE
// ============================================

enum WidgetType {
  kpi
  chart_line
  chart_bar
  chart_pie
  chart_area
  table
  heatmap
  gauge
}

enum AlertSeverity {
  info
  warning
  critical
}

model BiWidget {
  id          String     @id @default(cuid())
  companyId   String
  nombre      String
  descripcion String?    @db.Text
  tipo        WidgetType
  dataSource  String // Tipo de dato: "occupancy", "revenue", "payments", etc.
  config      Json // Configuración específica del widget
  posicion    Int        @default(0)
  activo      Boolean    @default(true)
  creadoPor   String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([companyId])
  @@index([activo])
  @@map("bi_widgets")
}

model BiReport {
  id                 String          @id @default(cuid())
  companyId          String
  nombre             String
  descripcion        String?         @db.Text
  tipo               String // "financiero", "ocupacion", "mantenimiento"
  frecuencia         ReportFrequency
  filtros            Json // Filtros configurables
  columnas           Json // Columnas a incluir
  ultimaEjecucion    DateTime?
  proximaEjecucion   DateTime?
  activo             Boolean         @default(true)
  emailDestinatarios String[]
  creadoPor          String
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@index([companyId])
  @@index([activo])
  @@index([proximaEjecucion])
  @@map("bi_reports")
}

model BiAlert {
  id               String        @id @default(cuid())
  companyId        String
  nombre           String
  descripcion      String        @db.Text
  metrica          String // "occupancy_rate", "payment_delay", etc.
  condicion        String // "less_than", "greater_than", "equals"
  umbral           Float
  severidad        AlertSeverity @default(warning)
  activa           Boolean       @default(true)
  ultimaActivacion DateTime?
  vecesActivada    Int           @default(0)
  emailNotificar   Boolean       @default(true)
  destinatarios    String[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([companyId])
  @@index([activa])
  @@index([metrica])
  @@map("bi_alerts")
}

model TenantSegment {
  id                  String   @id @default(cuid())
  companyId           String
  nombre              String
  descripcion         String?  @db.Text
  criterios           Json // Criterios de segmentación
  tenantIds           String[] // IDs de inquilinos en este segmento
  metricasPromedio    Json? // Métricas promedio del segmento
  totalInquilinos     Int      @default(0)
  activo              Boolean  @default(true)
  ultimaActualizacion DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([companyId])
  @@index([activo])
  @@map("tenant_segments")
}

// ============================================
// PAQUETE 13: GESTIÓN DE ENERGÍA
// ============================================

enum EnergyType {
  electricidad
  agua
  gas
  calefaccion
}

enum AlertType {
  consumo_alto
  consumo_bajo
  incremento_repentino
  fuga_posible
}

model EnergyReading {
  id              String     @id @default(cuid())
  companyId       String
  buildingId      String?
  building        Building?  @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  unitId          String?
  unit            Unit?      @relation(fields: [unitId], references: [id], onDelete: SetNull)
  tipo            EnergyType
  lecturaAnterior Float?
  lecturaActual   Float
  consumo         Float // Diferencia entre lecturas
  fechaLectura    DateTime
  periodo         String // "2024-01", formato año-mes
  costo           Float?
  registradoPor   String
  notas           String?    @db.Text
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([companyId])
  @@index([buildingId])
  @@index([unitId])
  @@index([tipo])
  @@index([fechaLectura])
  @@index([periodo])
  @@map("energy_readings")
}

model EnergyAlert {
  id                   String     @id @default(cuid())
  companyId            String
  buildingId           String?
  building             Building?  @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  unitId               String?
  unit                 Unit?      @relation(fields: [unitId], references: [id], onDelete: SetNull)
  tipo                 EnergyType
  tipoAlerta           AlertType
  titulo               String
  descripcion          String     @db.Text
  consumoActual        Float
  consumoPromedio      Float?
  desviacionPorcentaje Float?
  severidad            String     @default("media")
  fechaDeteccion       DateTime   @default(now())
  resuelta             Boolean    @default(false)
  fechaResolucion      DateTime?
  accionTomada         String?    @db.Text
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  @@index([companyId])
  @@index([buildingId])
  @@index([unitId])
  @@index([tipo])
  @@index([resuelta])
  @@map("energy_alerts")
}

// ============================================
// PAQUETE 15: MULTIIDIOMA (Solo metadata)
// ============================================

model UserPreference {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  language   String   @default("es") // "es", "en"
  timezone   String   @default("Europe/Madrid")
  dateFormat String   @default("DD/MM/YYYY")
  currency   String   @default("EUR")
  theme      String   @default("light") // "light", "dark"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("user_preferences")
}

// ============================================
// PAQUETE 16: AUDITORÍA AVANZADA
// ============================================

enum AuditSeverity {
  info
  warning
  error
  critical
}

model AuditReport {
  id                String   @id @default(cuid())
  companyId         String
  titulo            String
  descripcion       String?  @db.Text
  tipoReporte       String // "accesos", "cambios", "errores", "seguridad"
  fechaInicio       DateTime
  fechaFin          DateTime
  filtros           Json? // Filtros aplicados al reporte
  totalEventos      Int      @default(0)
  eventosError      Int      @default(0)
  eventosCriticos   Int      @default(0)
  usuariosAfectados Int      @default(0)
  generadoPor       String
  reportPath        String? // Si se exporta a PDF/Excel
  createdAt         DateTime @default(now())

  @@index([companyId])
  @@index([tipoReporte])
  @@index([createdAt])
  @@map("audit_reports")
}

model SecurityEvent {
  id              String        @id @default(cuid())
  companyId       String
  tipo            String // "login_failed", "access_denied", "suspicious_activity"
  severidad       AuditSeverity @default(warning)
  userId          String?
  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  ipAddress       String?
  userAgent       String?       @db.Text
  descripcion     String        @db.Text
  detalles        Json?
  resuelta        Boolean       @default(false)
  resolucionNota  String?       @db.Text
  resueltoPor     String?
  fechaResolucion DateTime?
  createdAt       DateTime      @default(now())

  @@index([companyId])
  @@index([tipo])
  @@index([severidad])
  @@index([resuelta])
  @@index([createdAt])
  @@map("security_events")
}

// ============================================
// ALTA PRIORIDAD 1: CHATBOT GPT-4
// ============================================

enum ChatbotConversationStatus {
  activa
  resuelta
  escalada // Escalado a humano
}

model ChatbotConversation {
  id             String                    @id @default(cuid())
  companyId      String
  tenantId       String?
  tenant         Tenant?                   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  userId         String? // Si fue escalado a un agente humano
  user           User?                     @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionId      String                    @unique // ID de sesión único para tracking
  idioma         String                    @default("es") // es, en, ca, eu, gl
  estado         ChatbotConversationStatus @default(activa)
  tema           String? // "pagos", "mantenimiento", "contrato", "general"
  satisfaccion   Int? // 1-5 rating al finalizar
  comentarios    String?                   @db.Text
  escaladoMotivo String?                   @db.Text
  contexto       Json? // Contexto de la conversación para el bot
  messages       ChatbotMessage[]
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  cerradaEn      DateTime?

  @@index([companyId])
  @@index([tenantId])
  @@index([sessionId])
  @@index([estado])
  @@index([createdAt])
  @@map("chatbot_conversations")
}

model ChatbotMessage {
  id             String              @id @default(cuid())
  conversationId String
  conversation   ChatbotConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderType     String // "tenant", "bot", "agent" (humano)
  mensaje        String              @db.Text
  metadata       Json? // Datos adicionales (intención detectada, entidades, etc.)
  confidence     Float? // Confianza del bot en su respuesta (0-1)
  tokens         Int? // Tokens consumidos en esta interacción
  createdAt      DateTime            @default(now())

  @@index([conversationId])
  @@index([senderType])
  @@index([createdAt])
  @@map("chatbot_messages")
}

model ChatbotAction {
  id           String   @id @default(cuid())
  companyId    String
  sessionId    String // Relacionado a ChatbotConversation
  tenantId     String?
  accion       String // "solicitar_mantenimiento", "descargar_documento", "ver_pagos"
  parametros   Json? // Parámetros de la acción ejecutada
  resultado    String? // "exito", "error"
  errorDetalle String?  @db.Text
  createdAt    DateTime @default(now())

  @@index([companyId])
  @@index([sessionId])
  @@index([tenantId])
  @@index([accion])
  @@map("chatbot_actions")
}

// ============================================
// ALTA PRIORIDAD 2: PREDICCIÓN DE MOROSIDAD
// ============================================

enum MorosidadRiesgo {
  bajo // 0-25%
  medio // 26-50%
  alto // 51-75%
  critico // 76-100%
}

model MorosidadPrediccion {
  id                 String          @id @default(cuid())
  companyId          String
  tenantId           String
  tenant             Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contractId         String?
  contract           Contract?       @relation(fields: [contractId], references: [id], onDelete: SetNull)
  probabilidadImpago Float // 0-100
  nivelRiesgo        MorosidadRiesgo
  scoring            Int // 0-1000 (similar a credit score)

  // Factores de riesgo analizados
  factoresRiesgo      Json // Array de factores identificados
  variablesAnalizadas Int  @default(40) // Cantidad de variables en el análisis

  // Predicciones por período
  prediccion30Dias Float // Probabilidad a 30 días
  prediccion60Dias Float // Probabilidad a 60 días
  prediccion90Dias Float // Probabilidad a 90 días

  // Recomendaciones
  recomendaciones   Json // Acciones preventivas sugeridas
  accionPrioritaria String? @db.Text

  // Métricas del inquilino
  pagosATiempo        Int    @default(0)
  pagosAtrasados      Int    @default(0)
  diasPromedioRetraso Float?
  montoPendiente      Float?
  ratioIngresoRenta   Float? // Ingreso mensual / Renta mensual

  // Modelo ML
  modeloVersion       String    @default("xgboost_v1")
  confianzaModelo     Float? // 0-1
  ultimoEntrenamiento DateTime?

  // Acciones tomadas
  alertaGenerada  Boolean   @default(false)
  fechaAlerta     DateTime?
  accionesTomadas String?   @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  validaHasta DateTime // Predicción válida hasta esta fecha (30 días)

  @@index([companyId])
  @@index([tenantId])
  @@index([contractId])
  @@index([nivelRiesgo])
  @@index([probabilidadImpago])
  @@index([validaHasta])
  @@map("morosidad_predicciones")
}

model MorosidadHistorial {
  id            String   @id @default(cuid())
  companyId     String
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  paymentId     String?
  payment       Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  evento        String // "pago_atrasado", "pago_recuperado", "plan_pago_acordado"
  diasRetraso   Int?
  montoAfectado Float?
  accionTomada  String?  @db.Text
  notas         String?  @db.Text
  createdAt     DateTime @default(now())

  @@index([companyId])
  @@index([tenantId])
  @@index([evento])
  @@index([createdAt])
  @@map("morosidad_historial")
}

// ============================================
// ALTA PRIORIDAD 3: FIRMA DIGITAL (SIGNATURIT)
// ============================================

enum SignatureStatus {
  pendiente // Enviado pero no firmado
  firmado // Firmado por todas las partes
  rechazado // Rechazado por algún firmante
  cancelado // Cancelado por el administrador
  expirado // Expiró el plazo
}

enum SignerStatus {
  pendiente
  visto
  firmado
  rechazado
}

model DocumentoFirma {
  id            String  @id @default(cuid())
  companyId     String
  company       Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  titulo        String
  descripcion   String? @db.Text
  tipoDocumento String // "contrato", "adenda", "finiquito", "acta", "otro"

  // Relaciones
  contractId String?
  contract   Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)
  tenantId   String?
  tenant     Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  // Signaturit Integration
  signaturitId String?         @unique // ID del documento en Signaturit
  estado       SignatureStatus @default(pendiente)
  urlDocumento String?         @db.Text // URL del documento original
  urlFirmado   String?         @db.Text // URL del documento firmado

  // Firmantes
  firmantes Firmante[]

  // Configuración
  requiereOrden    Boolean  @default(false) // Firma secuencial
  diasExpiracion   Int      @default(30)
  fechaExpiracion  DateTime
  recordatorios    Boolean  @default(true)
  diasRecordatorio Int      @default(3) // Enviar recordatorio cada X días

  // Timestamps
  creadoPor         String
  createdBy         User?     @relation("DocumentosCreados", fields: [creadoPor], references: [id], onDelete: SetNull)
  createdAt         DateTime  @default(now())
  enviadoEn         DateTime?
  completadoEn      DateTime?
  canceladoEn       DateTime?
  canceladoPor      String?
  motivoCancelacion String?   @db.Text

  // Metadata
  metadata    Json? // Datos adicionales de Signaturit
  certificado String? @db.Text // Certificado de firma digital

  @@index([companyId])
  @@index([estado])
  @@index([contractId])
  @@index([tenantId])
  @@index([signaturitId])
  @@index([fechaExpiracion])
  @@map("documentos_firma")
}

model Firmante {
  id          String         @id @default(cuid())
  documentoId String
  documento   DocumentoFirma @relation(fields: [documentoId], references: [id], onDelete: Cascade)

  // Datos del firmante
  nombre   String
  email    String
  telefono String?
  rol      String // "inquilino", "propietario", "fiador", "testigo"
  orden    Int     @default(1) // Para firma secuencial

  // Signaturit
  signaturitId String? // ID del firmante en Signaturit
  estado       SignerStatus @default(pendiente)

  // Timestamps
  enviadoEn     DateTime?
  vistoEn       DateTime?
  firmadoEn     DateTime?
  rechazadoEn   DateTime?
  motivoRechazo String?   @db.Text

  // Recordatorios
  recordatoriosEnviados Int       @default(0)
  ultimoRecordatorio    DateTime?

  // Metadata
  ipFirma         String?
  geolocalizacion String?
  dispositivo     String?

  @@index([documentoId])
  @@index([email])
  @@index([estado])
  @@map("firmantes")
}

model SignatureWebhook {
  id           String    @id @default(cuid())
  signaturitId String // ID del evento en Signaturit
  tipo         String // "document_completed", "signature_completed", etc.
  documentoId  String?
  payload      Json // Payload completo del webhook
  procesado    Boolean   @default(false)
  errorProceso String?   @db.Text
  createdAt    DateTime  @default(now())
  procesadoEn  DateTime?

  @@index([signaturitId])
  @@index([tipo])
  @@index([procesado])
  @@map("signature_webhooks")
}

// ============================================
// ALTA PRIORIDAD 4: OPEN BANKING
// ============================================

enum BankConnectionStatus {
  conectado
  desconectado
  error
  renovacion_requerida
}

enum TransactionStatus {
  pendiente_revision
  conciliado
  descartado
}

model BankConnection {
  id String @id @default(cuid())

  // Relaciones (al menos una debe estar presente)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Proveedor (Plaid, Tink, Yapily, Bankinter/Redsys)
  proveedor       String // "plaid", "tink", "yapily", "bankinter_redsys", "redsys"
  provider        String? // Alias para proveedor (para compatibilidad API)
  proveedorItemId String?   @unique // ID del item en el proveedor
  accessToken     String? // Token encriptado
  refreshToken    String? // Refresh token para renovar acceso
  expiresAt       DateTime? // Fecha de expiración del access token
  scope           String? // Alcance de permisos (AIS, PIS, FCS)

  // Open Banking PSD2 (Bankinter/Redsys)
  consentId         String?   @unique // ID del consentimiento AIS/PIS
  consentValidUntil DateTime? // Fecha de expiración del consentimiento

  // Datos del banco
  nombreBanco    String?
  tipoCuenta     String? // "corriente", "ahorro", "credito"
  ultimosDigitos String? // Últimos 4 dígitos
  moneda         String  @default("EUR")

  // Estado
  estado       BankConnectionStatus @default(conectado)
  status       String? // Alias para estado (para compatibilidad API)
  ultimaSync   DateTime?
  proximaSync  DateTime?
  errorDetalle String?              @db.Text

  // Relaciones
  transactions BankTransaction[]
  consents     BankConsent[]
  payments     BankPayment[]

  // Configuración
  autoReconciliar  Boolean @default(true)
  notificarErrores Boolean @default(true)

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  desconectadaEn DateTime?

  @@index([userId])
  @@index([companyId])
  @@index([tenantId])
  @@index([estado])
  @@index([proveedorItemId])
  @@index([consentId])
  @@map("bank_connections")
}

model BankTransaction {
  id           String         @id @default(cuid())
  companyId    String
  connectionId String
  connection   BankConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Datos de la transacción del banco
  proveedorTxId String    @unique // ID de la transacción en el proveedor
  fecha         DateTime
  fechaContable DateTime?
  descripcion   String
  monto         Float
  moneda        String    @default("EUR")
  categoria     String? // Categoría del banco
  subcategoria  String?

  // Datos adicionales
  beneficiario    String?
  referencia      String?
  tipoTransaccion String? // "transfer", "card_payment", "direct_debit"

  // Open Banking PSD2 (Bankinter/Redsys) - Datos adicionales
  creditorName String? // Nombre del acreedor
  creditorIban String? // IBAN del acreedor
  debtorName   String? // Nombre del deudor
  debtorIban   String? // IBAN del deudor
  rawData      Json? // Datos originales de la transacción (completo)

  // Conciliación
  estado    TransactionStatus @default(pendiente_revision)
  paymentId String?
  payment   Payment?          @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  expenseId String?
  expense   Expense?          @relation(fields: [expenseId], references: [id], onDelete: SetNull)

  // Matching automático
  matchScore       Float? // 0-100, score de coincidencia
  matchSuggestions Json? // Sugerencias de matching

  // Auditoría
  conciliadoPor     String?
  conciliadoEn      DateTime?
  notasConciliacion String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([connectionId])
  @@index([estado])
  @@index([fecha])
  @@index([proveedorTxId])
  @@map("bank_transactions")
}

model ReconciliationRule {
  id          String  @id @default(cuid())
  companyId   String
  nombre      String
  descripcion String? @db.Text
  activa      Boolean @default(true)
  prioridad   Int     @default(1) // Orden de ejecución

  // Condiciones (JSON con reglas)
  condiciones Json // { "monto": { "operator": "equals", "value": 850 }, "descripcion": { "contains": "ALQUILER" } }

  // Acción
  accionTipo   String // "auto_match_payment", "auto_match_expense", "mark_as_reviewed"
  accionConfig Json? // Configuración de la acción

  // Estadísticas
  vecesAplicada    Int       @default(0)
  ultimaAplicacion DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([activa])
  @@index([prioridad])
  @@map("reconciliation_rules")
}

model ConciliacionManual {
  id               String   @id @default(cuid())
  companyId        String
  transactionId    String   @unique // ID de BankTransaction
  paymentId        String?
  payment          Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  expenseId        String?
  expense          Expense? @relation(fields: [expenseId], references: [id], onDelete: SetNull)
  diferenciaMonto  Float? // Si hay diferencia con el pago/gasto esperado
  motivoDiferencia String?  @db.Text
  notas            String?  @db.Text
  conciliadoPor    String
  createdAt        DateTime @default(now())

  @@index([companyId])
  @@index([transactionId])
  @@map("conciliaciones_manuales")
}

// ============================================================
// PAQUETES PRIORIDAD MEDIA: Valoración, Publicaciones, Screening, SMS
// ============================================================

enum ValoracionMetodo {
  comparables
  renta
  coste
  mixto
}

enum ValoracionFinalidad {
  venta
  alquiler
  seguro
  hipoteca
}

enum PortalTipo {
  idealista
  fotocasa
  habitaclia
  pisos_com
  yaencontre
  custom
}

enum PublicacionEstado {
  borrador
  activa
  pausada
  expirada
  eliminada
}

enum ScreeningEstado {
  pendiente
  en_revision
  verificado
  aprobado
  rechazado
}

enum SMSEstado {
  programado
  enviado
  fallido
  cancelado
}

enum SMSTipo {
  recordatorio_pago
  confirmacion_visita
  mantenimiento
  bienvenida
  alerta
  personalizado
}

// Valoración Automática de Propiedades
model ValoracionPropiedad {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Propiedad valorada
  unitId     String?
  unit       Unit?     @relation(fields: [unitId], references: [id], onDelete: SetNull)
  buildingId String?
  building   Building? @relation(fields: [buildingId], references: [id], onDelete: SetNull)

  // Datos básicos
  direccion    String
  municipio    String
  provincia    String
  codigoPostal String?

  // Características
  metrosCuadrados      Float
  habitaciones         Int?
  banos                Int?
  garajes              Int?
  trasteros            Int?
  ascensor             Boolean @default(false)
  terraza              Boolean @default(false)
  jardin               Boolean @default(false)
  piscina              Boolean @default(false)
  anosConstruccion     Int?
  estadoConservacion   String? // excelente, bueno, aceptable, reformar
  orientacion          String? // norte, sur, este, oeste
  eficienciaEnergetica String? // A, B, C, D, E, F, G

  // Valoración
  metodo              ValoracionMetodo
  finalidad           ValoracionFinalidad
  valorEstimado       Float // Valor estimado en EUR
  valorMinimo         Float // Rango inferior
  valorMaximo         Float // Rango superior
  precioM2            Float // Precio por m²
  confianzaValoracion Float // 0-100%

  // Comparables utilizados
  numComparables  Int   @default(0)
  comparablesData Json? // Array de propiedades comparables

  // Análisis
  factoresPositivos   Json? // Array de strings
  factoresNegativos   Json? // Array de strings
  recomendacionPrecio String? @db.Text

  // Datos de mercado
  precioMedioZona   Float?
  demandaZona       String? // alta, media, baja
  diasPromedioVenta Int? // Días promedio de venta en la zona

  // Auditoría
  generadoPor     String
  fechaValoracion DateTime  @default(now())
  validoHasta     DateTime? // Las valoraciones caducan (ej: 6 meses)
  notas           String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([unitId])
  @@index([buildingId])
  @@index([municipio])
  @@index([fechaValoracion])
  @@index([finalidad])
  @@map("valoraciones_propiedades")
}

// Publicaciones Multi-plataforma
model PublicacionPortal {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Propiedad publicada
  unitId     String
  unit       Unit      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  buildingId String?
  building   Building? @relation(fields: [buildingId], references: [id], onDelete: SetNull)

  // Datos de publicación
  titulo           String
  descripcion      String  @db.Text
  descripcionCorta String? @db.Text

  // Portales
  portales Json // Array de portales: [{nombre: "idealista", activo: true, idExterno: "123", url: "..."}]

  // Contenido multimedia
  fotosUrls      Json // Array de URLs de fotos
  videoUrl       String?
  tourVirtualUrl String?

  // Precios y condiciones
  precioVenta           Float?
  precioAlquiler        Float?
  gastosIncluidos       Boolean @default(false)
  fianza                Float?
  condicionesEspeciales String? @db.Text

  // Características destacadas
  caracteristicas Json // Array de características para destacar

  // SEO y Marketing
  palabrasClave Json? // Array de keywords
  destacada     Boolean @default(false)
  urgente       Boolean @default(false)

  // Estado y control
  estado           PublicacionEstado @default(borrador)
  fechaPublicacion DateTime?
  fechaExpiracion  DateTime?

  // Estadísticas (simuladas)
  vistas    Int @default(0)
  contactos Int @default(0)
  favoritos Int @default(0)

  // Auditoría
  creadoPor           String
  ultimaActualizacion String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([unitId])
  @@index([estado])
  @@index([fechaPublicacion])
  @@map("publicaciones_portales")
}

// Screening Avanzado de Candidatos
model ScreeningCandidato {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Candidato
  candidateId String    @unique
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  // Estado general
  estado       ScreeningEstado @default(pendiente)
  scoringTotal Float           @default(0) // 0-100

  // Verificación Identidad (20 puntos)
  dniVerificado  Boolean @default(false)
  dniComentarios String? @db.Text
  dniPuntos      Float   @default(0)

  // Verificación Laboral (25 puntos)
  contratoTrabajoVerificado Boolean @default(false)
  nominasVerificadas        Boolean @default(false)
  mesesNominas              Int     @default(0)
  empresaContactada         Boolean @default(false)
  laboralComentarios        String? @db.Text
  laboralPuntos             Float   @default(0)

  // Verificación Económica (25 puntos)
  ingresosVerificados      Boolean @default(false)
  ratioIngresosRenta       Float? // ratio ingresos/renta
  cuentaBancariaVerificada Boolean @default(false)
  ahorrosVerificados       Boolean @default(false)
  economicaComentarios     String? @db.Text
  economicaPuntos          Float   @default(0)

  // Referencias (15 puntos)
  referenciasPersonales  Int     @default(0)
  referenciasLaborales   Int     @default(0)
  referenciasPrevias     Int     @default(0)
  referenciasContactadas Int     @default(0)
  referenciasPositivas   Int     @default(0)
  referenciasComentarios String? @db.Text
  referenciasPuntos      Float   @default(0)

  // Antecedentes (15 puntos - puntos negativos)
  ficherosMorosidad       Boolean @default(false) // ASNEF, RAI, etc (manual)
  impagosAnteriores       Boolean @default(false)
  demandasPrevias         Boolean @default(false)
  antecedentesComentarios String? @db.Text
  antecedentesPuntos      Float   @default(15) // Empiezan con 15, se restan

  // Documentación aportada
  documentosRequeridos Json // Array de documentos: {nombre, recibido, verificado, fecha}
  documentosCompletos  Boolean @default(false)

  // Flags de riesgo
  flagsRiesgo       Json? // Array de alertas: [{tipo, descripcion, severidad}]
  nivelRiesgoGlobal RiskLevel @default(medio)

  // Entrevista y visita
  entrevistaRealizada Boolean @default(false)
  visitaRealizada     Boolean @default(false)
  impresionGeneral    String? @db.Text

  // Decisión final
  aprobado              Boolean? // null = pendiente, true/false = decidido
  motivoRechazo         String?  @db.Text
  condicionesEspeciales String?  @db.Text

  // Auditoría
  revisadoPor   String?
  fechaRevision DateTime?
  fechaDecision DateTime?
  notas         String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([candidateId])
  @@index([estado])
  @@index([scoringTotal])
  @@index([nivelRiesgoGlobal])
  @@map("screening_candidatos")
}

// Plantillas de SMS
model SMSTemplate {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Identificación
  nombre      String
  descripcion String? @db.Text
  tipo        SMSTipo

  // Contenido
  mensaje   String @db.Text // Máx 160 caracteres (recomendado)
  variables Json? // Array de variables disponibles: {nombre, descripcion, ejemplo}

  // Configuración
  activa          Boolean @default(true)
  envioAutomatico Boolean @default(false)

  // Trigger automático
  eventoTrigger    String? // "pago_vencimiento_3dias", "visita_confirmada", etc
  anticipacionDias Int? // Días de anticipación para el envío
  horaEnvio        String? // HH:MM formato 24h

  // Estadísticas (simuladas)
  vecesUsada  Int       @default(0)
  ultimoEnvio DateTime?

  // Auditoría
  creadoPor          String
  ultimaModificacion String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  smsLogs SMSLog[]

  @@index([companyId])
  @@index([tipo])
  @@index([activa])
  @@map("sms_templates")
}

// Logs de SMS (enviados/programados)
model SMSLog {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Plantilla usada
  templateId String?
  template   SMSTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Destinatario
  tenantId           String?
  tenant             Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  telefono           String
  nombreDestinatario String

  // Contenido
  mensaje String  @db.Text
  tipo    SMSTipo

  // Estado
  estado          SMSEstado @default(programado)
  fechaProgramada DateTime?
  fechaEnvio      DateTime?

  // Información del envío (simulado)
  proveedorSMS  String? // "Twilio", "MessageBird", etc
  idExterno     String? // ID del proveedor
  costeEstimado Float? // Coste en EUR

  // Respuesta/Error
  exitoso      Boolean?
  mensajeError String?  @db.Text

  // Contexto
  relacionadoCon String? // Tipo de entidad: "payment", "visit", "maintenance"
  relacionadoId  String? // ID de la entidad relacionada

  // Auditoría
  enviadoPor String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([companyId])
  @@index([templateId])
  @@index([tenantId])
  @@index([estado])
  @@index([fechaProgramada])
  @@index([fechaEnvio])
  @@map("sms_logs")
}

// ============================================
// CALENDARIO UNIFICADO
// ============================================

enum CalendarEventType {
  pago // Pago de renta
  vencimiento // Vencimiento de contrato
  visita // Visita programada
  mantenimiento // Mantenimiento programado
  inspeccion // Inspección
  reunion // Reunión
  recordatorio // Recordatorio general
  otro // Otro tipo de evento

  @@map("calendar_event_types")
}

enum CalendarEventPriority {
  baja
  media
  alta
  critica

  @@map("calendar_event_priorities")
}

model CalendarEvent {
  id String @id @default(cuid())

  // Empresa (multiempresa)
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Información del evento
  titulo      String
  descripcion String?               @db.Text
  tipo        CalendarEventType
  prioridad   CalendarEventPriority @default(media)

  // Fechas
  fechaInicio DateTime
  fechaFin    DateTime?
  todoElDia   Boolean   @default(false)

  // Ubicación
  ubicacion String?

  // Relaciones opcionales
  buildingId String?
  building   Building? @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  unitId String?
  unit   Unit?   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  contractId String?
  contract   Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  maintenanceRequestId String?
  maintenanceRequest   MaintenanceRequest? @relation(fields: [maintenanceRequestId], references: [id], onDelete: SetNull)

  visitId String?
  visit   Visit?  @relation(fields: [visitId], references: [id], onDelete: SetNull)

  inspectionId String?
  inspection   Inspection? @relation(fields: [inspectionId], references: [id], onDelete: SetNull)

  // Recordatorios
  recordatorioActivo  Boolean @default(false)
  recordatorioMinutos Int? // Minutos antes del evento
  recordatorioEnviado Boolean @default(false)

  // Estado
  completado        Boolean @default(false)
  cancelado         Boolean @default(false)
  motivoCancelacion String?

  // Recurrencia (para futuras mejoras)
  esRecurrente      Boolean @default(false)
  patronRecurrencia String? // JSON con patrón de recurrencia

  // Participantes
  participantes Json? // Array de IDs de usuarios

  // Metadatos
  color String? // Color personalizado en formato hex
  notas String? @db.Text

  // Auditoría
  creadoPor String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([tipo])
  @@index([fechaInicio])
  @@index([fechaFin])
  @@index([buildingId])
  @@index([unitId])
  @@index([tenantId])
  @@index([completado])
  @@index([cancelado])
  @@map("calendar_events")
}

// ==========================================
// FASE 2: NUEVOS MODELOS
// ==========================================

// ==========================================
// RESERVA DE ESPACIOS COMUNES
// ==========================================

enum CommonSpaceType {
  salon_fiestas
  gimnasio
  piscina
  sala_reuniones
  zona_bbq
  cancha_deportiva
  lavanderia
  terraza
  otro

  @@map("common_space_types")
}

enum ReservationStatus {
  pendiente
  confirmada
  cancelada
  completada

  @@map("reservation_statuses")
}

model CommonSpace {
  id String @id @default(cuid())

  // Empresa y Edificio
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  buildingId String
  building   Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  // Información del espacio
  nombre          String
  descripcion     String?         @db.Text
  tipo            CommonSpaceType
  capacidadMaxima Int?

  // Configuración de reservas
  requierePago        Boolean @default(false)
  costoPorHora        Float?
  horaApertura        String? // Formato "HH:mm"
  horaCierre          String? // Formato "HH:mm"
  duracionMaximaHoras Int     @default(4)
  anticipacionDias    Int     @default(30)

  // Reglas
  reglas String? @db.Text
  activo Boolean @default(true)

  // Relaciones
  reservations               SpaceReservation[]
  waitlists                  SpaceWaitlist[]
  ratings                    SpaceRating[]
  maintenancePredictions     SpaceMaintenancePrediction[]

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([buildingId])
  @@index([tipo])
  @@index([activo])
  @@map("common_spaces")
}

model SpaceReservation {
  id String @id @default(cuid())

  // Empresa
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Espacio y Inquilino
  spaceId String
  space   CommonSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Fechas y horario
  fechaReserva DateTime
  horaInicio   String // Formato "HH:mm"
  horaFin      String // Formato "HH:mm"

  // Estado y pago
  estado ReservationStatus @default(pendiente)
  monto  Float?
  pagado Boolean           @default(false)

  // Detalles
  numeroPersonas Int?
  proposito      String? @db.Text
  observaciones  String? @db.Text

  // Cancelación
  motivoCancelacion String?
  fechaCancelacion  DateTime?

  // Gestión de No-Shows y Penalizaciones
  noShow                 Boolean @default(false)
  penaltyApplied         Boolean @default(false)
  penaltyCredits         Int?    // Créditos descontados por penalización
  checkInConfirmado      Boolean @default(false)
  horaCheckIn            DateTime? // Hora real de check-in

  // Relaciones
  rating SpaceRating?

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([spaceId])
  @@index([tenantId])
  @@index([fechaReserva])
  @@index([estado])
  @@index([noShow])
  @@map("space_reservations")
}

// ==========================================
// GESTIÓN DE SEGUROS
// ==========================================

enum InsuranceType {
  incendio
  robo
  responsabilidad_civil
  vida
  hogar
  comunidad
  impago_alquiler
  otro

  @@map("insurance_types")
}

enum InsuranceStatus {
  activa
  vencida
  cancelada
  pendiente_renovacion

  @@map("insurance_statuses")
}

enum ClaimStatus {
  abierto
  en_proceso
  aprobado
  rechazado
  cerrado

  @@map("claim_statuses")
}

model Insurance {
  id String @id @default(cuid())

  // Empresa
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Asociación (opcional: edificio o unidad específica)
  buildingId String?
  building   Building? @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  unitId String?
  unit   Unit?   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  // Información de la póliza
  numeroPoliza    String
  tipo            InsuranceType
  aseguradora     String
  nombreAsegurado String

  // Contacto aseguradora
  telefonoAseguradora String?
  emailAseguradora    String?
  contactoAgente      String?

  // Coberturas
  cobertura     String? @db.Text
  sumaAsegurada Float?
  franquicia    Float?

  // Fechas y costos
  fechaInicio      DateTime
  fechaVencimiento DateTime
  primaMensual     Float?
  primaAnual       Float?

  // Estado
  estado               InsuranceStatus @default(activa)
  renovacionAutomatica Boolean         @default(false)

  // Documentos
  urlDocumento       String?
  documentosAdjuntos Json? // Array de {filename, url, uploadedAt}

  // Relaciones
  claims InsuranceClaim[]

  // Notas
  notas String? @db.Text

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, numeroPoliza])
  @@index([companyId])
  @@index([buildingId])
  @@index([unitId])
  @@index([tipo])
  @@index([estado])
  @@index([fechaVencimiento])
  @@map("insurances")
}

model InsuranceClaim {
  id String @id @default(cuid())

  // Póliza asociada
  insuranceId String
  insurance   Insurance @relation(fields: [insuranceId], references: [id], onDelete: Cascade)

  // Información del reclamo
  numeroReclamo  String?
  fechaSiniestro DateTime
  descripcion    String   @db.Text
  montoReclamado Float?
  montoAprobado  Float?

  // Estado
  estado ClaimStatus @default(abierto)

  // Seguimiento
  fechaApertura      DateTime  @default(now())
  fechaCierre        DateTime?
  documentosAdjuntos Json? // Array de URLs

  // Notas
  notas String? @db.Text

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([insuranceId])
  @@index([estado])
  @@index([fechaSiniestro])
  @@map("insurance_claims")
}

// ==========================================
// CERTIFICACIONES ENERGÉTICAS
// ==========================================

enum EnergyRating {
  A
  B
  C
  D
  E
  F
  G

  @@map("energy_ratings")
}

model EnergyCertificate {
  id String @id @default(cuid())

  // Empresa y Unidad
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  // Información del certificado
  numeroCertificado String?
  calificacion      EnergyRating
  consumoEnergetico Float? // kWh/m²/año
  emisionesCO2      Float? // kg CO2/m²/año

  // Técnico certificador
  nombreTecnico          String
  numeroColegiadoTecnico String?
  empresaCertificadora   String?

  // Fechas
  fechaEmision     DateTime
  fechaVencimiento DateTime // Típicamente 10 años

  // Estado
  vigente Boolean @default(true)

  // Recomendaciones
  recomendaciones String? @db.Text
  ahorroEstimado  Float? // Ahorro anual estimado en EUR

  // Documentos
  urlCertificado String?

  // Notas
  notas String? @db.Text

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([unitId])
  @@index([calificacion])
  @@index([vigente])
  @@index([fechaVencimiento])
  @@map("energy_certificates")
}

// ==========================================
// PORTAL DEL PROPIETARIO
// ==========================================
// Nota: El Portal del Propietario no requiere modelos nuevos específicos.
// Utilizará las relaciones existentes de Building, Unit, Contract, Payment,
// MaintenanceRequest, etc., pero con vistas y permisos específicos para propietarios.
// Se agregarán campos adicionales a los modelos existentes si es necesario.

// ==========================================
// FASE 3: NUEVAS FUNCIONALIDADES
// ==========================================

// Sistema de Incidencias Vecinales
enum IncidentType {
  ruido
  averia_comun
  limpieza
  seguridad
  convivencia
  mascota
  parking
  otro
}

enum IncidentStatus {
  abierta
  en_proceso
  resuelta
  cerrada
  rechazada
}

enum IncidentPriority {
  baja
  media
  alta
  urgente
}

model CommunityIncident {
  id           String @id @default(cuid())
  companyId    String
  buildingId   String
  reportedBy   String // ID del inquilino o usuario
  reporterType String // 'tenant' o 'user'

  // Información de la incidencia
  titulo      String
  descripcion String           @db.Text
  tipo        IncidentType
  estado      IncidentStatus   @default(abierta)
  prioridad   IncidentPriority @default(media)

  // Ubicación específica
  ubicacion String? // Ej: "Planta 3", "Parking B", etc.
  unitId    String?

  // Evidencia
  fotos String[] // URLs de fotos

  // Seguimiento
  asignadoA       String? // ID de usuario o proveedor
  fechaReporte    DateTime  @default(now())
  fechaResolucion DateTime?

  // Resolución
  solucion      String? @db.Text
  costoEstimado Float?
  costoFinal    Float?

  // Visibilidad
  visible Boolean @default(true) // Si es visible para la comunidad

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit     Unit?    @relation(fields: [unitId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([buildingId])
  @@index([estado])
  @@index([tipo])
  @@index([prioridad])
  @@map("community_incidents")
}

enum VoteType {
  decision_comunidad
  mejora
  gasto
  normativa
  otro
}

enum VoteStatus {
  activa
  cerrada
  cancelada
}

model CommunityVote {
  id         String @id @default(cuid())
  companyId  String
  buildingId String

  // Información de la votación
  titulo      String
  descripcion String     @db.Text
  tipo        VoteType
  estado      VoteStatus @default(activa)

  // Opciones
  opciones Json // Array de opciones {id, texto, votos: 0}

  // Configuración
  requiereQuorum  Boolean  @default(true)
  quorumRequerido Float    @default(50) // Porcentaje
  fechaInicio     DateTime @default(now())
  fechaCierre     DateTime

  // Resultados
  totalVotos     Int     @default(0)
  totalElegibles Int     @default(0)
  opcionGanadora String?

  // Auditoría
  creadoPor String // ID del usuario
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  building Building     @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  votos    VoteRecord[]

  @@index([companyId])
  @@index([buildingId])
  @@index([estado])
  @@index([fechaCierre])
  @@map("community_votes")
}

model VoteRecord {
  id       String @id @default(cuid())
  voteId   String
  tenantId String

  opcionSeleccionada String
  comentario         String?  @db.Text
  fechaVoto          DateTime @default(now())

  vote CommunityVote @relation(fields: [voteId], references: [id], onDelete: Cascade)

  @@unique([voteId, tenantId])
  @@index([voteId])
  @@map("vote_records")
}

model CommunityAnnouncement {
  id         String @id @default(cuid())
  companyId  String
  buildingId String

  // Contenido
  titulo    String
  contenido String @db.Text
  tipo      String // 'informacion', 'aviso', 'evento', 'urgente'

  // Configuración
  importante         Boolean   @default(false)
  enviarNotificacion Boolean   @default(false)
  fechaPublicacion   DateTime  @default(now())
  fechaExpiracion    DateTime?

  // Adjuntos
  adjuntos String[] // URLs de archivos

  // Visibilidad
  activo Boolean @default(true)

  // Auditoría
  publicadoPor String // ID del usuario
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([buildingId])
  @@index([activo])
  @@index([fechaPublicacion])
  @@map("community_announcements")
}

model CommunityMeeting {
  id         String @id @default(cuid())
  companyId  String
  buildingId String

  // Información de la reunión
  titulo       String
  tipo         String // 'ordinaria', 'extraordinaria', 'junta_propietarios'
  fechaReunion DateTime
  ubicacion    String?

  // Contenido
  ordenDel   String  @db.Text
  acta       String? @db.Text
  acuerdos   Json? // Array de acuerdos tomados
  asistentes Json? // Array de asistentes

  // Estado
  estado String @default("programada") // programada, realizada, cancelada

  // Documentos
  convocatoria String? // URL del documento
  actaFirmada  String? // URL del acta firmada

  // Auditoría
  organizadoPor String // ID del usuario
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([buildingId])
  @@index([fechaReunion])
  @@index([estado])
  @@map("community_meetings")
}

// Portal del Proveedor - Órdenes de Trabajo
enum WorkOrderStatus {
  pendiente // Orden creada, esperando aceptación del proveedor
  asignada // Asignada pero no aceptada
  aceptada // Proveedor aceptó la orden
  en_progreso // Trabajo en ejecución
  pausada // Temporalmente detenida
  completada // Trabajo finalizado
  cancelada // Cancelada por admin
  rechazada // Proveedor rechazó la orden
}

enum ProviderInvoiceStatus {
  borrador
  enviada
  aprobada
  rechazada
  pagada
  vencida
}

enum ProviderAvailabilityStatus {
  disponible
  ocupado
  vacaciones
  enfermedad
  no_disponible
}

model ProviderWorkOrder {
  id                   String  @id @default(cuid())
  companyId            String
  providerId           String
  maintenanceRequestId String?
  buildingId           String
  unitId               String?

  // Información de la orden
  titulo      String
  descripcion String          @db.Text
  tipo        String // 'preventivo', 'correctivo', 'urgente'
  estado      WorkOrderStatus @default(asignada)
  prioridad   String          @default("media")

  // Fechas
  fechaAsignacion DateTime  @default(now())
  fechaEstimada   DateTime?
  fechaInicio     DateTime?
  fechaCompletado DateTime?

  // Evidencia y seguimiento
  fotosAntes       String[]
  fotosDespues     String[]
  materialesUsados Json? // [{nombre, cantidad, costo}]
  horasTrabajadas  Float?

  // Costos
  presupuestoInicial Float?
  costoMateriales    Float?
  costoManoObra      Float?
  costoTotal         Float?

  // Firma digital
  firmadoPor   String? // Nombre del firmante
  firmaDigital String? // URL de la firma
  fechaFirma   DateTime?

  // Valoración
  valoracion  Int? // 1-5
  comentarios String? @db.Text

  // Auditoría
  asignadoPor String // ID del usuario
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company     Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  provider    Provider            @relation(fields: [providerId], references: [id], onDelete: Cascade)
  maintenance MaintenanceRequest? @relation(fields: [maintenanceRequestId], references: [id], onDelete: SetNull)
  building    Building            @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit        Unit?               @relation(fields: [unitId], references: [id], onDelete: SetNull)

  // Portal de Proveedores - Mejoras
  invoices ProviderInvoice[]
  quotes   ProviderQuote[]
  reviews  ProviderReview[]

  @@index([companyId])
  @@index([providerId])
  @@index([buildingId])
  @@index([estado])
  @@index([fechaAsignacion])
  @@map("provider_work_orders")
}

// Galería Multimedia
enum GalleryItemType {
  foto
  video
  tour_360
  plano
}

enum RoomType {
  exterior
  salon
  cocina
  dormitorio_principal
  dormitorio
  bano_principal
  bano
  terraza
  balcon
  jardin
  garaje
  trastero
  otro
}

model PropertyGallery {
  id        String @id @default(cuid())
  companyId String
  unitId    String @unique

  // Configuración
  portada String? // URL de la foto de portada
  orden   String[] // IDs ordenados de los items

  // Tour virtual
  urlTourVirtual String?
  embedCode      String? @db.Text

  // Marca de agua
  usarMarcaAgua Boolean @default(true)

  // Estadísticas
  visitas             Int      @default(0)
  ultimaActualizacion DateTime @default(now())

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  unit    Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  items   GalleryItem[]

  @@index([companyId])
  @@index([unitId])
  @@map("property_galleries")
}

model GalleryItem {
  id        String @id @default(cuid())
  galleryId String

  // Tipo y ubicación
  tipo       GalleryItemType
  habitacion RoomType

  // Contenido
  url          String
  urlThumbnail String?
  titulo       String?
  descripcion  String? @db.Text

  // Metadata
  orden     Int     @default(0)
  destacada Boolean @default(false)

  // Video específico
  duracion Int? // Segundos

  // 360 específico
  tipo360 String? // 'iframe', 'matterport', etc.

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gallery PropertyGallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  @@index([galleryId])
  @@index([tipo])
  @@index([habitacion])
  @@map("gallery_items")
}

// Business Intelligence Avanzado (usando modelos existentes)
// Ver modelos BiWidget, BiReport y BiAlert en sección anterior
// ==========================================
// FASE 5: MEJORAS INCREMENTALES (Nov 2024)
// ==========================================

// 1. Dashboard Personalizable por Usuario
enum WidgetSize {
  small
  medium
  large
  full
}

enum WidgetRefreshRate {
  manual
  realtime
  every_5min
  every_15min
  every_hour
  daily
}

model UserDashboardPreference {
  id     String @id @default(cuid())
  userId String @unique

  // Configuración general
  layout      String @default("grid") // grid, list, custom
  theme       String @default("light") // light, dark, auto
  defaultView String @default("overview") // overview, financial, maintenance

  // Widgets activos (orden)
  activeWidgets   String[] // Array de IDs de widgets
  widgetPositions Json? // Posiciones personalizadas {widgetId: {x, y, w, h}}

  // Filtros predeterminados
  defaultFilters Json? // Filtros guardados por vista

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  widgets DashboardWidget[]

  @@map("user_dashboard_preferences")
}

model DashboardWidget {
  id           String @id @default(cuid())
  userId       String
  preferenceId String

  // Configuración del widget
  widgetType  String // kpi, chart, table, calendar, alerts
  title       String
  size        WidgetSize        @default(medium)
  refreshRate WidgetRefreshRate @default(every_15min)

  // Configuración específica
  dataSource String? // payments, maintenance, contracts, etc
  filters    Json? // Filtros específicos del widget
  chartType  String? // line, bar, pie, doughnut
  columns    String[] @default([])

  // UI
  position Json? // {x, y, w, h}
  color    String?
  icon     String?

  // Estado
  enabled     Boolean   @default(true)
  lastRefresh DateTime?

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  preference UserDashboardPreference @relation(fields: [preferenceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([preferenceId])
  @@map("dashboard_widgets")
}

// 2. Sistema de Recordatorios Automáticos
enum ReminderType {
  pago_vencimiento
  contrato_expiracion
  mantenimiento_programado
  inspeccion_pendiente
  documento_vencimiento
  renovacion_seguro
  certificacion_expiracion
  reunion_proxima
  custom
}

enum ReminderChannel {
  email
  sms
  notification
  all
}

enum ReminderFrequency {
  once
  daily
  weekly
  monthly
}

model AutomaticReminder {
  id        String @id @default(cuid())
  companyId String

  // Configuración
  nombre      String
  descripcion String?           @db.Text
  tipo        ReminderType
  channel     ReminderChannel   @default(email)
  frequency   ReminderFrequency @default(once)

  // Timing
  diasAnticipacion Int    @default(7) // Días antes del evento
  horaEnvio        String @default("09:00")

  // Destinatarios
  enviarA String[] // user IDs, tenant IDs, or "all"

  // Condiciones
  conditions Json? // Condiciones para activar
  entityType String? // payment, contract, maintenance, etc

  // Plantilla
  tituloPlantilla  String
  mensajePlantilla String   @db.Text
  variables        String[] @default([])

  // Estado
  activo        Boolean   @default(true)
  ultimoEnvio   DateTime?
  proximoEnvio  DateTime?
  totalEnviados Int       @default(0)

  // Auditoría
  creadoPor String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([tipo])
  @@index([activo])
  @@index([proximoEnvio])
  @@map("automatic_reminders")
}

// 3. Sistema de Calificaciones y Reviews
enum ReviewEntityType {
  proveedor
  propiedad_unidad
  inquilino
  propietario
}

enum ReviewStatus {
  pendiente
  publicada
  rechazada
  reportada
}

model Review {
  id        String @id @default(cuid())
  companyId String

  // Entidad evaluada
  entityType ReviewEntityType
  entityId   String // ID del proveedor, unidad, inquilino, etc

  // Evaluador
  reviewerId   String // User ID o Tenant ID
  reviewerType String // user, tenant, owner
  reviewerName String

  // Calificación
  rating     Int // 1-5 estrellas
  titulo     String
  comentario String @db.Text
  aspectos   Json? // {limpieza: 5, puntualidad: 4, ...}

  // Respuesta (si aplica)
  respuesta      String?   @db.Text
  respondidoPor  String?
  fechaRespuesta DateTime?

  // Verificación
  verificado     Boolean @default(false)
  contratoId     String? // Si está vinculado a un contrato
  ordenTrabajoId String? // Si está vinculado a una orden

  // Moderación
  estado          ReviewStatus @default(pendiente)
  moderadoPor     String?
  fechaModeracion DateTime?
  motivoRechazo   String?

  // Utilidad
  likes    Int @default(0)
  dislikes Int @default(0)
  reportes Int @default(0)

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([entityType, entityId])
  @@index([reviewerId])
  @@index([rating])
  @@index([estado])
  @@map("reviews")
}

// ============================================
// PHASE 6: Advanced Search & Optimizations
// ============================================

model SearchHistory {
  id        String @id @default(cuid())
  userId    String
  companyId String

  query       String // Término de búsqueda
  filters     Json? // Filtros aplicados
  resultCount Int    @default(0)

  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@index([createdAt])
  @@map("search_history")
}

model SavedSearch {
  id        String @id @default(cuid())
  userId    String
  companyId String

  nombre  String
  query   String
  filters Json?

  activa    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@map("saved_searches")
}

enum BackupType {
  completo
  incremental
  manual
}

enum BackupStatus {
  pendiente
  en_progreso
  completado
  fallido
}

model SystemBackup {
  id        String @id @default(cuid())
  companyId String

  tipo   BackupType   @default(manual)
  estado BackupStatus @default(pendiente)

  registros Int     @default(0)
  tamano    String? // Tamaño en MB
  ubicacion String? // Cloud storage path o ruta local

  inicioPor    String
  errorDetalle String? @db.Text

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([estado])
  @@index([createdAt])
  @@map("system_backups")
}

model PerformanceMetric {
  id        String @id @default(cuid())
  companyId String

  metricType String // 'page_load', 'api_response', 'query_time'
  metricName String // Nombre específico de la métrica
  value      Float // Valor en ms o porcentaje

  metadata Json? // Detalles adicionales

  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([metricType])
  @@index([createdAt])
  @@map("performance_metrics")
}

// ============================================
// MODULAR SYSTEM - Para comercialización
// ============================================

enum SubscriptionTier {
  basico
  profesional
  empresarial
  personalizado
}

// ==========================================
// ENUMS: SISTEMA MULTI-VERTICAL
// ==========================================

enum BusinessModel {
  RESIDENCIAL_LARGA
  TURISTICO_STR
  COLIVING_MEDIA
  HOTEL_APARTHOT
  HOUSE_FLIPPING
  CONSTRUCCION
  SERVICIOS_PROF
}

enum ChannelType {
  AIRBNB
  BOOKING
  VRBO
  HOMEAWAY
  WEB_PROPIA
  EXPEDIA
  TRIPADVISOR
  OTROS
}

enum BookingStatus {
  PENDIENTE
  CONFIRMADA
  CHECK_IN
  CHECK_OUT
  CANCELADA
  NO_SHOW
}

enum SeasonType {
  ALTA
  MEDIA
  BAJA
  ESPECIAL
}

enum ProjectStatus {
  PROSPECTO
  ANALISIS
  ADQUISICION
  RENOVACION
  COMERCIALIZACION
  VENDIDO
  CANCELADO
}

enum RenovationCategory {
  ESTRUCTURAL
  FONTANERIA
  ELECTRICIDAD
  PINTURA
  SUELOS
  COCINA
  BANOS
  EXTERIORES
  OTROS
}

enum ConstructionPhase {
  PLANIFICACION
  PERMISOS
  CIMENTACION
  ESTRUCTURA
  CERRAMIENTOS
  INSTALACIONES
  ACABADOS
  ENTREGA
  GARANTIA
}

enum ProjectType {
  PROYECTO_BASICO
  PROYECTO_EJECUCION
  DIRECCION_OBRA
  CERTIFICACION_ENERGETICA
  INSPECCION_TECNICA
  TASACION
  CONSULTORIA
}

enum ProjectProfessionalStatus {
  PROPUESTA
  ACEPTADO
  EN_CURSO
  REVISION
  ENTREGADO
  CERRADO
  CANCELADO
}

model SubscriptionPlan {
  id             String           @id @default(cuid())
  nombre         String // "Plan Básico", "Plan Profesional", etc.
  tier           SubscriptionTier
  descripcion    String           @db.Text
  precioMensual  Float
  maxUsuarios    Int              @default(5)
  maxPropiedades Int              @default(10)

  // Módulos incluidos (JSON array de códigos de módulos)
  modulosIncluidos Json // ["edificios", "inquilinos", "pagos", ...]

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companies   Company[]
  b2bInvoices B2BInvoice[]

  @@map("subscription_plans")
}

model CompanyModule {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Código del módulo (ej: "edificios", "mantenimiento", "crm")
  moduloCodigo String

  // Control de activación
  activo Boolean @default(true)

  // Configuración específica del módulo para esta empresa
  configuracion Json?

  // Límites específicos
  limiteUso Int? // Ej: máximo de edificios, usuarios, etc.

  // Auditoría
  activadoPor String?
  activadoEn  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, moduloCodigo])
  @@index([companyId])
  @@index([moduloCodigo])
  @@map("company_modules")
}

model ModuleDefinition {
  id          String  @id @default(cuid())
  codigo      String  @unique // "edificios", "inquilinos", etc.
  nombre      String // "Gestión de Edificios"
  descripcion String  @db.Text
  categoria   String // "core", "gestion", "financiero", "comunicacion", "avanzado"
  icono       String? // Nombre del icono de Lucide
  ruta        String // "/edificios"

  // Requisitos
  requiereModulos String[] @default([]) // Módulos prerequisitos

  // Disponibilidad por tier
  tiersIncluido SubscriptionTier[]

  // Configuración
  esCore Boolean @default(false) // Módulos esenciales siempre activos
  orden  Int     @default(0) // Orden de visualización

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoria])
  @@index([codigo])
  @@map("module_definitions")
}

// ============================================
// SISTEMA DE PERSONALIZACIÓN WHITE LABEL
// ============================================

model BrandingConfig {
  id        String  @id @default(cuid())
  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Identidad
  appName        String  @default("INMOVA")
  appDescription String? @db.Text
  tagline        String?

  // Logos y Assets
  logoUrl      String?
  logoSmallUrl String?
  faviconUrl   String?
  ogImageUrl   String?

  // Paleta de Colores (CSS variables)
  primaryColor    String  @default("#000000")
  secondaryColor  String  @default("#FFFFFF")
  accentColor     String? @default("#6366f1")
  backgroundColor String  @default("#FFFFFF")
  textColor       String  @default("#000000")
  successColor    String  @default("#22c55e")
  warningColor    String  @default("#f59e0b")
  errorColor      String  @default("#ef4444")

  // Tipografía
  fontFamily  String  @default("Inter, sans-serif")
  headingFont String?

  // UI Preferences
  borderRadius    String @default("0.5rem")
  sidebarPosition String @default("left") // left, right
  theme           String @default("light") // light, dark, auto

  // Footer personalizado
  footerText   String? @db.Text
  contactEmail String?
  contactPhone String?
  websiteUrl   String?

  // SEO
  metaTitle       String?
  metaDescription String? @db.Text

  // Estado
  activo Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@map("branding_configs")
}

// ============================================
// MÓDULO: IoT Y EDIFICIOS INTELIGENTES 🏢🔌
// ============================================

model IoTDevice {
  id         String    @id @default(cuid())
  companyId  String
  company    Company   @relation("CompanyIoTDevices", fields: [companyId], references: [id], onDelete: Cascade)
  buildingId String?
  building   Building? @relation("BuildingIoTDevices", fields: [buildingId], references: [id], onDelete: SetNull)
  unitId     String?
  unit       Unit?     @relation("UnitIoTDevices", fields: [unitId], references: [id], onDelete: SetNull)

  nombre      String
  tipo        String // 'thermostat', 'lock', 'sensor', 'camera', 'light', 'hvac'
  marca       String?
  modelo      String?
  numeroSerie String?
  protocolo   String? // 'wifi', 'zigbee', 'zwave', 'mqtt', 'ble'
  ubicacion   String?

  estado         String    @default("activo")
  conectado      Boolean   @default(false)
  ultimaConexion DateTime?
  bateria        Int?

  configuracion Json?
  umbrales      Json?
  endpoint      String?
  apiKey        String?

  instaladoPor        String?
  fechaInstalacion    DateTime?
  ultimoMantenimiento DateTime?

  readings    IoTReading[]
  automations IoTAutomation[]
  alerts      IoTAlert[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([buildingId])
  @@map("iot_devices")
}

model IoTReading {
  id       String    @id @default(cuid())
  deviceId String
  device   IoTDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  metrica   String
  valor     Float
  unidad    String
  timestamp DateTime @default(now())

  @@index([deviceId, timestamp])
  @@map("iot_readings")
}

model IoTAutomation {
  id        String    @id @default(cuid())
  companyId String
  company   Company   @relation("CompanyIoTAutomations", fields: [companyId], references: [id], onDelete: Cascade)
  deviceId  String
  device    IoTDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  nombre      String
  descripcion String?
  tipo        String
  condiciones Json
  acciones    Json

  activa          Boolean   @default(true)
  ultimaEjecucion DateTime?
  vecesEjecutada  Int       @default(0)
  creadoPor       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@map("iot_automations")
}

model IoTAlert {
  id        String    @id @default(cuid())
  companyId String
  company   Company   @relation("CompanyIoTAlerts", fields: [companyId], references: [id], onDelete: Cascade)
  deviceId  String
  device    IoTDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  tipo      String
  titulo    String
  mensaje   String @db.Text
  severidad String @default("media")

  estado          String    @default("activa")
  reconocidaPor   String?
  fechaReconocida DateTime?
  fechaResuelta   DateTime?
  metadata        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, estado])
  @@map("iot_alerts")
}

// ============================================
// MÓDULO: AR/VR TOURS VIRTUALES 🥽✨
// ============================================

model VirtualTour {
  id         String    @id @default(cuid())
  companyId  String
  company    Company   @relation("CompanyVirtualTours", fields: [companyId], references: [id], onDelete: Cascade)
  unitId     String?
  unit       Unit?     @relation("UnitVirtualTours", fields: [unitId], references: [id], onDelete: SetNull)
  buildingId String?
  building   Building? @relation("BuildingVirtualTours", fields: [buildingId], references: [id], onDelete: SetNull)

  titulo      String
  descripcion String? @db.Text
  tipo        String

  urlPrincipal String  @db.Text
  urlThumbnail String?
  embedCode    String? @db.Text

  escenas  Json?
  hotspots Json?

  vistas         Int  @default(0)
  tiempoPromedio Int?
  compartido     Int  @default(0)

  estado  String  @default("borrador")
  publico Boolean @default(false)

  creadoPor  String?
  plataforma String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, estado])
  @@map("virtual_tours")
}

model ARVisualization {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyARVisualizations", fields: [companyId], references: [id], onDelete: Cascade)
  unitId    String
  unit      Unit    @relation("UnitARVisualizations", fields: [unitId], references: [id], onDelete: Cascade)

  nombre      String
  descripcion String? @db.Text
  tipo        String

  escenaBefore Json?
  escenaAfter  Json
  elementos    Json?

  costoEstimado  Float?
  tiempoEstimado Int?

  estado        String  @default("borrador")
  compartidaCon Json?
  creadoPor     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@map("ar_visualizations")
}

// ============================================
// MÓDULO: MARKETPLACE DE SERVICIOS 🛍️🏠
// ============================================

model MarketplaceService {
  id         String    @id @default(cuid())
  companyId  String
  company    Company   @relation("CompanyMarketplaceServices", fields: [companyId], references: [id], onDelete: Cascade)
  providerId String?
  provider   Provider? @relation("ProviderMarketplaceServices", fields: [providerId], references: [id], onDelete: SetNull)

  nombre       String
  descripcion  String  @db.Text
  categoria    String
  subcategoria String?

  tipoPrecio         String
  precio             Float?
  unidad             String?
  comisionPorcentaje Float   @default(10)

  disponible Boolean @default(true)
  horarios   Json?

  duracionEstimada Int?
  requisitos       Json?
  incluye          Json?
  noIncluye        Json?

  rating       Float?
  totalReviews Int    @default(0)
  imagenes     Json?

  destacado Boolean @default(false)
  activo    Boolean @default(true)

  reservas MarketplaceBooking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, categoria, activo])
  @@map("marketplace_services")
}

model MarketplaceBooking {
  id        String             @id @default(cuid())
  companyId String
  company   Company            @relation("CompanyMarketplaceBookings", fields: [companyId], references: [id], onDelete: Cascade)
  serviceId String
  service   MarketplaceService @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  tenantId  String
  tenant    Tenant             @relation("TenantMarketplaceBookings", fields: [tenantId], references: [id], onDelete: Cascade)
  unitId    String?
  unit      Unit?              @relation("UnitMarketplaceBookings", fields: [unitId], references: [id], onDelete: SetNull)

  fechaSolicitud DateTime @default(now())
  fechaServicio  DateTime
  horaInicio     String?
  horaFin        String?

  precioBase  Float
  comision    Float
  precioTotal Float

  estado            String  @default("pendiente")
  motivoCancelacion String? @db.Text

  pagado          Boolean @default(false)
  metodoPago      String?
  stripePaymentId String?

  rating      Int?
  comentario  String?   @db.Text
  fechaRating DateTime?

  notasCliente  String? @db.Text
  notasInternas String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, tenantId, estado])
  @@map("marketplace_bookings")
}

model MarketplaceLoyalty {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyMarketplaceLoyalty", fields: [companyId], references: [id], onDelete: Cascade)
  tenantId  String  @unique
  tenant    Tenant  @relation("TenantMarketplaceLoyalty", fields: [tenantId], references: [id], onDelete: Cascade)

  puntos Int    @default(0)
  nivel  String @default("bronce")

  descuentoActual   Float @default(0)
  cashbackAcumulado Float @default(0)

  puntosGanados   Int       @default(0)
  puntosCanjeados Int       @default(0)
  serviciosUsados Int       @default(0)
  ultimaActividad DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("marketplace_loyalty")
}

// ============================================
// MÓDULO: PRICING DINÁMICO CON IA 🤖💰
// ============================================

model PricingAnalysis {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyPricingAnalysis", fields: [companyId], references: [id], onDelete: Cascade)
  unitId    String
  unit      Unit    @relation("UnitPricingAnalysis", fields: [unitId], references: [id], onDelete: Cascade)

  precioActual   Float
  precioSugerido Float
  precioMinimo   Float
  precioMaximo   Float

  precioMercado Float?
  competidores  Json?

  factores        Json
  estacionalidad  Json?
  eventosCercanos Json?

  probabilidadAlquiler Int
  diasHastaAlquiler    Int?
  demandaEstimada      String?

  estrategia    String?
  recomendacion String  @db.Text

  aplicado        Boolean   @default(false)
  fechaAplicacion DateTime?
  resultadoReal   String?
  validoHasta     DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, unitId, createdAt])
  @@map("pricing_analysis")
}

model MarketData {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyMarketData", fields: [companyId], references: [id], onDelete: Cascade)

  zona         String
  codigoPostal String?

  precioPromedio Float
  precioMin      Float
  precioMax      Float

  diasPromedioAlquiler Int?
  tasaOcupacion        Float?
  demanda              String

  tipoPropiedad   String?
  numHabitaciones Int?
  metrosCuadrados Int?

  fuente   String?
  muestras Int     @default(1)
  periodo  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, zona, periodo])
  @@map("market_data")
}

model PricingStrategy {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyPricingStrategies", fields: [companyId], references: [id], onDelete: Cascade)
  unitId    String?
  unit      Unit?   @relation("UnitPricingStrategies", fields: [unitId], references: [id], onDelete: SetNull)

  nombre      String
  descripcion String? @db.Text
  tipo        String

  ajusteAutomatico Boolean @default(false)
  limitePorcentaje Float   @default(10)
  frecuencia       String  @default("semanal")

  reglas        Json
  restricciones Json?

  activa          Boolean   @default(true)
  ultimaEjecucion DateTime?
  vecesAplicada   Int       @default(0)

  incrementoIngresos Float?
  reduccionVacancia  Float?
  creadoPor          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, activa])
  @@map("pricing_strategies")
}

// ============================================
// MÓDULO: ESG Y SOSTENIBILIDAD 🌱📊
// ============================================

model CarbonFootprint {
  id         String    @id @default(cuid())
  companyId  String
  company    Company   @relation("CompanyCarbonFootprints", fields: [companyId], references: [id], onDelete: Cascade)
  buildingId String?
  building   Building? @relation("BuildingCarbonFootprints", fields: [buildingId], references: [id], onDelete: SetNull)

  periodo     String
  fechaInicio DateTime
  fechaFin    DateTime

  scope1 Float @default(0)
  scope2 Float @default(0)
  scope3 Float @default(0)
  total  Float

  desglose Json

  periodoAnterior Float?
  variacion       Float?

  intensidadPorM2      Float?
  intensidadPorPersona Float?

  metodologia   String
  verificado    Boolean @default(false)
  verificadoPor String?
  calculadoPor  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, periodo])
  @@map("carbon_footprints")
}

model DecarbonizationPlan {
  id         String    @id @default(cuid())
  companyId  String
  company    Company   @relation("CompanyDecarbonizationPlans", fields: [companyId], references: [id], onDelete: Cascade)
  buildingId String?
  building   Building? @relation("BuildingDecarbonizationPlans", fields: [buildingId], references: [id], onDelete: SetNull)

  nombre      String
  descripcion String? @db.Text

  emisionesActuales Float
  objetivoReduccion Float
  emisionesObjetivo Float
  añoObjetivo      Int

  actuaciones      Json
  presupuestoTotal Float

  estado String @default("planificado")
  avance Float  @default(0)

  ahorroAnualEstimado Float?
  periodoRetorno      Int?

  subvencionesDisponibles Json?
  subvencionesObtenidas   Float @default(0)

  creadoPor       String?
  aprobadoPor     String?
  fechaAprobacion DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, estado])
  @@map("decarbonization_plans")
}

model ESGCertification {
  id         String    @id @default(cuid())
  companyId  String
  company    Company   @relation("CompanyESGCertifications", fields: [companyId], references: [id], onDelete: Cascade)
  buildingId String?
  building   Building? @relation("BuildingESGCertifications", fields: [buildingId], references: [id], onDelete: SetNull)

  nombre String
  tipo   String
  nivel  String?

  estado   String @default("en_proceso")
  progreso Int    @default(0)

  fechaSolicitud  DateTime?
  fechaObtencion  DateTime?
  fechaExpiracion DateTime?
  fechaRenovacion DateTime?

  requisitos      Json
  puntajeObtenido Int?
  puntajeMaximo   Int?

  documentos  Json?
  certificado String?

  costoSolicitud     Float?
  costoMantenimiento Float?

  auditor          String?
  proximaAuditoria DateTime?
  creadoPor        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, tipo, estado])
  @@map("esg_certifications")
}

model ESGReport {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyESGReports", fields: [companyId], references: [id], onDelete: Cascade)

  periodo    String
  añoFiscal Int
  trimestre  Int?

  datosAmbientales Json
  datosSociales    Json
  datosGobernanza  Json

  emisionesTotales   Float
  consumoEnergia     Float
  energiaRenovable   Float
  aguaConsumida      Float
  residuosGenerados  Float
  residuosReciclados Float

  normativa String?
  cumple    Boolean @default(false)

  formato String @default("GRI")
  idioma  String @default("es")

  estado     String  @default("borrador")
  archivoUrl String?

  generadoPor      String?
  revisadoPor      String?
  aprobadoPor      String?
  fechaPublicacion DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, periodo])
  @@map("esg_reports")
}

model GreenProvider {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyGreenProviders", fields: [companyId], references: [id], onDelete: Cascade)

  nombre    String
  tipo      String
  categoria String?

  email     String?
  telefono  String?
  web       String?
  direccion String?

  certificaciones Json?
  oferta          Json

  ratingESG  Float?
  verificado Boolean @default(false)
  activo     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, tipo])
  @@map("green_providers")
}

// ============================================
// MÓDULO: BLOCKCHAIN Y TOKENIZACIÓN
// ============================================

model PropertyToken {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyPropertyTokens", fields: [companyId], references: [id], onDelete: Cascade)

  unitId String?
  unit   Unit?   @relation("UnitPropertyTokens", fields: [unitId], references: [id], onDelete: SetNull)

  buildingId String?
  building   Building? @relation("BuildingPropertyTokens", fields: [buildingId], references: [id], onDelete: SetNull)

  nombre      String
  simbolo     String
  tokenSymbol String

  blockchain      String  @default("Polygon")
  contractAddress String? @unique
  tokenStandard   String  @default("ERC-20")

  totalSupply        Int
  tokensPorPropiedad Int
  precioPorToken     Float

  valorPropiedad Float
  valorActual    Float?

  holders      TokenHolder[]
  transactions TokenTransaction[]

  estado           String    @default("draft")
  fechaEmision     DateTime?
  fechaVencimiento DateTime?

  rentaDistribuida       Float     @default(0)
  ultimaDistribucion     DateTime?
  frecuenciaDistribucion String    @default("monthly")

  documentos Json?
  metadata   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, estado])
  @@index([contractAddress])
  @@map("property_tokens")
}

model TokenHolder {
  id      String        @id @default(cuid())
  tokenId String
  token   PropertyToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  tenantId String?
  tenant   Tenant? @relation("TenantTokenHoldings", fields: [tenantId], references: [id], onDelete: SetNull)

  walletAddress String
  email         String?
  nombre        String?

  cantidadTokens      Int
  porcentajePropiedad Float
  valorInvertido      Float

  rentasRecibidas Float     @default(0)
  ultimaRenta     DateTime?

  kycVerificado Boolean   @default(false)
  fechaKYC      DateTime?

  activo           Boolean  @default(true)
  fechaAdquisicion DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tokenId, walletAddress])
  @@map("token_holders")
}

model TokenTransaction {
  id      String        @id @default(cuid())
  tokenId String
  token   PropertyToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  tipo String

  fromAddress String?
  toAddress   String?

  cantidadTokens Int
  precioUnitario Float
  montoTotal     Float

  txHash      String? @unique
  blockNumber Int?

  estado String @default("pending")

  gasFee Float?

  createdAt DateTime @default(now())

  @@index([tokenId, tipo])
  @@index([txHash])
  @@map("token_transactions")
}

model SmartContract {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanySmartContracts", fields: [companyId], references: [id], onDelete: Cascade)

  nombre      String
  descripcion String? @db.Text
  tipo        String

  blockchain      String @default("Polygon")
  contractAddress String @unique

  abi      Json
  bytecode String? @db.Text

  deployedBy     String?
  deploymentTx   String?
  deploymentDate DateTime?

  estado     String  @default("active")
  verificado Boolean @default(false)

  gasUsed String?

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, tipo])
  @@map("smart_contracts")
}

model NFTCertificate {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyNFTCertificates", fields: [companyId], references: [id], onDelete: Cascade)

  tipo String

  unitId String?
  unit   Unit?   @relation("UnitNFTCertificates", fields: [unitId], references: [id], onDelete: SetNull)

  buildingId String?
  building   Building? @relation("BuildingNFTCertificates", fields: [buildingId], references: [id], onDelete: SetNull)

  titulo      String
  descripcion String? @db.Text

  tokenId         String? @unique
  contractAddress String?

  metadataUrl String?
  imageUrl    String?

  propietario   String?
  walletAddress String?

  mintedAt DateTime?
  txHash   String?

  atributos Json?

  estado String @default("minted")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, tipo])
  @@map("nft_certificates")
}

// ============================================
// MÓDULO: ASISTENTE IA CONVERSACIONAL
// ============================================

model AIConversation {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyAIConversations", fields: [companyId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation("UserAIConversations", fields: [userId], references: [id], onDelete: SetNull)

  tenantId String?
  tenant   Tenant? @relation("TenantAIConversations", fields: [tenantId], references: [id], onDelete: SetNull)

  canal  String @default("web")
  idioma String @default("es")

  mensajes AIMessage[]
  comandos AICommand[]

  contexto Json?
  memoria  Json?

  estado String @default("activa")

  sentimiento  String?
  satisfaccion Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, estado])
  @@map("ai_conversations")
}

model AIMessage {
  id             String         @id @default(cuid())
  conversationId String
  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  rol       String
  contenido String @db.Text

  tokenUsados Int?
  modelo      String? @default("gpt-4-turbo")

  funciones Json?

  timestamp DateTime @default(now())

  @@index([conversationId])
  @@map("ai_messages")
}

model AICommand {
  id             String         @id @default(cuid())
  conversationId String
  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  comando    String
  parametros Json?

  funcion   String
  resultado Json?

  exitoso Boolean @default(false)
  error   String? @db.Text

  ejecutadoPor String?

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@map("ai_commands")
}

model VoiceInteraction {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyVoiceInteractions", fields: [companyId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation("UserVoiceInteractions", fields: [userId], references: [id], onDelete: SetNull)

  audioUrl String?
  duracion Int?

  transcripcion String? @db.Text
  idioma        String  @default("es")

  respuestaTexto String? @db.Text
  respuestaAudio String?

  comando String?
  exitoso Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([companyId])
  @@map("voice_interactions")
}

// ============================================
// MÓDULO: ECONOMÍA CIRCULAR
// ============================================

model CircularMarketplace {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyCircularMarketplace", fields: [companyId], references: [id], onDelete: Cascade)

  items CircularItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("circular_marketplaces")
}

model CircularItem {
  id            String              @id @default(cuid())
  marketplaceId String
  marketplace   CircularMarketplace @relation(fields: [marketplaceId], references: [id], onDelete: Cascade)

  tenantId String?
  tenant   Tenant? @relation("TenantCircularItems", fields: [tenantId], references: [id], onDelete: SetNull)

  nombre      String
  descripcion String? @db.Text
  categoria   String

  estado    String  @default("disponible")
  condicion String?

  tipo String @default("intercambio")

  precioMoneda Float?
  precioPuntos Int?

  fotos     String[]
  ubicacion String?

  interesados String[]

  reservadoPor String?
  fechaReserva DateTime?

  transaccionCompletada Boolean   @default(false)
  fechaTransaccion      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([marketplaceId, estado])
  @@map("circular_items")
}

model UrbanGarden {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyUrbanGardens", fields: [companyId], references: [id], onDelete: Cascade)

  buildingId String
  building   Building @relation("BuildingUrbanGardens", fields: [buildingId], references: [id], onDelete: Cascade)

  nombre      String
  descripcion String? @db.Text
  ubicacion   String

  metrosCuadrados Float
  tipoCultivo     String @default("organico")

  parcelas GardenPlot[]

  fotos  String[]
  reglas Json?

  activo Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, buildingId])
  @@map("urban_gardens")
}

model GardenPlot {
  id       String      @id @default(cuid())
  gardenId String
  garden   UrbanGarden @relation(fields: [gardenId], references: [id], onDelete: Cascade)

  numeroParcela   String
  metrosCuadrados Float

  tenantId String?
  tenant   Tenant? @relation("TenantGardenPlots", fields: [tenantId], references: [id], onDelete: SetNull)

  reservadaDesde DateTime?
  reservadaHasta DateTime?

  cultivos         Json?
  calendaroSiembra Json?

  estado String @default("disponible")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gardenId, estado])
  @@map("garden_plots")
}

model RecyclingMetric {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyRecyclingMetrics", fields: [companyId], references: [id], onDelete: Cascade)

  buildingId String?
  building   Building? @relation("BuildingRecyclingMetrics", fields: [buildingId], references: [id], onDelete: SetNull)

  periodo String

  residuosGenerados  Float
  residuosReciclados Float
  residuosOrganicos  Float
  tasaReciclaje      Float

  participantes   Int?
  puntosOtorgados Int?

  ahorrosCO2 Float?

  createdAt DateTime @default(now())

  @@index([companyId, periodo])
  @@map("recycling_metrics")
}

// ============================================
// MÓDULO: COMUNIDAD SOCIAL
// ============================================

model SocialPost {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanySocialPosts", fields: [companyId], references: [id], onDelete: Cascade)

  authorId String?
  author   Tenant? @relation("TenantSocialPosts", fields: [authorId], references: [id], onDelete: SetNull)

  buildingId String?
  building   Building? @relation("BuildingSocialPosts", fields: [buildingId], references: [id], onDelete: SetNull)

  tipo      String @default("post")
  contenido String @db.Text

  multimedia String[]

  likes   Int      @default(0)
  likedBy String[]

  comentarios SocialComment[]

  hashtags String[]

  visibilidad String @default("building")

  destacado Boolean @default(false)
  moderado  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, buildingId])
  @@index([authorId])
  @@map("social_posts")
}

model SocialComment {
  id     String     @id @default(cuid())
  postId String
  post   SocialPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  authorId String?
  author   Tenant? @relation("TenantSocialComments", fields: [authorId], references: [id], onDelete: SetNull)

  contenido String @db.Text

  likes Int @default(0)

  createdAt DateTime @default(now())

  @@index([postId])
  @@map("social_comments")
}

model TenantReputation {
  id       String @id @default(cuid())
  tenantId String @unique
  tenant   Tenant @relation("TenantReputation", fields: [tenantId], references: [id], onDelete: Cascade)

  puntos Int    @default(0)
  nivel  String @default("novato")

  badges Badge[]

  serviciosOfrecidos Int @default(0)
  serviciosRecibidos Int @default(0)

  valoracionPromedio Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tenant_reputations")
}

model Badge {
  id           String           @id @default(cuid())
  reputationId String
  reputation   TenantReputation @relation(fields: [reputationId], references: [id], onDelete: Cascade)

  codigo      String
  nombre      String
  descripcion String? @db.Text
  icono       String?

  obtenidoEn DateTime @default(now())

  @@index([reputationId])
  @@map("badges")
}

model P2PService {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyP2PServices", fields: [companyId], references: [id], onDelete: Cascade)

  providerId String
  provider   Tenant @relation("TenantP2PServices", fields: [providerId], references: [id], onDelete: Cascade)

  titulo      String
  descripcion String @db.Text
  categoria   String

  precio Float
  moneda String @default("EUR")

  duracion       Int?
  unidadDuracion String?

  disponibilidad Json?

  fotos String[]

  reservas P2PBooking[]

  rating          Float?
  numValoraciones Int    @default(0)

  activo Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, categoria])
  @@index([providerId])
  @@map("p2p_services")
}

model P2PBooking {
  id        String     @id @default(cuid())
  serviceId String
  service   P2PService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  clientId String
  client   Tenant @relation("TenantP2PBookings", fields: [clientId], references: [id], onDelete: Cascade)

  fechaReserva DateTime
  horaInicio   String?
  horaFin      String?

  precio   Float
  comision Float
  total    Float

  estado String @default("pendiente")

  pagado     Boolean   @default(false)
  fechaPago  DateTime?
  metodoPago String?

  valoracion Int?
  comentario String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceId, estado])
  @@index([clientId])
  @@map("p2p_bookings")
}

model CommunityEvent {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyCommunityEvents", fields: [companyId], references: [id], onDelete: Cascade)

  buildingId String?
  building   Building? @relation("BuildingCommunityEvents", fields: [buildingId], references: [id], onDelete: SetNull)

  titulo      String
  descripcion String? @db.Text
  categoria   String

  fecha      DateTime
  horaInicio String
  horaFin    String?

  ubicacion String

  capacidadMaxima       Int?
  asistentesConfirmados String[]
  asistentesLista       Int      @default(0)

  precio       Float?
  requierePago Boolean @default(false)

  fotos String[]

  estado String @default("programado")

  organizadoPor String?

  valoraciones   Json?
  ratingPromedio Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, estado])
  @@map("community_events")
}

model Ambassador {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyAmbassadors", fields: [companyId], references: [id], onDelete: Cascade)

  tenantId String @unique
  tenant   Tenant @relation("TenantAmbassador", fields: [tenantId], references: [id], onDelete: Cascade)

  buildingId String?
  building   Building? @relation("BuildingAmbassadors", fields: [buildingId], references: [id], onDelete: SetNull)

  fechaNombramiento DateTime @default(now())

  referidos        Int @default(0)
  referidosActivos Int @default(0)

  comisionGanada      Float @default(0)
  comisionPorReferido Float @default(50)

  estado String @default("activo")

  capacitaciones Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, estado])
  @@map("ambassadors")
}

// ============================================
// MÓDULO: SEGURIDAD Y COMPLIANCE
// ============================================

model BiometricVerification {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyBiometricVerifications", fields: [companyId], references: [id], onDelete: Cascade)

  tenantId String?
  tenant   Tenant? @relation("TenantBiometricVerifications", fields: [tenantId], references: [id], onDelete: SetNull)

  userId String?
  user   User?   @relation("UserBiometricVerifications", fields: [userId], references: [id], onDelete: SetNull)

  tipo String

  resultado  String
  confidence Float?

  metadata Json?

  documentoVerificado String?
  proveedor           String? @default("Veriff")

  ipAddress String?
  userAgent String? @db.Text

  createdAt DateTime @default(now())

  @@index([companyId, tipo])
  @@map("biometric_verifications")
}

model GDPRConsent {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyGDPRConsents", fields: [companyId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation("UserGDPRConsents", fields: [userId], references: [id], onDelete: SetNull)

  tenantId String?
  tenant   Tenant? @relation("TenantGDPRConsents", fields: [tenantId], references: [id], onDelete: SetNull)

  tipo        String
  descripcion String? @db.Text

  consentido Boolean

  version String?
  idioma  String  @default("es")

  fecha     DateTime @default(now())
  ipAddress String

  evidencia String?

  revocado        Boolean   @default(false)
  fechaRevocacion DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, userId])
  @@index([companyId, tenantId])
  @@map("gdpr_consents")
}

model FraudAlert {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanyFraudAlerts", fields: [companyId], references: [id], onDelete: Cascade)

  entityType String
  entityId   String

  tipo String

  riesgo String
  score  Float

  razon    String @db.Text
  detalles Json?

  factores String[]

  revisado      Boolean   @default(false)
  revisadoPor   String?
  fechaRevision DateTime?

  accionTomada String?
  notas        String? @db.Text

  estado String @default("abierto")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, estado])
  @@index([entityType, entityId])
  @@map("fraud_alerts")
}

model SecurityAudit {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanySecurityAudits", fields: [companyId], references: [id], onDelete: Cascade)

  tipo    String
  alcance String?

  fechaInicio DateTime
  fechaFin    DateTime?

  auditor     String?
  herramienta String?

  vulnerabilidades Json?
  numCriticas      Int   @default(0)
  numAltas         Int   @default(0)
  numMedias        Int   @default(0)
  numBajas         Int   @default(0)

  recomendaciones Json?

  scoreSeguridad Float?

  reporteUrl String?

  estado String @default("en_progreso")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, tipo])
  @@map("security_audits")
}

model SecurityIncident {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CompanySecurityIncidents", fields: [companyId], references: [id], onDelete: Cascade)

  tipo      String
  severidad String

  titulo      String
  descripcion String @db.Text

  afectados          Json?
  datosComprometidos Json?

  detectadoPor   String?
  fechaDeteccion DateTime @default(now())

  fechaIncidente DateTime?

  estado String @default("detectado")

  responsable     String?
  fechaAsignacion DateTime?

  accionesCorrectivas Json?
  fechaResolucion     DateTime?

  notificadoGDPR    Boolean   @default(false)
  fechaNotificacion DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, estado])
  @@map("security_incidents")
}

// ==========================================
// SISTEMA DE PARAMETRIZACIÓN MULTI-VERTICAL
// ==========================================

model CompanyBusinessModel {
  id            String        @id @default(cuid())
  companyId     String
  businessModel BusinessModel
  activo        Boolean       @default(true)
  configuracion Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, businessModel])
  @@map("company_business_models")
}

// ==========================================
// MÓDULO: SHORT-TERM RENTAL (STR) / TURÍSTICO
// ==========================================

model STRListing {
  id              String @id @default(cuid())
  companyId       String
  unitId          String
  titulo          String
  descripcion     String @db.Text
  tipoPropiedad   String
  capacidadMaxima Int
  numDormitorios  Int
  numCamas        Int
  numBanos        Int

  amenities       String[] @default([])
  reglasHospedaje String[] @default([])

  precioPorNoche Float
  precioSemana   Float?
  precioMes      Float?

  tarifaLimpieza     Float @default(0)
  depositoSeguridad  Float @default(0)
  comisionPlataforma Float @default(0)

  checkInTime         String  @default("15:00")
  checkOutTime        String  @default("11:00")
  cancelacionFlexible Boolean @default(true)
  reservaInstantanea  Boolean @default(false)

  sincronizarCanales Boolean      @default(true)
  canalPrincipal     ChannelType?

  totalReservas  Int    @default(0)
  ratingPromedio Float?
  totalReviews   Int    @default(0)
  tasaOcupacion  Float?

  pricingRules Json? // Reglas de pricing dinámico

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  unit    Unit    @relation(fields: [unitId], references: [id], onDelete: Cascade)

  bookings      STRBooking[]
  calendar      STRCalendar[]
  channels      STRChannelSync[]
  reviews       STRReview[]
  seasonPricing STRSeasonPricing[]

  // STR Channel Manager Avanzado - Pack 2
  channelPricing      STRChannelPricing[]
  dynamicPricingRules STRDynamicPricingRule[]
  competitorAnalysis  STRCompetitorAnalysis[]
  channelMetrics      STRChannelMetrics[]

  // STR Housekeeping - Pack 3
  housekeepingTasks STRHousekeepingTask[]

  @@map("str_listings")
}

model STRBooking {
  id               String      @id @default(cuid())
  companyId        String
  listingId        String
  canal            ChannelType
  reservaExternaId String?

  guestNombre   String
  guestEmail    String
  guestTelefono String?
  guestPais     String?
  numHuespedes  Int

  checkInDate  DateTime
  checkOutDate DateTime
  numNoches    Int

  precioTotal    Float
  tarifaNocturna Float
  tarifaLimpieza Float @default(0)
  tasasImpuestos Float @default(0)
  comisionCanal  Float @default(0)
  ingresoNeto    Float

  metodoPago String?
  estadoPago String  @default("pendiente")
  pagado     Boolean @default(false)

  estado            BookingStatus @default(PENDIENTE)
  confirmadaEn      DateTime?
  checkInRealizado  DateTime?
  checkOutRealizado DateTime?
  canceladaEn       DateTime?
  motivoCancelacion String?

  notasEspeciales   String? @db.Text
  requiereLimpieza  Boolean @default(true)
  limpiezaRealizada Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  listing STRListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  housekeepingTasks STRHousekeepingTask[]

  @@map("str_bookings")
}

model STRCalendar {
  id             String   @id @default(cuid())
  listingId      String
  fecha          DateTime @db.Date
  disponible     Boolean  @default(true)
  precioPorNoche Float
  minimoNoches   Int      @default(1)
  notas          String?

  sincronizado Boolean   @default(false)
  ultimaSync   DateTime?

  listing STRListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, fecha])
  @@map("str_calendar")
}

model STRChannelSync {
  id        String      @id @default(cuid())
  companyId String
  listingId String
  canal     ChannelType

  activo     Boolean @default(true)
  url        String?
  apiKey     String?
  externalId String?

  sincronizarPrecio     Boolean @default(true)
  sincronizarCalendario Boolean @default(true)
  sincronizarReservas   Boolean @default(true)

  ultimaSync  DateTime?
  proximaSync DateTime?
  estadoSync  String    @default("pendiente")
  erroresSync Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  listing STRListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, canal])
  @@map("str_channel_sync")
}

model STRReview {
  id        String      @id @default(cuid())
  listingId String
  bookingId String?
  canal     ChannelType

  guestNombre String
  rating      Int
  comentario  String   @db.Text
  fecha       DateTime

  ratingLimpieza     Int?
  ratingComunicacion Int?
  ratingUbicacion    Int?
  ratingPrecio       Int?

  respuesta    String?   @db.Text
  respondidoEn DateTime?

  createdAt DateTime @default(now())

  listing STRListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@map("str_reviews")
}

model STRSeasonPricing {
  id        String     @id @default(cuid())
  listingId String
  temporada SeasonType
  nombre    String

  fechaInicio DateTime @db.Date
  fechaFin    DateTime @db.Date

  precioPorNoche Float
  minimoNoches   Int   @default(1)

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  listing STRListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@map("str_season_pricing")
}

// ==========================================
// STR CHANNEL MANAGER AVANZADO - Pack 2
// ==========================================

enum ChannelSyncDirection {
  push      // Solo envía datos al canal
  pull      // Solo recibe datos del canal  
  bidirectional // Sincronización bidireccional
}

enum SyncEventType {
  price_update
  availability_update
  booking_new
  booking_cancel
  booking_modify
  content_update
  review_received
}

// Historial de sincronizaciones
model STRSyncHistory {
  id String @id @default(cuid())

  channelSyncId String
  
  tipoEvento    SyncEventType
  direccion     ChannelSyncDirection @default(push)
  
  // Datos del evento
  payload       Json?
  respuesta     Json?
  
  // Estado
  exitoso       Boolean @default(false)
  mensajeError  String? @db.Text
  codigoError   String?
  reintentos    Int @default(0)
  
  // Timing
  iniciadoEn    DateTime @default(now())
  finalizadoEn  DateTime?
  duracionMs    Int?

  createdAt DateTime @default(now())

  @@index([channelSyncId])
  @@index([tipoEvento])
  @@index([exitoso])
  @@index([iniciadoEn])
  @@map("str_sync_history")
}

// Pricing dinámico por canal
model STRChannelPricing {
  id String @id @default(cuid())

  listingId String
  listing   STRListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  canal     ChannelType

  // Ajuste de precios por canal
  ajusteTipo        String @default("porcentaje") // porcentaje, fijo
  ajusteValor       Float @default(0) // +10% o +20€
  
  // Comisión del canal
  comisionCanal     Float @default(0) // % de comisión
  compensarComision Boolean @default(false)

  // Precios mínimos y máximos por canal
  precioMinimo      Float?
  precioMaximo      Float?

  // Descuentos específicos del canal
  descuentoSemana   Float? // % descuento 7+ noches
  descuentoMes      Float? // % descuento 28+ noches
  descuentoLastMin  Float? // % descuento última hora

  activo Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([listingId, canal])
  @@index([listingId])
  @@map("str_channel_pricing")
}

// Reglas de pricing inteligente
model STRDynamicPricingRule {
  id String @id @default(cuid())

  listingId String
  listing   STRListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  nombre      String
  descripcion String?
  prioridad   Int @default(0) // Mayor prioridad primero

  // Condiciones (JSON para flexibilidad)
  condiciones Json // {diasAntelacion: {min: 0, max: 7}, ocupacion: {min: 80}}
  
  // Acción
  accionTipo  String // ajuste_porcentaje, precio_fijo, multiplicador
  accionValor Float

  // Aplicabilidad
  aplicarCanales  ChannelType[] @default([])
  diasSemana      Int[] @default([]) // 0=Dom, 6=Sab
  fechaInicio     DateTime?
  fechaFin        DateTime?

  activo Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([listingId])
  @@index([activo])
  @@map("str_dynamic_pricing_rules")
}

// Análisis de competencia
model STRCompetitorAnalysis {
  id String @id @default(cuid())

  listingId String
  listing   STRListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  // Competidor
  competidorUrl     String
  competidorNombre  String?
  canal             ChannelType

  // Datos capturados
  precioCapturado   Float
  ocupacionEstimada Float?
  ratingCapturado   Float?
  
  fechaCaptura      DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([listingId])
  @@index([fechaCaptura])
  @@map("str_competitor_analysis")
}

// Métricas de rendimiento por canal
model STRChannelMetrics {
  id String @id @default(cuid())

  listingId   String
  listing     STRListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  canal       ChannelType
  periodo     DateTime @db.Date // Fecha del periodo (día)

  // Métricas de reservas
  reservasRecibidas     Int @default(0)
  reservasCanceladas    Int @default(0)
  reservasModificadas   Int @default(0)
  nochesReservadas      Int @default(0)

  // Métricas financieras
  ingresosBrutos        Float @default(0)
  comisionesCanal       Float @default(0)
  ingresosNetos         Float @default(0)
  
  // ADR (Average Daily Rate)
  adr                   Float @default(0)
  
  // Ocupación
  tasaOcupacion         Float @default(0)
  
  // Calificaciones
  reviewsRecibidas      Int @default(0)
  ratingPromedio        Float?

  // Visibilidad (si disponible)
  impresiones           Int?
  clics                 Int?
  conversionRate        Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([listingId, canal, periodo])
  @@index([listingId])
  @@index([canal])
  @@index([periodo])
  @@map("str_channel_metrics")
}

// ==========================================
// STR HOUSEKEEPING & TURNOVER - Pack 3
// ==========================================

enum HousekeepingStatus {
  pendiente
  asignado
  en_progreso
  completado
  verificado
  incidencia
}

enum TurnoverType {
  check_out
  check_in
  limpieza_profunda
  mantenimiento
  inspeccion
}

// Tareas de Housekeeping
model STRHousekeepingTask {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  listingId String
  listing   STRListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  bookingId String?
  booking   STRBooking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  // Tipo y estado
  tipo        TurnoverType @default(check_out)
  status      HousekeepingStatus @default(pendiente)

  // Fechas
  fechaProgramada DateTime
  fechaInicio     DateTime?
  fechaFin        DateTime?

  // Asignación
  asignadoA       String?
  staff           STRHousekeepingStaff? @relation(fields: [asignadoA], references: [id], onDelete: SetNull)
  asignadoNombre  String?
  
  // Detalles
  notas           String? @db.Text
  instruccionesEspeciales String? @db.Text
  prioridad       Int @default(0) // 0=normal, 1=alta, 2=urgente

  // Checklist completado
  checklistCompletado Json? // {items: [{nombre, completado, notas}]}
  fotosAntes      String[] @default([])
  fotosDespues    String[] @default([])

  // Tiempo estimado y real
  tiempoEstimadoMin Int?
  tiempoRealMin     Int?

  // Costos
  costoMateriales Float @default(0)
  costoManoObra   Float @default(0)

  // Check-in/out del personal
  checkInTime     DateTime?
  checkOutTime    DateTime?
  ubicacionCheckIn Json? // {lat, lng}

  // Incidencias
  incidencias     String[] @default([])
  requiereAtencion Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([listingId])
  @@index([fechaProgramada])
  @@index([status])
  @@index([asignadoA])
  @@map("str_housekeeping_tasks")
}

// Personal de Housekeeping
model STRHousekeepingStaff {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Información del personal
  nombre          String
  email           String?
  telefono        String
  foto            String?
  
  // Tipo
  tipo            String @default("interno") // interno, externo, empresa
  empresaNombre   String? // Si es empresa externa

  // Disponibilidad
  activo          Boolean @default(true)
  diasDisponibles Int[] @default([1, 2, 3, 4, 5]) // 0=Dom, 6=Sab
  horaInicio      String @default("08:00")
  horaFin         String @default("18:00")

  // Capacidades
  capacidadDiaria Int @default(4) // Turnovers por día
  zonasTrabajo    String[] @default([]) // IDs de edificios o zonas

  // Tarifas
  tarifaPorTurnover Float?
  tarifaPorHora     Float?

  // Estadísticas
  tareasCompletadas   Int @default(0)
  calificacionPromedio Float?
  tiempoPromedioMin   Int?

  // Credenciales app móvil
  pinAcceso       String?
  appToken        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasks STRHousekeepingTask[]

  @@index([companyId])
  @@index([activo])
  @@map("str_housekeeping_staff")
}

// Inventario de Housekeeping
model STRHousekeepingInventory {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  listingId String?

  // Artículo
  nombre          String
  categoria       String // limpieza, amenities, ropa_cama, cocina
  sku             String?
  
  // Stock
  stockActual     Int @default(0)
  stockMinimo     Int @default(5)
  stockOptimo     Int?
  
  // Ubicación
  ubicacion       String? // Almacén o unidad

  // Costos
  costoUnitario   Float?
  proveedorId     String?

  // Control
  fechaUltimoConteo DateTime?
  alertaStockBajo   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Movimientos de inventario
  movimientos STRInventoryMovement[]

  @@index([companyId])
  @@index([listingId])
  @@index([categoria])
  @@index([alertaStockBajo])
  @@map("str_housekeeping_inventory")
}

// Movimientos de inventario
model STRInventoryMovement {
  id String @id @default(cuid())

  inventoryId String
  inventory   STRHousekeepingInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  // Movimiento
  tipo        String // entrada, salida, ajuste
  cantidad    Int
  motivo      String? // compra, uso, dañado, perdido

  // Referencia
  taskId      String? // Tarea de housekeeping relacionada

  // Registro
  registradoPor String?
  fecha         DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([inventoryId])
  @@index([fecha])
  @@map("str_inventory_movements")
}

// Checklist Templates
model STRHousekeepingChecklist {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  nombre        String
  descripcion   String?
  tipo          TurnoverType @default(check_out)
  
  // Items del checklist
  items         Json // [{id, nombre, categoria, obligatorio, orden}]
  
  // Tiempo estimado
  tiempoEstimadoMin Int?

  activo Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([tipo])
  @@map("str_housekeeping_checklists")
}

// ==========================================
// MÓDULO: HOUSE FLIPPING / INVERSIÓN
// ==========================================

model FlippingProject {
  id         String  @id @default(cuid())
  companyId  String
  unitId     String?
  buildingId String?

  nombre      String
  direccion   String
  descripcion String? @db.Text

  precioCompra Float
  gastosCompra Float     @default(0)
  fechaCompra  DateTime?

  presupuestoRenovacion  Float
  gastosRealesRenovacion Float @default(0)

  precioVentaEstimado Float
  precioVentaReal     Float?
  gastosVenta         Float     @default(0)
  fechaVenta          DateTime?

  financiado        Boolean @default(false)
  montoFinanciacion Float?
  interesAnual      Float?

  fechaInicioObra  DateTime?
  fechaFinObra     DateTime?
  duracionEstimada Int?
  duracionReal     Int?

  inversionTotal Float?
  beneficioNeto  Float?
  roiPorcentaje  Float?

  estado    ProjectStatus @default(PROSPECTO)
  prioridad String        @default("media")

  fotosAntes   String[] @default([])
  fotosDespues String[] @default([])
  documentos   String[] @default([])

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  completadoEn DateTime?

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  unit     Unit?     @relation(fields: [unitId], references: [id], onDelete: SetNull)
  building Building? @relation(fields: [buildingId], references: [id], onDelete: SetNull)

  renovations FlippingRenovation[]
  expenses    FlippingExpense[]
  milestones  FlippingMilestone[]

  @@map("flipping_projects")
}

model FlippingRenovation {
  id          String             @id @default(cuid())
  projectId   String
  categoria   RenovationCategory
  descripcion String

  presupuestado Float
  costoReal     Float?

  proveedorNombre String?
  proveedorId     String?

  fechaInicio DateTime?
  fechaFin    DateTime?

  completado       Boolean @default(false)
  porcentajeAvance Int     @default(0)

  notas         String?  @db.Text
  fotosProgreso String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project FlippingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("flipping_renovations")
}

model FlippingExpense {
  id        String   @id @default(cuid())
  projectId String
  concepto  String
  categoria String
  monto     Float
  fecha     DateTime

  proveedor String?
  factura   String?

  createdAt DateTime @default(now())

  project FlippingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("flipping_expenses")
}

model FlippingMilestone {
  id              String    @id @default(cuid())
  projectId       String
  titulo          String
  descripcion     String?
  fechaPrevista   DateTime
  fechaCompletado DateTime?
  completado      Boolean   @default(false)

  createdAt DateTime @default(now())

  project FlippingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("flipping_milestones")
}

// ==========================================
// MÓDULO: CONSTRUCCIÓN Y PROMOCIÓN
// ==========================================

model ConstructionProject {
  id         String  @id @default(cuid())
  companyId  String
  buildingId String?

  nombre       String
  descripcion  String @db.Text
  tipoProyecto String

  direccion           String
  parcela             String?
  referenciaCatastral String?

  numViviendas      Int?
  metrosConstruidos Float?
  numPlantas        Int?

  presupuestoTotal      Float
  gastosReales          Float  @default(0)
  desviacionPresupuesto Float?

  fechaInicio      DateTime
  fechaFinPrevista DateTime
  fechaFinReal     DateTime?
  duracionMeses    Int

  faseActual       ConstructionPhase @default(PLANIFICACION)
  porcentajeAvance Int               @default(0)

  licenciaObra     Boolean @default(false)
  certificadoFinal Boolean @default(false)
  habitabilidad    Boolean @default(false)

  planos          String[] @default([])
  permisos        String[] @default([])
  certificaciones String[] @default([])
  fotosProgreso   String[] @default([])

  arquitecto  String?
  aparejador  String?
  constructor String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  building Building? @relation(fields: [buildingId], references: [id], onDelete: SetNull)

  workOrders  ConstructionWorkOrder[]
  inspections ConstructionInspection[]
  suppliers   ConstructionSupplier[]

  @@map("construction_projects")
}

model ConstructionWorkOrder {
  id        String            @id @default(cuid())
  projectId String
  fase      ConstructionPhase

  titulo      String
  descripcion String @db.Text

  subcontratista String
  telefono       String?
  email          String?

  presupuesto Float
  costoReal   Float?

  fechaInicio DateTime
  fechaFin    DateTime

  estado           String @default("pendiente")
  porcentajeAvance Int    @default(0)

  certificadoCalidad Boolean @default(false)
  inspeccionada      Boolean @default(false)

  documentos     String[] @default([])
  fotosEvidencia String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project ConstructionProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("construction_work_orders")
}

model ConstructionInspection {
  id        String            @id @default(cuid())
  projectId String
  fase      ConstructionPhase

  tipo      String
  inspector String
  fecha     DateTime

  resultado     String
  observaciones String? @db.Text

  defectosEncontrados Int @default(0)
  defectosCorregidos  Int @default(0)

  documentacion String[] @default([])
  fotos         String[] @default([])

  createdAt DateTime @default(now())

  project ConstructionProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("construction_inspections")
}

model ConstructionSupplier {
  id        String @id @default(cuid())
  projectId String

  nombre         String
  tipoSuministro String

  contacto String?
  telefono String?
  email    String?

  descripcion  String   @db.Text
  presupuesto  Float
  fechaEntrega DateTime
  entregado    Boolean  @default(false)

  factura String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project ConstructionProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("construction_suppliers")
}

// ==========================================
// MÓDULO: SERVICIOS PROFESIONALES
// ==========================================

model ProfessionalProject {
  id        String @id @default(cuid())
  companyId String

  clienteNombre   String
  clienteEmail    String
  clienteTelefono String?

  tipo        ProjectType
  titulo      String
  descripcion String      @db.Text

  direccion String
  municipio String?
  provincia String?

  honorarios Float
  gastos     Float @default(0)
  total      Float

  fechaInicio  DateTime
  fechaEntrega DateTime

  estado           ProjectProfessionalStatus @default(PROPUESTA)
  porcentajeAvance Int                       @default(0)

  responsable   String
  colaboradores String[] @default([])

  planos       String[] @default([])
  informes     String[] @default([])
  certificados String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  deliverables ProfessionalDeliverable[]
  meetings     ProfessionalMeeting[]

  @@map("professional_projects")
}

model ProfessionalDeliverable {
  id        String @id @default(cuid())
  projectId String

  nombre      String
  descripcion String?
  fechaLimite DateTime

  entregado    Boolean   @default(false)
  fechaEntrega DateTime?

  archivo     String?
  comentarios String? @db.Text

  createdAt DateTime @default(now())

  project ProfessionalProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("professional_deliverables")
}

model ProfessionalMeeting {
  id        String @id @default(cuid())
  projectId String

  titulo   String
  fecha    DateTime
  duracion Int

  ubicacion     String?
  online        Boolean @default(false)
  enlaceReunion String?

  asistentes String[] @default([])

  agenda String? @db.Text
  acta   String? @db.Text

  createdAt DateTime @default(now())

  project ProfessionalProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("professional_meetings")
}

// ========================================
// ROOM RENTAL MODULE - Alquiler por Habitaciones
// ========================================

model Room {
  id        String @id @default(cuid())
  companyId String
  unitId    String

  // Identificación
  numero String
  nombre String?

  // Características
  superficie        Float
  tipoHabitacion    String // individual, doble, suite, estudio
  bajoPrivado       Boolean @default(false)
  balcon            Boolean @default(false)
  escritorio        Boolean @default(false)
  armarioEmpotrado  Boolean @default(false)
  aireAcondicionado Boolean @default(false)
  calefaccion       Boolean @default(false)

  // Mobiliario
  amueblada  Boolean @default(true)
  cama       String? // individual, doble, queen, king
  mesaNoche  Boolean @default(false)
  cajonera   Boolean @default(false)
  estanteria Boolean @default(false)
  silla      Boolean @default(false)

  // Precios y disponibilidad
  precioPorMes    Float
  precioPorSemana Float?
  estado          RoomStatus @default(disponible)

  // Multimedia
  imagenes    String[] @default([])
  descripcion String?  @db.Text

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company   Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  unit      Unit           @relation(fields: [unitId], references: [id], onDelete: Cascade)
  contracts RoomContract[]

  // Coliving
  colivingCheckInOuts ColivingCheckInOut[]
  smartLocks          SmartLock[]

  @@unique([unitId, numero])
  @@map("rooms")
}

model RoomContract {
  id        String @id @default(cuid())
  companyId String
  roomId    String
  tenantId  String

  // Fechas
  fechaInicio DateTime
  fechaFin    DateTime

  // Condiciones económicas
  rentaMensual    Float
  diaPago         Int      @default(1)
  deposito        Float    @default(0)
  gastosIncluidos String[] @default([]) // luz, agua, gas, internet, limpieza

  // Normas específicas de la habitación
  normasConvivencia String? @db.Text
  horariosVisitas   String?
  permiteMascotas   Boolean @default(false)
  permiteFumar      Boolean @default(false)

  // Limpieza de espacios comunes
  frecuenciaLimpieza String? // semanal, quincenal, mensual
  rotacionLimpieza   Json? // {semana1: "tenant1", semana2: "tenant2"}

  // Estado y documentación
  estado       RoomContractStatus @default(activo)
  documentoURL String?
  firmadoFecha DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company  Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  room     Room          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  tenant   Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments RoomPayment[]

  @@map("room_contracts")
}

model RoomPayment {
  id         String @id @default(cuid())
  companyId  String
  contractId String

  // Conceptos
  concepto String   @default("Renta mensual")
  mes      DateTime
  monto    Float

  // Desglose de gastos (prorrateo)
  montoProrrateoLuz      Float?
  montoProrrateoAgua     Float?
  montoProrrateoGas      Float?
  montoProrrateoInternet Float?
  montoProrrateoLimpieza Float?

  // Estado del pago
  estado           PaymentStatus      @default(pendiente)
  fechaVencimiento DateTime
  fechaPago        DateTime?
  metodoPago       RoomPaymentMethod?

  // Metadata
  notas     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company  Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contract RoomContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@map("room_payments")
}

model RoomSharedSpace {
  id        String @id @default(cuid())
  companyId String
  unitId    String

  // Identificación
  nombre String // Cocina, Sala, Baño 1, Baño 2, Terraza
  tipo   String // cocina, salon, bano, terraza, lavanderia, estudio

  // Características
  superficie Float?

  // Equipamiento (cocina)
  nevera       Boolean @default(false)
  horno        Boolean @default(false)
  microondas   Boolean @default(false)
  lavadora     Boolean @default(false)
  secadora     Boolean @default(false)
  lavavajillas Boolean @default(false)

  // Equipamiento (sala)
  television  Boolean @default(false)
  sofa        Boolean @default(false)
  mesaComedor Boolean @default(false)

  // Normas de uso
  normasUso       String? @db.Text
  horarioAcceso   String? // 24h, 8:00-22:00, etc
  capacidadMaxima Int?

  // Multimedia
  imagenes String[] @default([])

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  unit    Unit    @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@map("room_shared_spaces")
}

// ============================================
// SISTEMA MULTI-EMPRESA POR USUARIO
// ============================================

model UserCompanyAccess {
  id        String @id @default(cuid())
  userId    String
  companyId String

  // Permisos específicos en esta empresa
  roleInCompany UserRole @default(gestor)

  // Estado del acceso
  activo Boolean @default(true)

  // Auditoría
  grantedBy  String? // ID del usuario que otorgó el acceso
  grantedAt  DateTime  @default(now())
  lastAccess DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("user_company_access")
}

// ============================================
// INTEGRACIÓN REDES SOCIALES
// ============================================

enum SocialMediaPlatform {
  FACEBOOK
  INSTAGRAM
  TWITTER
  LINKEDIN
  WHATSAPP_BUSINESS
  TIKTOK
}

enum SocialPostStatus {
  borrador
  programado
  publicado
  error
}

model SocialMediaAccount {
  id                String              @id @default(cuid())
  companyId         String
  platform          SocialMediaPlatform
  accountName       String
  accountId         String // ID de la cuenta en la plataforma
  accessToken       String?             @db.Text
  refreshToken      String?             @db.Text
  tokenExpiry       DateTime?
  pageId            String? // Para Facebook Pages
  businessAccountId String? // Para WhatsApp Business
  activo            Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  company Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  posts   SocialMediaPost[]

  @@unique([companyId, platform, accountId])
  @@index([companyId])
  @@map("social_media_accounts")
}

model SocialMediaPost {
  id        String           @id @default(cuid())
  companyId String
  accountId String
  estado    SocialPostStatus @default(borrador)

  // Contenido
  mensaje      String   @db.Text
  imagenesUrls String[] @default([])
  videoUrl     String?
  enlace       String?

  // Programación
  fechaProgramada  DateTime?
  fechaPublicacion DateTime?

  // Resultados
  postId      String? // ID del post en la plataforma
  likes       Int     @default(0)
  comentarios Int     @default(0)
  compartidos Int     @default(0)
  alcance     Int     @default(0)
  impresiones Int     @default(0)

  // Metadata
  creadoPor    String
  errorMessage String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  account SocialMediaAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([accountId])
  @@index([estado])
  @@map("social_media_posts")
}

// ============================================
// SISTEMA DE CUPONES DE DESCUENTO
// ============================================

enum CouponType {
  PERCENTAGE // Porcentaje de descuento
  FIXED // Cantidad fija
}

enum CouponStatus {
  activo
  inactivo
  agotado
  expirado
}

model DiscountCoupon {
  id          String     @id @default(cuid())
  companyId   String
  codigo      String // Código del cupón (ej: "VERANO2024")
  tipo        CouponType
  valor       Float // Porcentaje o monto fijo según tipo
  descripcion String?    @db.Text

  // Límites
  usosMaximos    Int? // Número máximo de usos totales
  usosActuales   Int    @default(0)
  usosPorUsuario Int    @default(1) // Usos permitidos por usuario
  montoMinimo    Float? // Monto mínimo de compra para aplicar

  // Vigencia
  fechaInicio     DateTime
  fechaExpiracion DateTime

  // Restricciones
  aplicaATodos       Boolean  @default(true)
  unidadesPermitidas String[] @default([]) // IDs de unidades específicas
  planesPermitidos   String[] @default([]) // IDs de planes de suscripción

  // Estado
  estado CouponStatus @default(activo)
  activo Boolean      @default(true)

  // Metadata
  creadoPor String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  usos    CouponUsage[]

  @@unique([companyId, codigo])
  @@index([companyId])
  @@index([codigo])
  @@index([estado])
  @@map("discount_coupons")
}

model CouponUsage {
  id         String  @id @default(cuid())
  couponId   String
  userId     String? // Usuario que usó el cupón
  tenantId   String? // Inquilino que usó el cupón
  contractId String? // Contrato asociado
  paymentId  String? // Pago asociado

  montoOriginal  Float
  montoDescuento Float
  montoFinal     Float

  aplicadoEn DateTime @default(now())

  coupon DiscountCoupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([userId])
  @@index([tenantId])
  @@map("coupon_usages")
}

// ============================================
// FACTURACIÓN B2B - INMOVA A EMPRESAS
// ============================================

model B2BInvoice {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // Invoice Data
  numeroFactura    String   @unique // INV-2026-0001
  fechaEmision     DateTime @default(now())
  fechaVencimiento DateTime
  periodo          String // "2026-01", "Q1-2026"

  // Billing Details
  subscriptionPlanId String?
  subscriptionPlan   SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])

  // Amounts
  subtotal  Float
  descuento Float @default(0)
  impuestos Float // IVA 21%
  total     Float

  // Payment
  estado     InvoiceStatus @default(PENDIENTE)
  metodoPago String? // "stripe", "transferencia", "otro"
  fechaPago  DateTime?

  // Stripe Integration
  stripeInvoiceId       String? @unique
  stripePaymentIntentId String?
  stripePdfUrl          String?

  // Details
  conceptos    Json // [{descripcion, cantidad, precioUnitario, total}]
  notas        String?
  terminosPago String? @default("30 días")

  // History
  recordatoriosEnviados Int       @default(0)
  ultimoRecordatorio    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([fechaEmision])
  @@index([estado])
}

enum InvoiceStatus {
  PENDIENTE
  PAGADA
  VENCIDA
  CANCELADA
  PARCIALMENTE_PAGADA
}

model B2BPaymentHistory {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  invoiceId String?

  // Payment Data
  monto      Float
  metodoPago String
  fechaPago  DateTime @default(now())
  referencia String?

  // Stripe Data
  stripePaymentId String? @unique
  stripeChargeId  String?
  stripeFee       Float?
  stripeNetAmount Float?

  // Status
  estado String // "completado", "fallido", "reembolsado"
  notas  String?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([invoiceId])
  @@index([fechaPago])
}

model B2BSubscriptionHistory {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // Subscription Changes
  accion         String // "upgrade", "downgrade", "cancelacion", "reactivacion"
  planAnteriorId String?
  planNuevoId    String?

  // Details
  fechaCambio    DateTime @default(now())
  razon          String?
  costoAdicional Float? // Si aplica upgrade

  // User who made the change
  realizadoPor String? // userId del admin

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([fechaCambio])
}

model B2BFinancialReport {
  id String @id @default(uuid())

  // Period
  periodo     String @unique // "2026-01", "Q1-2026", "2026"
  tipoReporte String // "mensual", "trimestral", "anual"

  // Revenue Metrics
  ingresosBrutos  Float
  descuentosTotal Float
  impuestosTotal  Float
  ingresosNetos   Float

  // Subscription Metrics
  empresasActivas    Int
  empresasNuevas     Int
  empresasCanceladas Int
  tasaRetencion      Float // %

  // Invoice Metrics
  facturasEmitidas Int
  facturasPagadas  Int
  facturasVencidas Int
  ticketPromedio   Float

  // Growth
  crecimientoMoM Float? // Month over Month %
  crecimientoYoY Float? // Year over Year %

  // Data Details
  detalles Json // Breakdown por plan, industria, etc.

  fechaGeneracion DateTime @default(now())

  @@index([periodo])
  @@index([tipoReporte])
}

// ==========================================
// BUZÓN DE SUGERENCIAS
// ==========================================

model Suggestion {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Información de quien envía
  userId          String?
  user            User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  nombreRemitente String
  emailRemitente  String

  // Contenido de la sugerencia
  titulo      String
  descripcion String             @db.Text
  categoria   String // mejora_producto, reporte_bug, nueva_funcionalidad, otro
  prioridad   SuggestionPriority @default(media)

  // Estado y seguimiento
  estado         SuggestionStatus @default(pendiente)
  respuesta      String?          @db.Text
  respondidoPor  String?
  fechaRespuesta DateTime?

  // Metadatos
  navegador        String?
  sistemaOperativo String?
  urlOrigen        String?

  // Votos y valoración (opcional para futuro)
  votos Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([estado])
  @@index([prioridad])
  @@index([categoria])
  @@index([createdAt])
  @@map("suggestions")
}

// ================================
// MODELO CRM - LEADS
// ================================
model Lead {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Información básica
  nombre    String
  apellidos String?
  email     String
  telefono  String?
  empresa   String?
  cargo     String?

  // Datos de contacto adicionales
  direccion    String?
  ciudad       String?
  codigoPostal String?
  pais         String? @default("España")

  // Origen y fuente
  fuente        String // "landing", "chatbot", "formulario_contacto", "referido", "social_media", "otros"
  origenDetalle String? // Información adicional sobre el origen
  paginaOrigen  String? // URL de la página donde se generó el lead

  // Estado del lead
  estado      String @default("nuevo") // "nuevo", "contactado", "calificado", "propuesta", "negociacion", "ganado", "perdido"
  etapa       String @default("contacto_inicial") // Etapa específica del pipeline
  puntuacion  Int    @default(0) // Lead scoring: 0-100
  temperatura String @default("frio") // "frio", "tibio", "caliente"

  // Información de negocio
  tipoNegocio        String? // Tipo de negocio inmobiliario que le interesa
  verticalesInteres  String[] // Array de verticales que le interesan
  numeroUnidades     Int? // Número de propiedades que gestiona o planea gestionar
  presupuestoMensual Float? // Presupuesto mensual estimado
  urgencia           String?  @default("media") // "baja", "media", "alta"

  // Notas y seguimiento
  notas               String?   @db.Text
  motivoPerdida       String? // Si estado = "perdido", razón de la pérdida
  probabilidadCierre  Float? // Probabilidad de conversión (0-100)
  fechaEstimadaCierre DateTime?

  // Asignación
  asignadoA       String?
  asignadoUsuario User?   @relation(fields: [asignadoA], references: [id], onDelete: SetNull)

  // Actividades y seguimiento
  ultimoContacto     DateTime?
  proximoSeguimiento DateTime?
  numeroContactos    Int       @default(0)

  // Información adicional del chatbot
  conversacionId      String? // ID de la conversación del chatbot
  mensajeInicial      String?  @db.Text
  preguntasFrecuentes String[] // Preguntas que hizo durante la conversación

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  actividades LeadActivity[]
  documentos  LeadDocument[]

  @@index([companyId])
  @@index([estado])
  @@index([etapa])
  @@index([fuente])
  @@index([temperatura])
  @@index([asignadoA])
  @@index([email])
  @@index([createdAt])
  @@map("leads")
}

// Actividades del Lead (llamadas, emails, reuniones, etc.)
model LeadActivity {
  id     String @id @default(cuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  tipo        String // "llamada", "email", "reunion", "nota", "whatsapp", "demo"
  titulo      String
  descripcion String? @db.Text
  resultado   String? // Resultado de la actividad
  duracion    Int? // Duración en minutos

  fecha     DateTime @default(now())
  creadoPor String
  usuario   User     @relation(fields: [creadoPor], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@index([tipo])
  @@index([fecha])
  @@map("lead_activities")
}

// Documentos asociados al Lead
model LeadDocument {
  id     String @id @default(cuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  nombre String
  tipo   String // "propuesta", "contrato", "presentacion", "otros"
  url    String
  tamano Int? // Tamaño en bytes

  creadoPor String
  usuario   User   @relation(fields: [creadoPor], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@map("lead_documents")
}

// ===========================
// SISTEMA DE NOTIFICACIONES PUSH
// ===========================

// Suscripciones a notificaciones push

// ============================================
// MODELOS PARA AUTOMATIZACIÓN DE ONBOARDING Y SOPORTE
// ============================================

model OnboardingProgress {
  id             String    @id @default(cuid())
  userId         String
  companyId      String
  vertical       String    @default("residencial") // residencial, vacacional, coliving, comercial, etc.
  currentStep    Int       @default(0)
  totalSteps     Int       @default(0)
  completedSteps Json      @default("[]") // Array de IDs de pasos completados
  startedAt      DateTime  @default(now())
  lastActivityAt DateTime  @default(now())
  completedAt    DateTime?

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}

model SupportTicket {
  id           String    @id @default(cuid())
  userId       String
  companyId    String
  category     String // technical, billing, feature_request, bug_report, question, onboarding
  priority     String // low, medium, high, critical
  status       String    @default("open") // open, in_progress, waiting_user, resolved, closed
  subject      String
  description  String    @db.Text
  tags         Json      @default("[]")
  autoResolved Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  resolvedAt   DateTime?

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  company  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  messages TicketMessage[]

  @@index([userId])
  @@index([companyId])
  @@index([status])
  @@index([category])
  @@index([priority])
}

model TicketMessage {
  id          String   @id @default(cuid())
  ticketId    String
  sender      String // user, system, ai
  message     String   @db.Text
  isAutomatic Boolean  @default(false)
  createdAt   DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

// ============================================================================
// MODELOS PARA INTEGRACION REDSYS PSD2
// ============================================================================

model BankConsent {
  id           String         @id @default(cuid())
  connectionId String
  connection   BankConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  consentId      String  @unique // ID del consentimiento en Redsys
  status         String // received, valid, rejected, expired, revoked, terminated
  scaRedirectUrl String? @db.Text // URL para autenticación fuerte
  validUntil     String? // Fecha de validez del consentimiento (formato ISO)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([status])
}

model BankPayment {
  id           String         @id @default(cuid())
  connectionId String
  connection   BankConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  paymentId      String  @unique // ID del pago en Redsys
  amount         String // Monto del pago
  currency       String // Moneda (EUR, USD, etc.)
  debtorIban     String // IBAN de la cuenta de débito
  creditorIban   String // IBAN de la cuenta de crédito
  creditorName   String // Nombre del beneficiario
  description    String? @db.Text // Descripción del pago
  status         String // ACCP, ACSC, ACSP, ACTC, ACWC, ACWP, RCVD, PDNG, RJCT, CANC
  scaRedirectUrl String? @db.Text // URL para autenticación fuerte

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([status])
}

// ===================================
// PORTAL INQUILINO - MEJORAS CRÍTICAS
// ===================================

// Sistema de Invitaciones para Registro Self-Service
enum InvitationStatus {
  pendiente
  aceptada
  expirada
  cancelada
}

model TenantInvitation {
  id             String           @id @default(cuid())
  companyId      String
  tenantId       String           @unique
  email          String
  invitationCode String           @unique
  status         InvitationStatus @default(pendiente)
  expiresAt      DateTime
  createdBy      String
  createdAt      DateTime         @default(now())
  acceptedAt     DateTime?

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [createdBy], references: [id])

  @@index([companyId])
  @@index([tenantId])
  @@index([invitationCode])
  @@index([email])
  @@index([status])
}

// Recuperación de Contraseña
model PasswordResetToken {
  id        String    @id @default(cuid())
  tenantId  String
  token     String    @unique
  expiresAt DateTime
  used      Boolean   @default(false)
  createdAt DateTime  @default(now())
  usedAt    DateTime?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([token])
  @@index([expiresAt])
}

// Valoraciones del Servicio
enum ServiceRatingType {
  mantenimiento
  atencion_cliente
  plataforma
  comunicacion
  general
}

model ServiceRating {
  id             String            @id @default(cuid())
  companyId      String
  tenantId       String
  tipo           ServiceRatingType
  puntuacion     Int // 1-5 estrellas
  comentario     String?           @db.Text
  visible        Boolean           @default(true)
  respuestaAdmin String?           @db.Text
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([tenantId])
  @@index([tipo])
  @@index([puntuacion])
}

// Onboarding del Inquilino
model TenantOnboarding {
  id          String    @id @default(cuid())
  tenantId    String    @unique
  completed   Boolean   @default(false)
  currentStep Int       @default(0)
  totalSteps  Int       @default(5)
  steps       Json // Array de pasos completados
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([completed])
}

// ========================================
// PORTAL DE PROVEEDORES - MEJORAS
// ========================================

// Recuperación de Contraseña para Proveedores
model ProviderPasswordResetToken {
  id         String    @id @default(cuid())
  providerId String
  token      String    @unique
  expiresAt  DateTime
  used       Boolean   @default(false)
  usedAt     DateTime?
  createdAt  DateTime  @default(now())

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([token])
  @@index([expiresAt])
  @@map("provider_password_reset_tokens")
}

// Gestión de Disponibilidad de Proveedores
model ProviderAvailability {
  id         String @id @default(cuid())
  providerId String
  companyId  String

  // Estado y período
  estado      ProviderAvailabilityStatus @default(disponible)
  fechaInicio DateTime
  fechaFin    DateTime?

  // Detalles
  motivo String? @db.Text
  notas  String? @db.Text

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // ID del usuario que registró

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([companyId])
  @@index([estado])
  @@index([fechaInicio])
  @@index([fechaFin])
  @@map("provider_availability")
}

// Facturas de Proveedores
model ProviderInvoice {
  id          String  @id @default(cuid())
  companyId   String
  providerId  String
  workOrderId String? // Orden de trabajo relacionada

  // Información de la factura
  numeroFactura    String // Número único de factura
  fechaEmision     DateTime @default(now())
  fechaVencimiento DateTime

  // Conceptos y montos
  conceptos Json // Array de {descripcion, cantidad, precioUnitario, total}
  subtotal  Float
  iva       Float @default(21.0) // Porcentaje IVA
  montoIva  Float
  total     Float

  // Estado y tracking
  estado          ProviderInvoiceStatus @default(borrador)
  fechaAprobacion DateTime?
  aprobadoPor     String? // ID del usuario
  fechaPago       DateTime?
  metodoPago      String?
  referenciaago   String?

  // Archivos
  pdfUrl String? // URL del PDF generado

  // Notas
  notas         String? @db.Text
  motivoRechazo String? @db.Text

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  provider  Provider                 @relation(fields: [providerId], references: [id], onDelete: Cascade)
  workOrder ProviderWorkOrder?       @relation(fields: [workOrderId], references: [id], onDelete: SetNull)
  payments  ProviderInvoicePayment[]

  @@unique([companyId, numeroFactura])
  @@index([companyId])
  @@index([providerId])
  @@index([workOrderId])
  @@index([estado])
  @@index([fechaVencimiento])
  @@map("provider_invoices")
}

// Pagos de Facturas de Proveedores
model ProviderInvoicePayment {
  id        String @id @default(cuid())
  invoiceId String
  companyId String

  // Información del pago
  monto      Float
  fechaPago  DateTime @default(now())
  metodoPago String
  referencia String?

  // Notas
  notas String? @db.Text

  // Auditoría
  registradoPor String // ID del usuario
  createdAt     DateTime @default(now())

  invoice ProviderInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  company Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([companyId])
  @@index([fechaPago])
  @@map("provider_invoice_payments")
}

// Presupuestos/Cotizaciones de Proveedores
model ProviderQuote {
  id          String  @id @default(cuid())
  companyId   String
  providerId  String
  workOrderId String?

  // Información del presupuesto
  titulo      String
  descripcion String @db.Text

  // Conceptos y montos
  conceptos Json // Array de {descripcion, cantidad, precioUnitario, total}
  subtotal  Float
  iva       Float @default(21.0)
  montoIva  Float
  total     Float

  // Estado
  estado           String    @default("pendiente") // pendiente, aprobado, rechazado
  fechaVencimiento DateTime?

  // Archivos adjuntos
  archivos String[] // URLs de archivos

  // Notas
  notas         String? @db.Text
  motivoRechazo String? @db.Text

  // Auditoría
  fechaAprobacion DateTime?
  aprobadoPor     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  company   Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  provider  Provider           @relation(fields: [providerId], references: [id], onDelete: Cascade)
  workOrder ProviderWorkOrder? @relation(fields: [workOrderId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([providerId])
  @@index([workOrderId])
  @@index([estado])
  @@map("provider_quotes")
}

// Reviews/Ratings de Proveedores
model ProviderReview {
  id          String  @id @default(cuid())
  companyId   String
  providerId  String
  workOrderId String? // Orden de trabajo relacionada

  // Evaluación
  puntuacion Int // 1-5

  // Categorías de evaluación
  puntualidad     Int? // 1-5
  calidad         Int? // 1-5
  comunicacion    Int? // 1-5
  precio          Int? // 1-5
  profesionalismo Int? // 1-5

  // Comentarios
  comentario        String?  @db.Text
  aspectosPositivos String[] // Array de aspectos destacados
  aspectosMejorar   String[] // Array de aspectos a mejorar

  // Respuesta del proveedor
  respuesta      String?   @db.Text
  fechaRespuesta DateTime?

  // Visibilidad
  visible Boolean @default(true)

  // Auditoría
  evaluadoPor String // ID del usuario que evaluó
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company   Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  provider  Provider           @relation(fields: [providerId], references: [id], onDelete: Cascade)
  workOrder ProviderWorkOrder? @relation(fields: [workOrderId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([providerId])
  @@index([workOrderId])
  @@index([puntuacion])
  @@index([visible])
  @@map("provider_reviews")
}

// Conversaciones de Chat - Proveedor con Gestores
model ProviderChatConversation {
  id         String @id @default(cuid())
  companyId  String
  providerId String

  // Información de la conversación
  asunto String
  estado String @default("activa") // activa, cerrada, archivada

  // Último mensaje para ordenamiento
  ultimoMensaje      String?   @db.Text
  ultimoMensajeFecha DateTime?

  // Contador de mensajes no leídos
  noLeidosProveedor Int @default(0)
  noLeidosGestor    Int @default(0)

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  provider Provider              @relation(fields: [providerId], references: [id], onDelete: Cascade)
  messages ProviderChatMessage[]

  @@index([companyId])
  @@index([providerId])
  @@index([estado])
  @@index([ultimoMensajeFecha])
  @@map("provider_chat_conversations")
}

// Mensajes de Chat - Proveedor con Gestores
model ProviderChatMessage {
  id             String @id @default(cuid())
  conversationId String
  companyId      String

  // Remitente
  remitenteProveedor Boolean // true = proveedor, false = gestor
  remitenteId        String // ID del proveedor o usuario
  remitenteNombre    String

  // Contenido
  mensaje  String   @db.Text
  archivos String[] // URLs de archivos adjuntos

  // Estado
  leido      Boolean   @default(false)
  fechaLeido DateTime?

  // Auditoría
  createdAt DateTime @default(now())

  conversation ProviderChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  company      Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([companyId])
  @@index([leido])
  @@index([createdAt])
  @@map("provider_chat_messages")
}

// ============================================================================
// PORTAL DE PROPIETARIOS - MODELOS DEDICADOS
// ============================================================================

// Propietarios Externos - Acceso dedicado al portal de propietarios
model Owner {
  id        String @id @default(cuid())
  companyId String

  // Información Personal
  nombreCompleto String
  email          String  @unique
  telefono       String?
  dni            String? @unique
  direccion      String?

  // Autenticación (independiente de NextAuth)
  password String // Contraseña hasheada con bcrypt

  // Estado y Configuración
  activo          Boolean @default(true)
  emailVerificado Boolean @default(false)

  // Preferencias de Notificaciones
  notificarPagos         Boolean @default(true)
  notificarOcupacion     Boolean @default(true)
  notificarMantenimiento Boolean @default(true)
  notificarVencimientos  Boolean @default(true)

  // Configuración de Portal
  idioma String  @default("es")
  zona   String? // Zona horaria

  // Seguridad
  lastLogin        DateTime?
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
  loginAttempts    Int       @default(0)
  lockoutUntil     DateTime?

  // Auditoría
  createdAt DateTime @default(now())
  createdBy String? // ID del usuario admin que lo creó
  updatedAt DateTime @updatedAt

  // Relaciones
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  ownerBuildings     OwnerBuilding[] // Edificios asignados
  ownerNotifications OwnerNotification[] // Notificaciones específicas
  ownerAlerts        OwnerAlert[] // Alertas personalizadas

  @@index([companyId])
  @@index([email])
  @@index([activo])
  @@index([companyId, activo])
  @@map("owners")
}

// Relación Many-to-Many entre Propietarios y Edificios
model OwnerBuilding {
  id         String @id @default(cuid())
  ownerId    String
  buildingId String
  companyId  String

  // Porcentaje de Propiedad (para casos de copropiedad)
  porcentajePropiedad Float @default(100) // 0-100

  // Configuración de Acceso
  verIngresos      Boolean @default(true)
  verGastos        Boolean @default(true)
  verOcupacion     Boolean @default(true)
  verMantenimiento Boolean @default(true)
  verDocumentos    Boolean @default(false)

  // Auditoría
  asignadoEn  DateTime @default(now())
  asignadoPor String? // ID del usuario admin

  owner    Owner    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([ownerId, buildingId])
  @@index([ownerId])
  @@index([buildingId])
  @@index([companyId])
  @@map("owner_buildings")
}

// Notificaciones Específicas para Propietarios
model OwnerNotification {
  id        String @id @default(cuid())
  ownerId   String
  companyId String

  // Contenido
  titulo  String
  mensaje String           @db.Text
  tipo    NotificationType

  // Datos Relacionados (opcional)
  buildingId String?
  paymentId  String?
  contractId String?

  // Estado
  leida      Boolean   @default(false)
  fechaLeida DateTime?

  // Auditoría
  createdAt DateTime @default(now())

  owner   Owner   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([ownerId, leida])
  @@index([companyId])
  @@index([createdAt])
  @@map("owner_notifications")
}

// Alertas Personalizadas para Propietarios
model OwnerAlert {
  id         String  @id @default(cuid())
  ownerId    String
  companyId  String
  buildingId String?

  // Configuración de Alerta
  nombre      String
  descripcion String? @db.Text
  tipo        String // 'ocupacion_baja', 'gasto_alto', 'morosidad', 'mantenimiento_pendiente'

  // Umbrales
  umbralValor      Float? // Valor que dispara la alerta
  umbralPorcentaje Float? // Porcentaje que dispara la alerta

  // Estado
  activa           Boolean   @default(true)
  ultimaActivacion DateTime?
  vecesActivada    Int       @default(0)

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner   Owner   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([ownerId, activa])
  @@index([companyId])
  @@index([buildingId])
  @@map("owner_alerts")
}

// =============================================================================
// SISTEMA DE AUTOMATIZACIONES INTELIGENTES
// =============================================================================

// Automatización
model Automation {
  id          String  @id @default(cuid())
  companyId   String
  userId      String? // Usuario que creó la automatización

  // Información Básica
  nombre       String
  descripcion  String?  @db.Text
  tipo         String // 'recordatorio', 'notificacion', 'accion', 'workflow'
  plantillaId  String? // Referencia a plantilla si se usó una

  // Trigger (Disparador)
  triggerType   String // 'fecha', 'evento', 'condicion', 'manual'
  triggerConfig Json   @db.JsonB // Configuración del disparador

  // Condiciones
  condiciones Json? @db.JsonB // Condiciones que deben cumplirse

  // Acciones
  acciones Json @db.JsonB // Acciones a ejecutar

  // Configuración de Ejecución
  activa             Boolean   @default(true)
  prioridad          String    @default("media") // 'baja', 'media', 'alta'
  notificarEjecucion Boolean   @default(false)
  
  // Estadísticas
  vecesEjecutada    Int       @default(0)
  ultimaEjecucion   DateTime?
  proximaEjecucion  DateTime?
  
  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company    Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user       User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  executions AutomationExecution[]

  @@index([companyId, activa])
  @@index([userId])
  @@index([proximaEjecucion])
  @@index([tipo])
  @@map("automations")
}

// Historial de Ejecuciones de Automatizaciones
model AutomationExecution {
  id           String @id @default(cuid())
  automationId String
  companyId    String

  // Resultado de la Ejecución
  estado       String  // 'exitosa', 'fallida', 'parcial'
  mensaje      String?
  detalles     Json?   @db.JsonB // Detalles de la ejecución
  duracion     Int? // Duración en milisegundos

  // Datos del Contexto
  contexto Json? @db.JsonB // Datos del contexto en el momento de la ejecución

  // Auditoría
  ejecutadaEn DateTime @default(now())

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([companyId, ejecutadaEn])
  @@index([estado])
  @@map("automation_executions")
}

// Plantillas de Automatización
model AutomationTemplate {
  id String @id @default(cuid())

  // Información Básica
  nombre       String
  descripcion  String  @db.Text
  categoria    String // 'inquilinos', 'pagos', 'mantenimiento', 'comunicacion', 'reportes'
  icono        String? // Icono para UI
  
  // Configuración
  plantilla    Json    @db.JsonB // Configuración de la plantilla
  parametros   Json?   @db.JsonB // Parámetros configurables
  
  // Disponibilidad
  vertical     String? // Vertical específico o null para todos
  nivelAcceso  String  @default("todos") // 'todos', 'premium', 'enterprise'
  popular      Boolean @default(false)
  
  // Estadísticas
  vecesUsada   Int     @default(0)
  
  // Auditoría
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([categoria])
  @@index([popular])
  @@index([vertical])
  @@map("automation_templates")
}

// ============================================
// SISTEMA DE NOTIFICACIONES AVANZADO - FASE 2
// ============================================

// Reglas de Notificación Automatizadas
model NotificationRule {
  id String @id @default(cuid())

  // Información Básica
  companyId   String
  nombre      String
  descripcion String? @db.Text
  activa      Boolean @default(true)

  // Configuración del Trigger
  tipoEvento    String // 'pago_vencido', 'contrato_expira', 'mantenimiento_urgente', etc.
  condiciones   Json   @db.JsonB // Condiciones que deben cumplirse
  diasAnticipo  Int? // Días de anticipación para notificar (null = inmediato)
  
  // Configuración de Canales
  canales Json @db.JsonB // {email: true, push: false, sms: true}
  
  // Destinatarios
  rolesDestinatarios String[] // ['administrador', 'gestor', 'tenant']
  usuariosEspecificos String[] @default([]) // IDs de usuarios específicos
  
  // Plantilla
  templateId  String?
  asunto      String? // Para email
  mensaje     String  @db.Text // Mensaje con variables
  prioridad   RiskLevel @default(bajo)
  
  // Estadísticas
  vecesEjecutada Int @default(0)
  ultimaEjecucion DateTime?
  
  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  creadoPor String

  company  Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  template NotificationTemplate?     @relation(fields: [templateId], references: [id], onDelete: SetNull)
  logs     NotificationLog[]

  @@index([companyId, activa])
  @@index([tipoEvento])
  @@map("notification_rules")
}

// Plantillas de Notificación
model NotificationTemplate {
  id String @id @default(cuid())

  // Información Básica
  companyId String?  // null = plantilla global del sistema
  nombre    String
  categoria String // 'pagos', 'contratos', 'mantenimiento', 'general'
  
  // Contenido
  asuntoEmail String? // Para notificaciones email
  mensajeEmail String? @db.Text
  mensajePush String?
  mensajeSMS String?
  
  // Variables disponibles
  variables String[] @default([]) // ['nombre_inquilino', 'monto', 'fecha_vencimiento']
  
  // Configuración
  esPlantillaGlobal Boolean @default(false)
  activa Boolean @default(true)
  
  // Estadísticas
  vecesUsada Int @default(0)
  
  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  rules   NotificationRule[]
  logs    NotificationLog[]

  @@index([companyId])
  @@index([categoria])
  @@map("notification_templates")
}

// Log de Notificaciones Enviadas
model NotificationLog {
  id String @id @default(cuid())

  // Referencias
  companyId  String
  userId     String? // Usuario destinatario
  ruleId     String? // Regla que generó la notificación
  templateId String? // Plantilla utilizada
  
  // Información de la Notificación
  tipo       NotificationType
  canal      String // 'email', 'push', 'sms', 'in_app'
  destinatario String // Email, teléfono o userId
  
  // Contenido
  asunto  String?
  mensaje String @db.Text
  
  // Estado
  estado     String // 'enviado', 'fallido', 'leido', 'pendiente'
  intentos   Int @default(1)
  errorMsg   String? @db.Text
  
  // Metadatos
  metadatos Json? @db.JsonB // Datos adicionales del contexto
  costoSMS  Decimal? @db.Decimal(10, 4) // Para SMS
  
  // Interacción
  leida       Boolean @default(false)
  fechaLeida  DateTime?
  accionTomada String? // 'click_cta', 'dismissed', etc.
  
  // Auditoría
  enviadoEn DateTime @default(now())
  
  company  Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user     User?                     @relation(fields: [userId], references: [id], onDelete: SetNull)
  rule     NotificationRule?         @relation(fields: [ruleId], references: [id], onDelete: SetNull)
  template NotificationTemplate?     @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([companyId, enviadoEn])
  @@index([userId, leida])
  @@index([estado])
  @@index([canal])
  @@index([tipo])
  @@map("notification_logs")
}

// Preferencias Avanzadas de Notificación por Usuario
model UserNotificationSettings {
  id     String @id @default(cuid())
  userId String @unique

  // Configuración de Horarios Silenciosos
  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String @default("22:00")
  quietHoursEnd     String @default("08:00")
  
  // Días de no molestar
  quietDays String[] @default([]) // ['sabado', 'domingo']
  
  // Agrupación de Notificaciones
  batchNotifications Boolean @default(false)
  batchInterval      Int     @default(60) // minutos
  
  // Preferencias de Idioma
  language String @default("es")
  
  // Preferencias por Tipo de Notificación (sobrescribe NotificationPreference)
  customRules Json? @db.JsonB // Reglas personalizadas adicionales
  
  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_settings")
}

// Interacciones de Soporte para análisis de chatbot y asistencia
model SupportInteraction {
  id        String   @id @default(cuid())
  userId    String
  type      String   // 'chatbot', 'ticket', 'email', 'phone'
  question  String   @db.Text
  response  String   @db.Text
  confidence Float?
  intent    String?  // 'greeting', 'how_to', 'pricing', 'support', 'knowledge_base'
  sentiment String?  // 'positive', 'neutral', 'negative'
  urgency   String?  // 'low', 'medium', 'high', 'critical'
  resolved  Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([type])
  @@index([sentiment])
  @@index([urgency])
  @@map("support_interactions")
}

// ============================================
// GESTIÓN DE COMUNIDADES - MODELOS ADICIONALES
// ============================================

enum ActaEstado {
  borrador
  aprobada
  rechazada
}

enum CuotaTipo {
  ordinaria
  extraordinaria
  derrama
}

enum FondoTipo {
  reserva
  obras
  contingencia
}

// Libro de actas digital
model CommunityMinute {
  id            String      @id @default(uuid())
  companyId     String
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId    String
  building      Building    @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  
  numeroActa    Int
  fecha         DateTime
  convocatoria  String      @db.Text
  asistentes    Json        // Array de propietarios presentes
  ordenDia      Json        // Array de puntos del orden del día
  acuerdos      Json        // Array de acuerdos alcanzados
  estado        ActaEstado  @default(borrador)
  
  // Adjuntos y firmas simuladas
  documentos    Json?       // Array de URLs de documentos adjuntos
  firmasDigitales Json?     // Simulación de firmas (no real)
  
  creadoPor     String
  aprobadoPor   String?
  fechaAprobacion DateTime?
  observaciones String?     @db.Text
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@unique([companyId, buildingId, numeroActa])
  @@index([companyId, buildingId])
  @@index([fecha])
  @@map("community_minutes")
}

// Gestión de cuotas de comunidad
model CommunityFee {
  id            String      @id @default(uuid())
  companyId     String
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId    String
  building      Building    @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unitId        String?
  unit          Unit?       @relation(fields: [unitId], references: [id], onDelete: SetNull)
  
  tipo          CuotaTipo
  periodo       String      // "2024-Q1", "2024-01", etc
  concepto      String
  importeBase   Float
  coeficiente   Float       @default(1.0) // Coeficiente de participación
  importeTotal  Float
  
  fechaVencimiento DateTime
  fechaPago     DateTime?
  estado        PaymentStatus @default(pendiente)
  metodoPago    String?
  referenciaPago String?
  
  // Desglose de la cuota
  gastosCorrientes Float @default(0)
  fondoReserva    Float @default(0)
  seguros         Float @default(0)
  mantenimiento   Float @default(0)
  otros           Float @default(0)
  
  notas         String?     @db.Text
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([companyId, buildingId])
  @@index([unitId])
  @@index([periodo, estado])
  @@map("community_fees")
}

// Fondos de reserva y derramas
model CommunityFund {
  id            String      @id @default(uuid())
  companyId     String
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId    String
  building      Building    @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  
  tipo          FondoTipo
  nombre        String
  descripcion   String?     @db.Text
  
  saldoActual   Float       @default(0)
  saldoObjetivo Float?
  
  // Movimientos y contribuciones
  aportacionMensual Float   @default(0)
  totalAportaciones Float   @default(0)
  totalGastos       Float   @default(0)
  
  movimientos   Json        // Array de movimientos del fondo
  
  fechaCreacion DateTime    @default(now())
  activo        Boolean     @default(true)
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([companyId, buildingId])
  @@index([tipo, activo])
  @@map("community_funds")
}

// Alertas financieras y contables
model FinancialAlert {
  id            String      @id @default(uuid())
  companyId     String
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId    String?
  building      Building?   @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  
  tipo          String      // 'cash_flow', 'descuadre', 'impago', 'fianza'
  titulo        String
  descripcion   String      @db.Text
  severidad     RiskLevel
  
  monto         Float?
  fechaDeteccion DateTime   @default(now())
  fechaResolucion DateTime?
  
  estado        String      @default("pendiente") // pendiente, revisando, resuelto
  responsable   String?
  accionTomada  String?     @db.Text
  
  metadata      Json?       // Datos adicionales
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([companyId, tipo, estado])
  @@index([severidad, fechaDeteccion])
  @@map("financial_alerts")
}

// Previsión de cash flow
model CashFlowForecast {
  id            String      @id @default(uuid())
  companyId     String
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId    String?
  building      Building?   @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  
  mes           String      // "2024-06"
  
  // Ingresos previstos
  ingresosPrevistos    Float @default(0)
  ingresosRecurrentes  Float @default(0)
  ingresosVariables    Float @default(0)
  
  // Gastos previstos
  gastosPrevistos      Float @default(0)
  gastosRecurrentes    Float @default(0)
  gastosVariables      Float @default(0)
  
  // Resultado
  saldoFinal           Float @default(0)
  confianza            Float @default(0.8) // 0-1
  
  // Escenarios
  escenarioOptimista   Float @default(0)
  escenarioPesimista   Float @default(0)
  
  calculadoEn          DateTime @default(now())
  basadoEnDatos        Json?   // Fuentes de datos utilizadas
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@unique([companyId, buildingId, mes])
  @@index([companyId, mes])
  @@map("cash_flow_forecasts")
}

// Gestión de fianzas
model DepositManagement {
  id            String      @id @default(uuid())
  companyId     String
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contractId    String      @unique
  contract      Contract    @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  importeFianza         Float
  tipoFianza            String // 'legal', 'adicional', 'aval'
  
  // Depósito legal
  depositadoOficialmente Boolean @default(false)
  entidadDeposito        String?
  numeroDeposito         String?
  fechaDeposito          DateTime?
  
  // Devolución
  devuelto              Boolean @default(false)
  importeDevuelto       Float?
  deducciones           Float   @default(0)
  motivoDeducciones     String? @db.Text
  fechaDevolucion       DateTime?
  
  documentos            Json?   // URLs de documentos
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([companyId])
  @@index([depositadoOficialmente, devuelto])
  @@map("deposit_management")
}

// Provisión de impagos
model BadDebtProvision {
  id            String      @id @default(uuid())
  companyId     String
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  paymentId     String      @unique
  payment       Payment     @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  
  montoOriginal         Float
  diasRetraso           Int
  categoriaRiesgo       RiskLevel
  
  // Provisión automática según antigüedad
  porcentajeProvision   Float // 0-100
  montoProvision        Float
  
  // Seguimiento
  gestionado            Boolean @default(false)
  recuperado            Boolean @default(false)
  montoRecuperado       Float   @default(0)
  fechaRecuperacion     DateTime?
  
  metodosGestion        Json?   // Array de acciones tomadas
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([companyId, categoriaRiesgo])
  @@index([gestionado, recuperado])
  @@map("bad_debt_provisions")
}

// Cédulas de habitabilidad
model HabitabilityCertificate {
  id                String      @id @default(uuid())
  companyId         String
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  unitId            String
  unit              Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  numeroCedula      String
  tipo              String      // 'primera_ocupacion', 'segunda_ocupacion'
  estado            String      // 'vigente', 'vencida', 'renovacion_pendiente'
  
  fechaEmision      DateTime
  fechaVencimiento  DateTime?
  vigenciaIndefinida Boolean   @default(false)
  
  superficieUtil    Float?
  numeroHabitaciones Int?
  
  organismoExpedidor String
  registroNumero    String?
  
  documentoURL      String?
  documentoStorage  String?
  
  alertaEnviada     Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([unitId, numeroCedula])
  @@index([companyId, estado])
  @@index([fechaVencimiento, alertaEnviada])
  @@map("habitability_certificates")
}

// Modelo 347 - Declaración anual de operaciones
model Modelo347Record {
  id                String      @id @default(uuid())
  companyId         String
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  ejercicio         Int         // Año fiscal
  trimestre         Int?        // 1-4, null para anual
  
  // Datos de la operación
  nifDeclarante     String
  razonSocialDeclarante String
  
  nifDeclarado      String
  razonSocialDeclarado String
  tipoOperacion     String      // 'A' compras, 'B' ventas
  
  importeAnual      Float
  importeTrimestre1 Float       @default(0)
  importeTrimestre2 Float       @default(0)
  importeTrimestre3 Float       @default(0)
  importeTrimestre4 Float       @default(0)
  
  // Metadata
  generadoAutomaticamente Boolean @default(true)
  revisado              Boolean @default(false)
  revisadoPor           String?
  fechaRevision         DateTime?
  
  // Presentación
  presentado            Boolean @default(false)
  fechaPresentacion     DateTime?
  numeroJustificante    String?
  
  archivoGenerado       String? // Path del fichero generado
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@unique([companyId, ejercicio, nifDeclarado])
  @@index([companyId, ejercicio])
  @@index([presentado])
  @@map("modelo_347_records")
}

// Modelo 180 - Retenciones e ingresos a cuenta
model Modelo180Record {
  id                String      @id @default(uuid())
  companyId         String
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  ejercicio         Int
  trimestre         Int         // 1-4
  
  // Arrendador (propietario)
  nifArrendador     String
  nombreArrendador  String
  
  // Arrendatario (inquilino)
  nifArrendatario   String
  nombreArrendatario String
  
  // Importes
  baseImponible     Float
  tipoRetencion     Float       // Porcentaje (19%, 24%, etc)
  importeRetenido   Float
  
  // Inmueble
  situacionInmueble String      // Provincia/municipio
  referencialCatastral String?
  
  // Procesamiento
  incluidoDeclaracion Boolean   @default(false)
  revisado            Boolean   @default(false)
  
  presentado          Boolean   @default(false)
  fechaPresentacion   DateTime?
  numeroJustificante  String?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([companyId, ejercicio, trimestre, nifArrendatario])
  @@index([companyId, ejercicio, trimestre])
  @@index([presentado])
  @@map("modelo_180_records")
}


// Inspecciones Técnicas de Edificios (ITE)
model BuildingInspection {
  id                String      @id @default(uuid())
  companyId         String
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId        String
  building          Building    @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  
  tipo              String      // 'ITE', 'IEE', 'ITEEVA'
  estado            String      // 'vigente', 'vencida', 'pendiente'
  
  fechaInspeccion   DateTime
  fechaVencimiento  DateTime
  proximaInspeccion DateTime?
  
  resultado         String      // 'favorable', 'desfavorable', 'condicionado'
  
  tecnicoNombre     String
  tecnicoColegio    String
  numeroRegistro    String?
  
  deficienciasEncontradas Json? // Array de deficiencias
  accionesRequeridas     Json? // Array de acciones correctivas
  
  certificadoURL    String?
  documentos        Json?     // URLs de documentos adjuntos
  
  alertasEnviadas   Boolean   @default(false)
  recordatorios     Json?     // Array de recordatorios enviados
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([companyId, buildingId])
  @@index([fechaVencimiento, estado])
  @@index([alertasEnviadas])
  @@map("building_inspections")
}



// ============================================
// ADMINISTRADOR DE FINCAS (Community Property Manager)
// ============================================

enum TipoMovimientoCaja {
  ingreso
  gasto
  traspaso
}

enum EstadoFacturaComunidad {
  borrador
  emitida
  pagada
  vencida
  cancelada
}

enum TipoInformeComunidad {
  trimestral
  anual
  extraordinario
}

// Comunidades gestionadas por el administrador
model CommunityManagement {
  id                    String   @id @default(uuid())
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId            String   @unique
  building              Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  
  // Datos de la comunidad
  nombreComunidad       String
  cif                   String?
  direccion             String
  codigoPostal          String?
  ciudad                String?
  provincia             String?
  
  // Configuración de honorarios
  honorariosFijos       Float?   // € mensuales
  honorariosPorcentaje  Float?   // % sobre presupuesto
  
  // Estado
  activa                Boolean  @default(true)
  fechaInicio           DateTime @default(now())
  fechaFin              DateTime?
  
  // Relaciones
  facturas              CommunityInvoice[]
  movimientosCaja       CashBookEntry[]
  informes              CommunityReport[]
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([companyId])
  @@index([buildingId])
  @@map("community_management")
}

// Facturación por comunidad
model CommunityInvoice {
  id                    String   @id @default(uuid())
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  communityId           String
  community             CommunityManagement @relation(fields: [communityId], references: [id], onDelete: Cascade)
  
  // Datos de la factura
  numeroFactura         String   @unique
  fechaEmision          DateTime @default(now())
  fechaVencimiento      DateTime
  periodo               String   // "2024-Q1", "2024-12", etc
  
  // Conceptos
  honorarios            Float    @default(0)
  gastosGestion         Float    @default(0)
  otrosConceptos        Json?    // Array de conceptos adicionales
  
  // Importes
  baseImponible         Float
  iva                   Float
  totalFactura          Float
  
  // Estado
  estado                EstadoFacturaComunidad @default(borrador)
  fechaPago             DateTime?
  metodoPago            String?
  
  // Documento
  documentoUrl          String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([companyId])
  @@index([communityId])
  @@index([numeroFactura])
  @@index([estado])
  @@map("community_invoices")
}

// Libro de caja digital por comunidad
model CashBookEntry {
  id                    String   @id @default(uuid())
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  communityId           String
  community             CommunityManagement @relation(fields: [communityId], references: [id], onDelete: Cascade)
  
  // Datos del movimiento
  fecha                 DateTime @default(now())
  tipo                  TipoMovimientoCaja
  concepto              String
  descripcion           String?
  
  // Importes
  importe               Float
  saldoAnterior         Float
  saldoActual           Float
  
  // Categorización
  categoria             String   // cuotas, reparaciones, suministros, honorarios, etc
  subcategoria          String?
  
  // Referencias
  facturaId             String?  // Referencia a factura si aplica
  pagoId                String?  // Referencia a pago si aplica
  
  // Documento justificativo
  documentoUrl          String?
  
  // Usuario que registra
  registradoPor         String
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([companyId])
  @@index([communityId])
  @@index([fecha])
  @@index([tipo])
  @@index([categoria])
  @@map("cash_book_entries")
}

// Informes trimestrales/anuales
model CommunityReport {
  id                    String   @id @default(uuid())
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  communityId           String
  community             CommunityManagement @relation(fields: [communityId], references: [id], onDelete: Cascade)
  
  // Tipo y período
  tipo                  TipoInformeComunidad
  periodo               String   // "2024-Q1", "2024", etc
  fechaInicio           DateTime
  fechaFin              DateTime
  
  // Resumen financiero
  totalIngresos         Float    @default(0)
  totalGastos           Float    @default(0)
  saldoInicial          Float    @default(0)
  saldoFinal            Float    @default(0)
  
  // Desglose
  detalleIngresos       Json?    // Desglose de ingresos por categoría
  detalleGastos         Json?    // Desglose de gastos por categoría
  
  // Datos adicionales
  morosos               Json?    // Lista de morosos y deudas
  fondosReserva         Float    @default(0)
  observaciones         String?
  
  // Documento generado
  documentoUrl          String?
  generadoEn            DateTime @default(now())
  generadoPor           String
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([companyId])
  @@index([communityId])
  @@index([tipo])
  @@index([periodo])
  @@map("community_reports")
}
// ========================================
// 🏘️ COLIVING - RED SOCIAL Y COMUNIDAD
// ========================================

model ColivingProfile {
  id                String   @id @default(cuid())
  tenantId          String   @unique
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Información del perfil
  bio               String?  @db.Text
  intereses         Json     // array de strings: ["yoga", "networking", "cocina"]
  profesion         String?
  idiomas           Json     // array de strings: ["es", "en", "fr"]
  redesSociales     Json?    // {instagram: "@user", linkedin: "profile"}
  
  // Preferencias de matching
  buscoCompañeros   Boolean  @default(true)
  interesCompartir  Json     // array: ["coche", "recetas", "eventos"]
  disponibilidad    Json     // {lunes: ["18:00-21:00"], martes: ["19:00-22:00"]}
  
  // Gamificación
  puntosReputacion  Int      @default(0)
  nivel             String   @default("bronce") // bronce, plata, oro, platino
  badges            Json     @default("[]") // array de badges ganados
  
  // Privacidad
  perfilPublico     Boolean  @default(true)
  mostrarContacto   Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  matches           ColivingMatch[]
  gruposParticipa   ColivingGroupMember[]
  actividades       ColivingActivityPost[]
  eventosAsiste     ColivingEventAttendance[]

  @@index([companyId])
  @@index([tenantId])
}

model ColivingMatch {
  id              String   @id @default(cuid())
  profile1Id      String
  profile1        ColivingProfile @relation(fields: [profile1Id], references: [id], onDelete: Cascade)
  profile2Id      String
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  scoreCompatibilidad Int  // 0-100
  interesesComunes    Json // array de intereses compartidos
  estado              String @default("sugerido") // sugerido, aceptado, rechazado
  mensajeIntroduccion String? @db.Text
  
  fechaMatch      DateTime @default(now())
  fechaAceptacion DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([profile1Id])
  @@index([companyId])
  @@unique([profile1Id, profile2Id])
}

model ColivingGroup {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId  String?
  building    Building? @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  
  nombre      String
  descripcion String   @db.Text
  categoria   String   // yoga, networking, cocina, deportes, cultura, etc.
  icono       String?  // emoji o nombre de icono
  imagen      String?  // URL de imagen del grupo
  
  esPublico   Boolean  @default(true)
  maxMiembros Int?     // límite de miembros
  reglas      String?  @db.Text
  
  adminId     String   // tenant que administra
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  miembros    ColivingGroupMember[]
  eventos     ColivingEvent[]

  @@index([companyId])
  @@index([buildingId])
}

model ColivingGroupMember {
  id        String   @id @default(cuid())
  groupId   String
  group     ColivingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  profileId String
  profile   ColivingProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  rol       String   @default("miembro") // admin, moderador, miembro
  fechaUnion DateTime @default(now())
  activo    Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([groupId])
  @@index([profileId])
  @@unique([groupId, profileId])
}

model ColivingActivityPost {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId  String?
  building    Building? @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  profileId   String
  profile     ColivingProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  tipo        String   // post, evento, pregunta, logro
  contenido   String   @db.Text
  imagenes    Json?    // array de URLs
  hashtags    Json?    // array de strings
  
  likes       Json     @default("[]") // array de tenantIds
  comentarios Json     @default("[]") // array de {tenantId, texto, fecha}
  
  visibilidad String   @default("comunidad") // comunidad, edificio, publico
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([buildingId])
  @@index([profileId])
}

model ColivingEvent {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId  String?
  building    Building? @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  groupId     String?
  group       ColivingGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  
  titulo      String
  descripcion String   @db.Text
  tipo        String   // social, deportivo, cultural, networking
  fecha       DateTime
  duracion    Int      // minutos
  ubicacion   String
  capacidad   Int?
  
  requiereInscripcion Boolean @default(false)
  costo       Float?   @default(0)
  organizador String   // tenantId
  
  imagen      String?
  etiquetas   Json?    // array de strings
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  asistentes  ColivingEventAttendance[]

  @@index([companyId])
  @@index([buildingId])
  @@index([groupId])
}

model ColivingEventAttendance {
  id        String   @id @default(cuid())
  eventId   String
  event     ColivingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  profileId String
  profile   ColivingProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  estado    String   @default("confirmado") // confirmado, pendiente, cancelado
  notas     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId])
  @@index([profileId])
  @@unique([eventId, profileId])
}

// ========================================
// 🛎️ COLIVING - SERVICIOS PREMIUM
// ========================================

model ColivingService {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  nombre      String
  descripcion String   @db.Text
  categoria   String   // limpieza, lavanderia, chef, trainer, masajes, etc.
  icono       String?
  
  precioBase  Float
  unidad      String   // por hora, por servicio, por día
  duracion    Int?     // minutos si aplica
  
  disponible  Boolean  @default(true)
  proveedorExterno String? // nombre del proveedor
  contactoProveedor String?
  
  imagenes    Json?    // array de URLs
  requisitos  String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  reservas    ColivingServiceBooking[]

  @@index([companyId])
  @@index([categoria])
}

model ColivingServiceBooking {
  id          String   @id @default(cuid())
  serviceId   String
  service     ColivingService @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  fechaServicio DateTime
  horaInicio  String   // "14:00"
  duracion    Int      // minutos
  
  ubicacion   String   // número de habitación/unidad
  estado      String   @default("pendiente") // pendiente, confirmado, en_progreso, completado, cancelado
  
  precioTotal Float
  notas       String?  @db.Text
  instruccionesEspeciales String? @db.Text
  
  valoracion  Int?     // 1-5 estrellas
  comentario  String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([serviceId])
  @@index([tenantId])
  @@index([companyId])
  @@index([fechaServicio])
}

model ColivingCheckInOut {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  unitId      String
  unit        Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  roomId      String?
  room        Room?    @relation(fields: [roomId], references: [id], onDelete: SetNull)
  
  tipo        String   // check_in, check_out
  metodo      String   // digital, presencial, automatico
  
  fechaProgramada DateTime
  fechaReal   DateTime?
  
  estado      String   @default("pendiente") // pendiente, completado, cancelado
  
  // Check-in digital
  documentosVerificados Boolean @default(false)
  firmaDigital String?  // URL del documento firmado
  codigoAcceso String?  // código temporal para SmartLock
  
  // Inventario
  inventarioEntrada Json? // estado de la habitación al entrar
  inventarioSalida  Json? // estado de la habitación al salir
  fotosEntrada      Json? // array de URLs
  fotosSalida       Json? // array de URLs
  
  // Llaves
  llaveDigitalEnviada Boolean @default(false)
  llaveDigitalActiva  Boolean @default(false)
  
  notas       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([companyId])
  @@index([unitId])
  @@index([roomId])
}

model SmartLock {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId  String
  building    Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unitId      String?
  unit        Unit?    @relation(fields: [unitId], references: [id], onDelete: SetNull)
  roomId      String?
  room        Room?    @relation(fields: [roomId], references: [id], onDelete: SetNull)
  
  nombre      String   // "Habitación 101 - Puerta Principal"
  ubicacion   String
  
  // Integración API
  marca       String   // August, Yale, Schlage, TTLock, etc.
  modelo      String
  numeroSerie String   @unique
  apiEndpoint String?
  apiKey      String?  // encriptada
  
  // Estado
  estado      String   @default("activo") // activo, inactivo, mantenimiento
  bateria     Int?     // porcentaje
  conectado   Boolean  @default(true)
  ultimaConexion DateTime?
  
  // Configuración
  modoAcceso  String   @default("codigo") // codigo, tarjeta, biometrico, app
  autoBloqueo Boolean  @default(true)
  tiempoAutoBloqueo Int @default(30) // segundos
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  accesos     SmartLockAccess[]

  @@index([companyId])
  @@index([buildingId])
  @@index([unitId])
  @@index([roomId])
}

model SmartLockAccess {
  id          String   @id @default(cuid())
  lockId      String
  lock        SmartLock @relation(fields: [lockId], references: [id], onDelete: Cascade)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  tipoAcceso  String   // permanente, temporal, invitado
  codigoAcceso String? // código PIN o token
  
  fechaInicio DateTime
  fechaFin    DateTime?
  
  activo      Boolean  @default(true)
  usosPermitidos Int?  // null = ilimitado
  usosRealizados Int   @default(0)
  
  // Log de accesos
  ultimoAcceso DateTime?
  historialAccesos Json @default("[]") // array de {fecha, exito, metodo}
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([lockId])
  @@index([tenantId])
}

model ColivingPackage {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  buildingId  String
  building    Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  
  numeroSeguimiento String?
  remitente   String
  empresa     String?  // compañía de envío
  
  fechaLlegada DateTime @default(now())
  fechaRecogida DateTime?
  
  estado      String   @default("pendiente") // pendiente, notificado, recogido
  ubicacionAlmacen String? // donde está guardado
  
  tamano      String?  // pequeño, mediano, grande
  requiereRefrigeracion Boolean @default(false)
  requiereFirma Boolean @default(false)
  
  fotoComprobante String? // URL
  notificado  Boolean  @default(false)
  
  notas       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([companyId])
  @@index([buildingId])
  @@index([estado])
}

// ============================================
// SISTEMA DE PARTNERS B2B
// ============================================

model Partner {
  id          String   @id @default(cuid())
  
  // Información básica
  nombre      String
  razonSocial String
  cif         String   @unique
  tipo        PartnerType @default(BANCO) // BANCO, MULTIFAMILY_OFFICE, PLATAFORMA_MEMBRESIA, etc.
  
  // Contacto principal
  contactoNombre String
  contactoEmail String @unique
  contactoTelefono String?
  
  // Autenticación
  email       String   @unique
  password    String   // hasheado
  
  // Personalización White Label
  logo        String?
  coloresPrimarios Json? // {primary, secondary, accent}
  dominioPersonalizado String? @unique
  
  // Comisiones
  comisionPorcentaje Float @default(20.0) // 20% por defecto
  umbralComision Int @default(1) // clientes necesarios para tier
  
  // Estado
  estado      PartnerStatus @default(PENDING) // PENDING, ACTIVE, SUSPENDED
  activo      Boolean  @default(true)
  fechaActivacion DateTime?
  
  // Configuración
  config      Json @default("{}") // configuraciones adicionales
  notas       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relaciones
  clientes    PartnerClient[]
  invitaciones PartnerInvitation[]
  comisiones  Commission[]

  @@index([email])
  @@index([estado])
  @@index([tipo])
}

model PartnerClient {
  id          String   @id @default(cuid())
  
  partnerId   String
  partner     Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Estado
  estado      String   @default("activo") // activo, suspendido, cancelado
  fechaActivacion DateTime @default(now())
  fechaCancelacion DateTime?
  
  // Tracking
  origenInvitacion String? // email, landing, directo
  codigoReferido String?  // código único de referencia
  
  // Comisiones generadas
  totalComisionGenerada Float @default(0)
  ultimaComisionFecha DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([partnerId, companyId])
  @@index([partnerId])
  @@index([companyId])
  @@index([estado])
}

model Commission {
  id          String   @id @default(cuid())
  
  partnerId   String
  partner     Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  
  // Detalles de la comisión
  periodo     String   // "2025-12" formato año-mes
  montoBruto  Float    // precio total del cliente
  porcentaje  Float    // % de comisión aplicado
  montoComision Float  // cantidad para el partner
  
  // Suscripción relacionada
  planId      String?
  planNombre  String?
  
  // Estado
  estado      CommissionStatus @default(PENDING) // PENDING, APPROVED, PAID
  fechaAprobacion DateTime?
  fechaPago   DateTime?
  referenciaPago String?
  
  // Metadata
  clientesActivos Int
  notas       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([partnerId, companyId, periodo])
  @@index([partnerId])
  @@index([companyId])
  @@index([periodo])
  @@index([estado])
}

model PartnerInvitation {
  id          String   @id @default(cuid())
  
  partnerId   String
  partner     Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  // Destinatario
  email       String
  nombre      String?
  telefono    String?
  
  // Invitación
  token       String   @unique
  mensaje     String?  @db.Text
  
  // Estado
  estado      PartnerInvitationStatus @default(PENDING) // PENDING, ACCEPTED, EXPIRED, CANCELLED
  enviadoFecha DateTime @default(now())
  aceptadoFecha DateTime?
  expiraFecha DateTime // típicamente +30 días
  
  // Resultado
  companyId   String?  // ID de la company creada si aceptó
  
  // Metadata
  metadata    Json @default("{}") // info adicional
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([partnerId])
  @@index([email])
  @@index([token])
  @@index([estado])
}

// Enums para Partners
enum PartnerType {
  BANCO
  MULTIFAMILY_OFFICE
  PLATAFORMA_MEMBRESIA
  ASOCIACION
  CONSULTORA
  INMOBILIARIA
  OTRO
}

enum PartnerStatus {
  PENDING     // En revisión
  ACTIVE      // Activo y operando
  SUSPENDED   // Suspendido temporalmente
  CANCELLED   // Cancelado permanentemente
}

enum CommissionStatus {
  PENDING     // Pendiente de aprobación
  APPROVED    // Aprobada, pendiente de pago
  PAID        // Pagada
  CANCELLED   // Cancelada
}

enum PartnerInvitationStatus {
  PENDING     // Enviada, esperando respuesta
  ACCEPTED    // Aceptada por el cliente
  EXPIRED     // Expirada sin respuesta
  CANCELLED   // Cancelada por el partner
}

// ====================================
// EQUIPO COMERCIAL EXTERNO
// ====================================

enum SalesRepStatus {
  ACTIVO       // Comercial activo
  INACTIVO     // Temporalmente inactivo
  SUSPENDIDO   // Suspendido por incumplimiento
  CANCELADO    // Dado de baja definitivamente
}

enum LeadStatus {
  NUEVO          // Lead recién captado
  CONTACTADO     // Contacto inicial realizado
  CALIFICADO     // Lead calificado (interés confirmado)
  DEMO           // Demo programada/realizada
  PROPUESTA      // Propuesta enviada
  NEGOCIACION    // En negociación
  CERRADO_GANADO // Cliente conseguido
  CERRADO_PERDIDO // Lead perdido
  DESCARTADO     // Lead descartado (no califica)
}

enum SalesCommissionType {
  CAPTACION      // Comisión por captación inicial
  RECURRENTE     // Comisión recurrente mensual
  REACTIVACION   // Comisión por reactivación de cliente
  BONIFICACION   // Bonificación por objetivos
  NIVEL2         // Comisión de nivel 2 (por sub-afiliados)
}

enum SalesCommissionStatus {
  PENDIENTE      // Pendiente de aprobación
  APROBADA       // Aprobada, pendiente de pago
  PAGADA         // Pagada al comercial
  CANCELADA      // Cancelada
  RETENIDA       // Retenida por verificación
}

// Comercial Externo (Autónomo/Freelance)
model SalesRepresentative {
  id          String   @id @default(cuid())
  
  // Información personal
  nombre      String
  apellidos   String
  nombreCompleto String // nombre + apellidos concatenado
  dni         String   @unique
  email       String   @unique
  telefono    String
  telefonoSecundario String?
  
  // Datos fiscales
  numeroAutonomo String?  // Nº seguridad social autónomo
  iban        String?     // Para pagos
  direccion   String?
  ciudad      String?
  codigoPostal String?
  pais        String @default("España")
  
  // Configuración comercial
  codigoReferido String  @unique // Código único para tracking (ej: "COM-JUAN-2024")
  comisionCaptacion Float @default(150.0) // Comisión fija por captación exitosa (€)
  comisionRecurrente Float @default(10.0) // % comisión recurrente mensual
  bonificacionObjetivo Float @default(500.0) // Bonificación por cumplir objetivos mensuales
  
  // Objetivos mensuales
  objetivoLeadsMes Int @default(10) // Leads esperados al mes
  objetivoConversionesMes Int @default(2) // Conversiones esperadas al mes
  
  // Autenticación (para portal comercial)
  password    String  // hasheado
  ultimoAcceso DateTime?
  
  // Estado y tracking
  estado      SalesRepStatus @default(ACTIVO)
  activo      Boolean  @default(true)
  fechaAlta   DateTime @default(now())
  fechaBaja   DateTime?
  motivoBaja  String?  @db.Text
  
  // Métricas acumuladas
  totalLeadsGenerados Int @default(0)
  totalConversiones Int @default(0)
  totalComisionGenerada Float @default(0)
  tasaConversion Float @default(0) // Calculado automáticamente
  
  // Notas internas
  notas       String?  @db.Text
  documentacion String? @db.Text // URLs de documentos escaneados
  
  // API Keys y configuración avanzada (Fase 2 Partners)
  apiKey      String?  @unique
  apiSecret   String?  // Hash del secret
  apiEnabled  Boolean  @default(false)
  
  // White Label (Fase 2 Partners)
  whiteLabelEnabled Boolean @default(false)
  whiteLabelConfig  Json?  // Configuración de branding personalizado
  
  // Sistema de afiliados nivel 2 (Fase 3 Partners)
  nivel            Int @default(1) // 1=partner principal, 2=sub-afiliado
  parentSalesRepId String?
  parentSalesRep   SalesRepresentative? @relation("SubAffiliates", fields: [parentSalesRepId], references: [id])
  subAffiliates    SalesRepresentative[] @relation("SubAffiliates")
  
  // Relaciones
  leads       SalesLead[]
  comisiones  SalesCommission[]
  objetivos   SalesTarget[]
  certificationsAwarded PartnerCertificationAwarded[]
  materialsDownloaded   MaterialDownload[]
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Company asignada (para multi-tenancy interno)
  companyId   String   @default("global") // "global" para comerciales que trabajan para INMOVA directamente
  
  @@index([email])
  @@index([estado])
  @@index([codigoReferido])
  @@index([activo])
  @@index([apiKey])
  @@index([parentSalesRepId])
}

// Lead captado por comercial
model SalesLead {
  id          String   @id @default(cuid())
  
  // Comercial responsable
  salesRepId  String
  salesRep    SalesRepresentative @relation(fields: [salesRepId], references: [id], onDelete: Cascade)
  
  // Información del lead
  nombreContacto String
  emailContacto String
  telefonoContacto String?
  nombreEmpresa String
  sector      String?      // Sector inmobiliario
  tipoCliente String?      // "alquiler_tradicional", "coliving", "str", etc.
  
  // Tamaño del cliente potencial
  propiedadesEstimadas Int? // Número estimado de propiedades
  presupuestoMensual Float? // Presupuesto mensual estimado
  
  // Estado del lead
  estado      LeadStatus @default(NUEVO)
  prioridad   String @default("media") // baja, media, alta
  probabilidadCierre Int @default(50) // 0-100%
  
  // Tracking de seguimiento
  fechaCaptura DateTime @default(now())
  fechaPrimerContacto DateTime?
  fechaUltimoContacto DateTime?
  proximoSeguimiento DateTime?
  
  // Fuente del lead
  origenCaptura String? // "linkedin", "evento", "referido", "cold_call", etc.
  codigoRastreo String? // Código de tracking de campaña
  
  // Interacciones
  numeroLlamadas Int @default(0)
  numeroEmails Int @default(0)
  numeroReuniones Int @default(0)
  
  // Conversión
  convertido  Boolean @default(false)
  fechaConversion DateTime?
  companyId   String? // ID de la company creada si se convirtió
  company     Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  
  // Plan suscrito (si se convirtió)
  planSuscrito String? // Tier del plan contratado
  valorMensual Float?  // MRR generado
  
  // Notas y motivos
  notas       String?  @db.Text
  motivoRechazo String? @db.Text // Si estado = CERRADO_PERDIDO
  
  // Relaciones
  comisiones  SalesCommission[]
  
  // Metadata
  metadata    Json @default("{}") // Información adicional
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([salesRepId])
  @@index([estado])
  @@index([convertido])
  @@index([companyId])
  @@index([fechaCaptura])
}

// Comisiones del equipo comercial
model SalesCommission {
  id          String   @id @default(cuid())
  
  // Comercial
  salesRepId  String
  salesRep    SalesRepresentative @relation(fields: [salesRepId], references: [id], onDelete: Cascade)
  
  // Lead/Cliente relacionado
  leadId      String?
  lead        SalesLead? @relation(fields: [leadId], references: [id], onDelete: SetNull)
  
  companyId   String? // Cliente que generó la comisión
  
  // Tipo y monto
  tipo        SalesCommissionType
  descripcion String
  periodo     String? // "2024-01" para comisiones recurrentes
  
  // Importes
  montoBase   Float   // Importe base de la operación
  porcentaje  Float?  // % aplicado (si aplica)
  montoComision Float // Comisión calculada
  
  // Retenciones (impuestos, IRPF)
  retencionIRPF Float @default(0) // % o monto fijo
  montoNeto   Float   // Monto después de retenciones
  
  // Estado
  estado      SalesCommissionStatus @default(PENDIENTE)
  fechaGeneracion DateTime @default(now())
  fechaAprobacion DateTime?
  fechaPago   DateTime?
  
  // Aprobación
  aprobadoPor String? // ID del usuario que aprobó
  notaAprobacion String? @db.Text
  
  // Pago
  referenciaPago String? // Número de transferencia/factura
  metodoPago  String? // "transferencia", "cheque", etc.
  comprobantePago String? // URL del comprobante
  
  // Metadata
  metadata    Json @default("{}") // Información adicional
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([salesRepId])
  @@index([leadId])
  @@index([estado])
  @@index([periodo])
  @@index([fechaGeneracion])
}

// Objetivos de ventas
model SalesTarget {
  id          String   @id @default(cuid())
  
  // Comercial
  salesRepId  String
  salesRep    SalesRepresentative @relation(fields: [salesRepId], references: [id], onDelete: Cascade)
  
  // Período
  periodo     String  // "2024-01", "Q1-2024", "2024"
  tipoObjetivo String  // "mensual", "trimestral", "anual"
  
  // Objetivos
  objetivoLeads Int // Número de leads a captar
  objetivoConversiones Int // Número de conversiones
  objetivoMRR Float // MRR a generar
  
  // Progreso actual
  leadsGenerados Int @default(0)
  conversionesLogradas Int @default(0)
  mrrGenerado Float @default(0)
  
  // Porcentajes de cumplimiento
  porcentajeLeads Float @default(0) // 0-100%
  porcentajeConversiones Float @default(0)
  porcentajeMRR Float @default(0)
  
  // Estado
  cumplido    Boolean @default(false)
  bonificacionPagada Boolean @default(false)
  montoBonificacion Float?
  
  // Fechas
  fechaInicio DateTime
  fechaFin    DateTime
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([salesRepId])
  @@index([periodo])
  @@index([cumplido])
  @@unique([salesRepId, periodo])
}

// ====================================
// SISTEMA DE PARTNERS AVANZADO
// ====================================

// Materiales de Marketing para Partners
model MarketingMaterial {
  id          String   @id @default(cuid())
  
  tipo        String   // "banner", "email_template", "landing_page", "video", "documento"
  titulo      String
  descripcion String   @db.Text
  url         String?  // URL del recurso (imagen, video, etc)
  contenido   String?  @db.Text // Contenido HTML/texto para templates
  tags        String[] // Para búsqueda y filtrado
  
  activo      Boolean  @default(true)
  
  downloads   MaterialDownload[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tipo])
  @@index([activo])
}

// Tracking de descargas de materiales por partners
model MaterialDownload {
  id          String   @id @default(cuid())
  
  salesRepId  String
  salesRep    SalesRepresentative @relation(fields: [salesRepId], references: [id], onDelete: Cascade)
  
  materialId  String
  material    MarketingMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  
  fechaDescarga DateTime @default(now())
  
  @@index([salesRepId])
  @@index([materialId])
}

// Certificaciones disponibles para Partners
model PartnerCertification {
  id          String   @id @default(cuid())
  
  nombre      String
  descripcion String   @db.Text
  nivel       String   // "basico", "intermedio", "avanzado", "experto"
  requisitos  String[] // Lista de requisitos para obtenerla
  beneficios  String[] // Beneficios de tener esta certificación
  
  activo      Boolean  @default(true)
  
  awarded     PartnerCertificationAwarded[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([nivel])
  @@index([activo])
}

// Certificaciones otorgadas a Partners
model PartnerCertificationAwarded {
  id              String   @id @default(cuid())
  
  salesRepId      String
  salesRep        SalesRepresentative @relation(fields: [salesRepId], references: [id], onDelete: Cascade)
  
  certificationId String
  certification   PartnerCertification @relation(fields: [certificationId], references: [id], onDelete: Cascade)
  
  fechaObtencion  DateTime @default(now())
  certificadoNumero String @unique // Número único de certificado
  
  @@index([salesRepId])
  @@index([certificationId])
}

// ==========================================
// COLIVING - ANALYTICS Y MÉTRICAS AVANZADAS
// ==========================================

enum NPSCategory {
  promotor     // 9-10
  pasivo       // 7-8
  detractor    // 0-6
}

enum PredictionStatus {
  favorable
  neutro
  desfavorable
}

model ColivingAnalytics {
  id String @id @default(cuid())

  // Empresa
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Periodo de análisis
  periodo     DateTime // Primer día del mes analizado
  mes         Int
  anio        Int

  // Métricas de Rotación (Churn)
  totalColivers         Int // Total de colivers activos al inicio del periodo
  coliversSalieron      Int // Cuántos se fueron durante el periodo
  churnRate             Float // Porcentaje de rotación (salieron / total * 100)
  promedioEstanciaMeses Float? // Promedio de meses que permanecen

  // Lifetime Value (LTV)
  ltvPromedio Float // Valor promedio que genera un coliver durante toda su estancia
  ltvMinimo   Float
  ltvMaximo   Float

  // Net Promoter Score (NPS)
  totalEncuestas Int @default(0)
  promotores     Int @default(0)
  pasivos        Int @default(0)
  detractores    Int @default(0)
  npsScore       Float? // (promotores - detractores) / total * 100

  // Análisis de perfil ideal
  perfilIdealEdadMin      Int?
  perfilIdealEdadMax      Int?
  perfilIdealOcupacion    String? // estudiante, profesional, freelance
  perfilIdealIngresoMin   Float?
  perfilIdealEstanciaMeses Int? // Estancia promedio óptima

  // Predicción de disponibilidad
  prediccionOcupacionProximoMes   Float? // % estimado de ocupación para el próximo mes
  prediccionDisponibilidadRoomsProximoMes Int? // Número estimado de habitaciones disponibles
  nivelConfianzaPrediccion             PredictionStatus @default(neutro)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, periodo])
  @@index([companyId])
  @@index([periodo])
  @@map("coliving_analytics")
}

model NPSSurvey {
  id String @id @default(cuid())

  // Empresa y Tenant
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Encuesta
  score         Int // 0-10
  categoria     NPSCategory
  comentario    String?      @db.Text
  fechaEncuesta DateTime
  respondido    Boolean      @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([tenantId])
  @@index([fechaEncuesta])
  @@map("nps_surveys")
}

model TenantProfile {
  id String @id @default(cuid())

  // Tenant
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Perfil demográfico
  edad       Int?
  ocupacion  String? // estudiante, profesional, freelance, emprendedor
  ingresos   Float?
  idiomas    String[] @default([])

  // Comportamiento
  horariosActividad       String? @db.Text // Descripción de horarios preferidos
  nivelSociabilidad       Int?    @default(5) // 1-10
  estiloVida              String? // tranquilo, social, deportista, workaholic
  preferenciaLimpieza     Int?    @default(5) // 1-10
  toleranciaRuido         Int?    @default(5) // 1-10
  frecuenciaUsoComunes    String? // alta, media, baja

  // Historial
  numeroConvivientes      Int    @default(0)
  incidentesReportados    Int    @default(0)
  puntuacionConvivencia   Float? // Promedio de ratings de convivientes
  mesesEnColiving         Int    @default(0)

  // Preferencias
  prefiereHabitacionPrivada Boolean @default(false)
  prefiereEdificioCentro    Boolean @default(false)
  interesEventos            Boolean @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tenant_profiles")
}

// ==========================================
// ESPACIOS COMPARTIDOS - MEJORAS AVANZADAS
// ==========================================

enum WaitlistStatus {
  activa
  notificado
  convertida
  cancelada
  expirada
}

model SpaceWaitlist {
  id String @id @default(cuid())

  // Empresa
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Espacio y Tenant
  spaceId String
  space   CommonSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Solicitud
  fechaSolicitud      DateTime @default(now())
  fechaDeseada        DateTime
  horaInicio          String // Formato "HH:mm"
  horaFin             String // Formato "HH:mm"
  duracionHoras       Int
  prioridad           Int      @default(1) // 1-10 (más alto = más prioridad)

  // Estado
  status          WaitlistStatus @default(activa)
  fechaNotificado DateTime?
  notasInternas   String?        @db.Text

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([spaceId])
  @@index([tenantId])
  @@index([status])
  @@index([fechaDeseada])
  @@map("space_waitlist")
}

model ReservationCredits {
  id String @id @default(cuid())

  // Tenant
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Créditos
  creditosActuales   Int   @default(10) // Créditos disponibles
  creditosMaximos    Int   @default(10) // Máximo de créditos por periodo
  creditosUsados     Int   @default(0) // Histórico de créditos usados
  penalizacionesTotal Int   @default(0) // Total de penalizaciones acumuladas

  // Renovación
  ultimaRecarga      DateTime @default(now())
  proximaRecarga     DateTime // Se recarga automáticamente cada mes

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reservation_credits")
}

enum RatingCategory {
  excelente    // 5 estrellas
  muy_bueno    // 4 estrellas
  bueno        // 3 estrellas
  regular      // 2 estrellas
  malo         // 1 estrella
}

model SpaceRating {
  id String @id @default(cuid())

  // Empresa
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Espacio y Tenant
  spaceId String
  space   CommonSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Reservación relacionada
  reservationId String          @unique
  reservation   SpaceReservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  // Valoración
  puntuacion     Int // 1-5 estrellas
  categoria      RatingCategory
  comentario     String?        @db.Text
  aspectosPositivos String[]    @default([])
  aspectosNegativos String[]    @default([])

  // Fecha
  fechaRating DateTime @default(now())

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([spaceId])
  @@index([tenantId])
  @@index([puntuacion])
  @@map("space_ratings")
}

model SpaceMaintenancePrediction {
  id String @id @default(cuid())

  // Empresa
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Espacio
  spaceId String
  space   CommonSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  // Análisis
  periodo                     DateTime @default(now())
  horasUsoEstimadas           Float // Horas de uso en el periodo
  numeroReservasCompletadas   Int
  promedioPersonasPorReserva  Float
  indiceDesgaste              Float // 0-100 (más alto = más desgaste)

  // Predicción
  mantenimientoSugerido       Boolean @default(false)
  tipoMantenimientoSugerido   String? // preventivo, correctivo, profunda_limpieza
  fechaSugeridaMantenimiento  DateTime?
  descripcionRecomendacion    String? @db.Text
  costoEstimado               Float?

  // Alertas
  nivelUrgencia  MaintenancePriority @default(baja)
  alertaEnviada  Boolean             @default(false)
  fechaAlerta    DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([spaceId])
  @@index([periodo])
  @@index([mantenimientoSugerido])
  @@map("space_maintenance_predictions")
}


// ============================================================================
// COMMUNITY MANAGEMENT ENHANCEMENTS - Pack 1
// Nuevos enums y modelos para mejorar el módulo de comunidad existente
// ============================================================================

enum CommunityEventStatus {
  borrador
  publicado
  en_curso
  finalizado
  cancelado
}

enum CommunityEventType {
  social
  formacion
  networking
  asamblea
  fiesta
  deporte
  cultural
  otro
}

enum AnnouncementPriority {
  urgente
  importante
  normal
  informativo
}

enum AnnouncementStatus {
  borrador
  activo
  programado
  expirado
  archivado
}

// Asistentes a eventos (nuevo modelo para gestión de inscripciones)
model EventAttendee {
  id String @id @default(cuid())

  eventId String

  // Participante (puede ser tenant o usuario externo)
  tenantId     String?
  tenant       Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  nombreExterno String?
  emailExterno  String?

  // Estado
  confirmado    Boolean   @default(false)
  enListaEspera Boolean   @default(false)
  fechaInscripcion DateTime @default(now())
  asistio       Boolean   @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, tenantId])
  @@index([eventId])
  @@index([tenantId])
  @@map("event_attendees")
}

// Comentarios en eventos
model EventComment {
  id String @id @default(cuid())

  eventId String

  // Autor
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  autorNombre String?

  // Contenido
  contenido String @db.Text
  moderado  Boolean @default(false)
  visible   Boolean @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId])
  @@index([tenantId])
  @@map("event_comments")
}

// Reacciones a posts (mejora del sistema de likes existente)
model PostReaction {
  id String @id @default(cuid())

  postId String

  // Usuario
  userId   String?
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  // Tipo de reacción
  tipo String @default("like") // like, love, celebrate, support, curious

  // Metadata
  createdAt DateTime @default(now())

  @@unique([postId, tenantId])
  @@index([postId])
  @@map("post_reactions")
}

// Confirmaciones de lectura de anuncios
model AnnouncementConfirmation {
  id String @id @default(cuid())

  announcementId String

  // Usuario
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  userId   String?

  // Confirmación
  leido     Boolean  @default(false)
  fechaLectura DateTime?
  confirmado Boolean  @default(false)
  fechaConfirmacion DateTime?

  // Metadata
  createdAt DateTime @default(now())

  @@unique([announcementId, tenantId])
  @@unique([announcementId, userId])
  @@index([announcementId])
  @@map("announcement_confirmations")
}

// Métricas de Engagement de Comunidad
model CommunityEngagementMetrics {
  id String @id @default(cuid())

  // Empresa y ubicación
  companyId  String
  company    Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  buildingId String?
  colivingId String?

  // Periodo
  periodo    DateTime @default(now())
  tipoPerido String   @default("diario") // diario, semanal, mensual

  // Métricas de eventos
  eventosCreados       Int @default(0)
  eventosRealizados    Int @default(0)
  asistenciaTotalEventos Int @default(0)
  tasaAsistenciaPromedio Float @default(0)

  // Métricas de posts
  postsCreados         Int @default(0)
  totalLikes           Int @default(0)
  totalComentarios     Int @default(0)
  totalCompartidos     Int @default(0)
  vistasTotales        Int @default(0)

  // Métricas de anuncios
  anunciosPublicados   Int @default(0)
  tasaLecturaAnuncios  Float @default(0)
  tasaConfirmacionAnuncios Float @default(0)

  // Participación general
  usuariosActivos      Int @default(0)
  nuevosParticipantes  Int @default(0)
  interaccionesTotal   Int @default(0)

  // Sentimiento
  sentimientoPromedio  Float @default(0) // -1 a 1

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([buildingId])
  @@index([colivingId])
  @@index([periodo])
  @@map("community_engagement_metrics")
}
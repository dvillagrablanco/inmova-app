# üõ°Ô∏è REGLAS DE BLINDAJE DE BASE DE DATOS Y CONFIGURACI√ìN

## ‚ö†Ô∏è REGLAS CR√çTICAS - NUNCA VIOLAR

### üî¥ REGLA #1: NUNCA SOBRESCRIBIR `.env.production` EN SERVIDOR

```bash
# ‚ùå PROHIBIDO
git pull  # Sin proteger .env.production
cp .env.example .env.production  # NUNCA sobrescribir
rm .env.production  # NUNCA eliminar

# ‚úÖ CORRECTO
# Antes de git pull, siempre hacer backup
cp .env.production /tmp/env.backup
git pull
cp /tmp/env.backup .env.production
```

**Consecuencia de violar**: Login deja de funcionar, usuarios no pueden autenticarse.

---

### üî¥ REGLA #2: NUNCA USAR `prisma migrate reset` EN PRODUCCI√ìN

```bash
# ‚ùå PROHIBIDO EN PRODUCCI√ìN
npx prisma migrate reset  # DESTRUYE TODOS LOS DATOS
npx prisma db push --force-reset  # DESTRUYE TODOS LOS DATOS
npx prisma migrate reset --force  # DESTRUYE TODOS LOS DATOS

# ‚úÖ CORRECTO
npx prisma db push  # Sincroniza schema sin destruir datos
npx prisma db push --accept-data-loss  # Solo si sabes qu√© haces
npx prisma migrate deploy  # Aplica migraciones pendientes
```

**Consecuencia de violar**: Se pierden TODOS los usuarios, propiedades, datos.

---

### üî¥ REGLA #3: SIEMPRE HACER BACKUP ANTES DE DEPLOY

```bash
# ‚úÖ OBLIGATORIO ANTES DE CADA DEPLOY
bash /opt/inmova-app/scripts/blindaje-db/01-backup-automatico.sh

# NUNCA hacer deploy sin backup
```

**Consecuencia de violar**: Si algo falla, no hay forma de recuperar datos.

---

### üî¥ REGLA #4: NUNCA CAMBIAR PASSWORD DE POSTGRESQL SIN ACTUALIZAR `.env`

```bash
# ‚ùå PROHIBIDO (desincroniza app y BD)
ALTER USER inmova_user WITH PASSWORD 'nueva_password';
# Sin actualizar DATABASE_URL en .env.production

# ‚úÖ CORRECTO
# 1. Cambiar password en PostgreSQL
ALTER USER inmova_user WITH PASSWORD 'nueva_password';
# 2. Actualizar .env.production inmediatamente
DATABASE_URL="postgresql://inmova_user:nueva_password@localhost:5432/inmova_production"
# 3. Reiniciar app
pm2 restart inmova-app
```

**Consecuencia de violar**: Aplicaci√≥n no puede conectar a BD, login falla.

---

### üî¥ REGLA #5: ARCHIVOS CR√çTICOS PROTEGIDOS (NUNCA SOBRESCRIBIR EN DEPLOY)

Lista de archivos que **NUNCA** deben ser sobrescritos por `git pull`:

```
/opt/inmova-app/.env.production           # Variables de entorno
/opt/inmova-app/ecosystem.config.js       # Config de PM2
/opt/inmova-app/create-superadmin.js      # Script de usuarios
/opt/inmova-app/start-with-env.sh         # Script de inicio
```

**Implementaci√≥n correcta**:

```bash
# En todo deploy, proteger estos archivos
cp .env.production /tmp/env.safe
cp ecosystem.config.js /tmp/ecosystem.safe
git pull
cp /tmp/env.safe .env.production
cp /tmp/ecosystem.safe ecosystem.config.js
```

---

## üîê CREDENCIALES INMUTABLES

### Base de Datos PostgreSQL

```bash
USUARIO: inmova_user
PASSWORD: InmovaSecure2026DB
BASE_DE_DATOS: inmova_production
HOST: localhost
PORT: 5432
```

**‚ö†Ô∏è NUNCA cambiar estos valores sin actualizar TODO el sistema.**

### Usuarios de Aplicaci√≥n

```bash
# Superadmin
EMAIL: superadmin@inmova.app
PASSWORD: Admin123!
ROLE: super_admin

# Admin alternativo
EMAIL: admin@inmova.app
PASSWORD: Admin123!
ROLE: super_admin
```

**‚ö†Ô∏è NUNCA borrar estos usuarios de la base de datos.**

---

## üìã CHECKLIST PRE-DEPLOY (OBLIGATORIO)

Antes de CUALQUIER deploy, ejecutar:

```bash
# 1. Verificar integridad actual
bash /opt/inmova-app/scripts/blindaje-db/02-verificar-integridad.sh

# 2. Si hay errores, restaurar
bash /opt/inmova-app/scripts/blindaje-db/03-restaurar-config.sh

# 3. Hacer backup
bash /opt/inmova-app/scripts/blindaje-db/01-backup-automatico.sh

# 4. Ejecutar deploy seguro
bash /opt/inmova-app/scripts/blindaje-db/04-deploy-seguro.sh
```

---

## üö´ COMANDOS PROHIBIDOS EN PRODUCCI√ìN

### NUNCA ejecutar:

```bash
# Base de datos
prisma migrate reset            # DESTRUYE DATOS
prisma db push --force-reset    # DESTRUYE DATOS
DROP DATABASE inmova_production # DESTRUYE TODO
TRUNCATE TABLE users            # BORRA USUARIOS

# Archivos
rm .env.production              # ROMPE CONFIGURACI√ìN
rm -rf /opt/inmova-app          # DESTRUYE APLICACI√ìN
git reset --hard HEAD           # Sin proteger archivos cr√≠ticos
git clean -fd                   # Sin proteger archivos cr√≠ticos

# PM2
pm2 delete all                  # Sin verificar backup antes
pm2 kill                        # Sin plan de restauraci√≥n
```

---

## ‚úÖ COMANDOS SEGUROS APROBADOS

### Para deploy:

```bash
# Uso obligatorio del script de deploy seguro
bash /opt/inmova-app/scripts/blindaje-db/04-deploy-seguro.sh
```

### Para sincronizar schema:

```bash
# SOLO usar db push (no destructivo)
cd /opt/inmova-app
source .env.production
npx prisma db push --accept-data-loss
```

### Para reiniciar aplicaci√≥n:

```bash
# Restart seguro de PM2
pm2 restart inmova-app
# O reload (zero-downtime)
pm2 reload inmova-app
```

---

## üîç VERIFICACIONES CONTINUAS

### Cron Jobs obligatorios:

```bash
# Backup diario (2 AM)
0 2 * * * /opt/inmova-app/scripts/blindaje-db/01-backup-automatico.sh

# Verificaci√≥n de integridad (cada hora)
0 * * * * /opt/inmova-app/scripts/blindaje-db/02-verificar-integridad.sh

# Auto-restauraci√≥n si falla verificaci√≥n (cada 6 horas)
0 */6 * * * /opt/inmova-app/scripts/blindaje-db/02-verificar-integridad.sh || /opt/inmova-app/scripts/blindaje-db/03-restaurar-config.sh
```

---

## üÜò PROCEDIMIENTO DE EMERGENCIA

Si el login deja de funcionar:

```bash
# 1. NO ENTRAR EN P√ÅNICO
# 2. Ejecutar restauraci√≥n autom√°tica
bash /opt/inmova-app/scripts/blindaje-db/03-restaurar-config.sh

# 3. Si falla, restaurar BD manualmente
cd /opt/inmova-backups
LATEST=$(ls -t db_*.sql | head -1)
PGPASSWORD='InmovaSecure2026DB' psql -h localhost -U inmova_user -d inmova_production < $LATEST

# 4. Recrear usuarios cr√≠ticos
cd /opt/inmova-app
node create-superadmin.js

# 5. Reiniciar y verificar
pm2 restart inmova-app
sleep 10
bash /opt/inmova-app/scripts/blindaje-db/02-verificar-integridad.sh
```

---

## üìä LOGS Y MONITOREO

### Archivos de log cr√≠ticos:

```bash
/var/log/inmova-backup.log       # Logs de backups
/var/log/inmova-integrity.log    # Logs de verificaci√≥n
/root/.pm2/logs/inmova-app-*.log # Logs de aplicaci√≥n
```

### Comandos de monitoreo:

```bash
# Ver √∫ltimos backups
ls -lht /opt/inmova-backups/ | head -10

# Ver estado de BD
PGPASSWORD='InmovaSecure2026DB' psql -h localhost -U inmova_user -d inmova_production -c "SELECT COUNT(*) FROM users;"

# Ver estado de aplicaci√≥n
pm2 status inmova-app
curl http://localhost:3000/api/health
```

---

## üéì CAPACITACI√ìN OBLIGATORIA

Todo desarrollador debe:

1. ‚úÖ Leer completamente este documento
2. ‚úÖ Practicar deploy seguro en entorno de desarrollo
3. ‚úÖ Conocer ubicaci√≥n de backups
4. ‚úÖ Saber ejecutar procedimiento de emergencia
5. ‚úÖ NUNCA hacer deploy sin usar scripts de blindaje

---

## üìù CHANGELOG

- **2026-01-02**: Creaci√≥n del sistema de blindaje
- **2026-01-02**: Implementaci√≥n de scripts de backup/restauraci√≥n
- **2026-01-02**: Documentaci√≥n de reglas cr√≠ticas

---

## ‚öñÔ∏è POL√çTICA DE CUMPLIMIENTO

**Violar estas reglas puede resultar en**:
- P√©rdida de datos de usuarios
- Downtime de la aplicaci√≥n
- P√©rdida de confianza del cliente
- Horas de trabajo de recuperaci√≥n

**Por lo tanto**:
- ‚úÖ SIEMPRE usar scripts de blindaje
- ‚úÖ SIEMPRE hacer backup antes de cambios
- ‚úÖ NUNCA usar comandos destructivos
- ‚úÖ SIEMPRE verificar integridad post-deploy

---

**üõ°Ô∏è Sistema de Blindaje de BD - Protegiendo tus datos 24/7**

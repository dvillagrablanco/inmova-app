name: ğŸš€ Deploy Sprints 1+2+3 + GitHub Actions auto-deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to inmova.app (Hetzner)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3
      
      - name: ğŸ” Configure SSH
        env:
          SSH_KEY: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}
          SERVER_HOST: 46.224.120.160
          SERVER_USER: root
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/hetzner_key
          chmod 600 ~/.ssh/hetzner_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
          
      - name: ğŸš€ Deploy to Server
        env:
          SERVER_HOST: 46.224.120.160
          SERVER_USER: root
          APP_DIR: /opt/inmova-app
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸš€ INMOVA - Deployment to Hetzner Production"
          echo "  ğŸ“ Server: $SERVER_HOST"
          echo "  ğŸ“‚ Directory: $APP_DIR"
          echo "  ğŸŒ URL: https://www.inmova.app"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Step 1: Create backup
          ssh -i ~/.ssh/hetzner_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            APP_DIR="/opt/inmova-app"
            BACKUP_DIR="/opt/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "ğŸ’¾ [1/8] Creando backup..."
            mkdir -p $BACKUP_DIR
            cd $APP_DIR
            tar -czf $BACKUP_DIR/backup_${TIMESTAMP}.tar.gz \
              --exclude='node_modules' \
              --exclude='.next' \
              --exclude='uploads' \
              --exclude='.git' \
              . 2>/dev/null || true
            echo "   âœ“ Backup creado: backup_${TIMESTAMP}.tar.gz"
            
            echo "ğŸ›‘ [2/8] Deteniendo aplicaciÃ³n..."
            pm2 stop inmova-app || echo "   âš  App no estaba corriendo"
          ENDSSH
          
          # Step 2: Sync files with rsync
          echo "ğŸ“¡ [3/8] Sincronizando archivos..."
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/hetzner_key -o StrictHostKeyChecking=no" \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='uploads' \
            --exclude='.git' \
            --exclude='.env' \
            ./ $SERVER_USER@$SERVER_HOST:$APP_DIR/
          echo "   âœ“ Archivos sincronizados"
          
          # Step 3: Install dependencies, build, and restart
          ssh -i ~/.ssh/hetzner_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            APP_DIR="/opt/inmova-app"
            cd $APP_DIR
            
            echo "ğŸ“¦ [4/8] Instalando dependencias..."
            yarn install --frozen-lockfile --production=false
            echo "   âœ“ Dependencias instaladas"
            
            echo "ğŸ—„ï¸  [5/8] Generando Prisma Client..."
            yarn prisma generate
            echo "   âœ“ Prisma Client generado"
            
            echo "ğŸ—ï¸  [6/8] Construyendo aplicaciÃ³n..."
            NODE_OPTIONS="--max-old-space-size=4096" yarn build
            echo "   âœ“ Build completado"
            
            echo "â–¶ï¸  [7/8] Reiniciando aplicaciÃ³n..."
            pm2 restart inmova-app
            pm2 save
            echo "   âœ“ AplicaciÃ³n reiniciada"
            
            echo "ğŸ” [8/8] Verificando estado..."
            sleep 5
            pm2 list | grep inmova-app
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  âœ… DEPLOYMENT COMPLETADO EXITOSAMENTE"
            echo "  ğŸŒ https://www.inmova.app estÃ¡ actualizado"
            echo "  ğŸ“Š Verificar logs: pm2 logs inmova-app"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ENDSSH
      
      - name: âœ… Deployment Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Deployment to Hetzner completed successfully!"
          echo "ğŸ“± Application is now live at: https://www.inmova.app"
          
      - name: âŒ Deployment Failure Notification
        if: failure()
        run: |
          echo "âš ï¸ Deployment failed! Please check the logs above."
          echo "ğŸ”„ To rollback, SSH to server and restore from backup in /opt/backups/"

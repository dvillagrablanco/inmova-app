name: Deploy to Hetzner Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'RazÃ³n del deployment manual'
        required: false
        default: 'Manual deployment'

jobs:
  deploy:
    name: Deploy to inmova.app (Hetzner)
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Obtener todo el historial
      
      - name: ğŸ” Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}
      
      - name: ğŸ–¥ï¸  Add Hetzner Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 46.224.120.160 >> ~/.ssh/known_hosts
          echo "âœ“ Hetzner server added to known hosts"
      
      - name: ğŸš€ Deploy to Hetzner via SSH
        env:
          SERVER_USER: root
          SERVER_HOST: 46.224.120.160
          APP_DIR: /opt/inmova-app
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸš€ INMOVA - Deployment to Hetzner Production"
          echo "  ğŸ“ Server: $SERVER_HOST"
          echo "  ğŸ“‚ Directory: $APP_DIR"
          echo "  ğŸŒ URL: https://www.inmova.app"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e  # Exit on error
            
            # Variables
            APP_DIR="/opt/inmova-app"
            BACKUP_DIR="/opt/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "ğŸ“‚ [1/9] Navegando al directorio del proyecto..."
            cd $APP_DIR
            
            echo "ğŸ’¾ [2/9] Creando backup..."
            mkdir -p $BACKUP_DIR
            tar -czf $BACKUP_DIR/backup_${TIMESTAMP}.tar.gz \
              --exclude='node_modules' \
              --exclude='.next' \
              --exclude='uploads' \
              app components lib prisma public package.json .env 2>/dev/null || true
            echo "   âœ“ Backup creado: backup_${TIMESTAMP}.tar.gz"
            
            echo "ğŸ›‘ [3/9] Deteniendo aplicaciÃ³n..."
            pm2 stop inmova-app || echo "   âš  App no estaba corriendo"
            
            echo "ğŸ“¡ [4/9] Obteniendo cambios desde GitHub..."
            git fetch origin main
            git reset --hard origin/main
            echo "   âœ“ CÃ³digo actualizado"
            
            echo "ğŸ“¦ [5/9] Instalando dependencias..."
            yarn install --frozen-lockfile --production=false
            echo "   âœ“ Dependencias instaladas"
            
            echo "ğŸ—„ï¸  [6/9] Generando Prisma Client..."
            yarn prisma generate
            echo "   âœ“ Prisma Client generado"
            
            echo "ğŸ—ï¸  [7/9] Construyendo aplicaciÃ³n..."
            NODE_OPTIONS="--max-old-space-size=4096" yarn build
            echo "   âœ“ Build completado"
            
            echo "â–¶ï¸  [8/9] Reiniciando aplicaciÃ³n..."
            pm2 restart inmova-app
            pm2 save
            echo "   âœ“ AplicaciÃ³n reiniciada"
            
            echo "ğŸ” [9/9] Verificando estado..."
            sleep 5
            pm2 list | grep inmova-app
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  âœ… DEPLOYMENT COMPLETADO EXITOSAMENTE"
            echo "  ğŸŒ https://www.inmova.app estÃ¡ actualizado"
            echo "  ğŸ“Š Verificar logs: pm2 logs inmova-app"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ENDSSH
      
      - name: âœ… Deployment Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Deployment to Hetzner completed successfully!"
          echo "ğŸ“Š Server: 46.224.120.160"
          echo "ğŸŒ URL: https://www.inmova.app"
          echo "â° Timestamp: $(date)"
      
      - name: âŒ Deployment Failure Notification
        if: failure()
        run: |
          echo "âš ï¸  Deployment to Hetzner FAILED!"
          echo "ğŸ“‹ Check the logs above for error details"
          echo "ğŸ”„ You may need to restore from backup:"
          echo "   ssh root@46.224.120.160 'cd /opt/inmova-app && pm2 stop inmova-app && tar -xzf /opt/backups/backup_*.tar.gz --overwrite && pm2 restart inmova-app'"

name: Configure NextAuth on Production

# Este workflow configura NextAuth en el servidor de producciÃ³n
# Se ejecuta manualmente desde GitHub Actions

on:
  workflow_dispatch:
    inputs:
      generate_new_secret:
        description: 'Generar nuevo NEXTAUTH_SECRET (si = yes, no = mantener existente)'
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  configure-nextauth:
    runs-on: ubuntu-latest
    name: Configurar NextAuth en Hetzner
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ” Setup SSH
        env:
          SSH_KEY: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}
          SERVER_HOST: 46.224.120.160
          SERVER_USER: root
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/hetzner_key
          chmod 600 ~/.ssh/hetzner_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

      - name: âš™ï¸ Configurar NextAuth en Servidor
        env:
          SERVER_HOST: 46.224.120.160
          SERVER_USER: root
          APP_DIR: /opt/inmova-app
          GENERATE_NEW: ${{ github.event.inputs.generate_new_secret }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” INMOVA - ConfiguraciÃ³n de NextAuth"
          echo "  ğŸ“ Servidor: $SERVER_HOST"
          echo "  ğŸ“‚ Directorio: $APP_DIR"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          ssh -i ~/.ssh/hetzner_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            
            APP_DIR="/opt/inmova-app"
            cd $APP_DIR
            
            echo "ğŸ“‚ Directorio actual: $(pwd)"
            echo ""
            
            # Crear backup del .env actual si existe
            if [ -f .env ]; then
              BACKUP_FILE=".env.backup.$(date +%Y%m%d_%H%M%S)"
              echo "ğŸ’¾ Creando backup: $BACKUP_FILE"
              cp .env "$BACKUP_FILE"
              echo "âœ… Backup creado: $BACKUP_FILE"
            else
              echo "âš ï¸  No existe archivo .env, creando uno nuevo..."
              touch .env
              echo "âœ… Archivo .env creado"
            fi
            echo ""
            
            # Generar o mantener NEXTAUTH_SECRET
            if [ "$GENERATE_NEW" = "yes" ]; then
              echo "ğŸ”‘ Generando nuevo NEXTAUTH_SECRET..."
              NEXTAUTH_SECRET=$(openssl rand -base64 32)
              echo "âœ… Nuevo secret generado: ${NEXTAUTH_SECRET:0:20}...****** (oculto)"
              
              # Actualizar o aÃ±adir NEXTAUTH_SECRET
              if grep -q "^NEXTAUTH_SECRET=" .env; then
                sed -i "s|^NEXTAUTH_SECRET=.*|NEXTAUTH_SECRET=${NEXTAUTH_SECRET}|" .env
                echo "âœ… NEXTAUTH_SECRET actualizado en .env"
              else
                echo "" >> .env
                echo "# NextAuth Configuration" >> .env
                echo "NEXTAUTH_SECRET=${NEXTAUTH_SECRET}" >> .env
                echo "âœ… NEXTAUTH_SECRET aÃ±adido a .env"
              fi
            else
              echo "â­ï¸  Manteniendo NEXTAUTH_SECRET existente (si existe)"
              if ! grep -q "^NEXTAUTH_SECRET=" .env; then
                echo "âš ï¸  No se encontrÃ³ NEXTAUTH_SECRET existente, generando uno nuevo..."
                NEXTAUTH_SECRET=$(openssl rand -base64 32)
                echo "" >> .env
                echo "# NextAuth Configuration" >> .env
                echo "NEXTAUTH_SECRET=${NEXTAUTH_SECRET}" >> .env
                echo "âœ… NEXTAUTH_SECRET aÃ±adido a .env"
              fi
            fi
            echo ""
            
            # Configurar NEXTAUTH_URL
            if grep -q "^NEXTAUTH_URL=" .env; then
              sed -i "s|^NEXTAUTH_URL=.*|NEXTAUTH_URL=https://www.inmova.app|" .env
              echo "âœ… NEXTAUTH_URL actualizado: https://www.inmova.app"
            else
              echo "NEXTAUTH_URL=https://www.inmova.app" >> .env
              echo "âœ… NEXTAUTH_URL aÃ±adido: https://www.inmova.app"
            fi
            echo ""
            
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  âœ… ConfiguraciÃ³n Completada"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # Mostrar variables configuradas (sin valores sensibles)
            echo "ğŸ“‹ Variables configuradas en .env:"
            grep -E '^(NEXTAUTH_URL|DATABASE_URL|POSTGRES_PASSWORD)' .env | sed 's/=.*/=***/' | head -10 || echo "No se encontraron variables"
            echo ""
            
            # Reiniciar aplicaciÃ³n
            echo "ğŸ”„ Reiniciando aplicaciÃ³n..."
            pm2 restart inmova-app || echo "âš ï¸  PM2 no encontrado o app no corriendo"
            echo ""
            
            # Esperar y verificar
            echo "â³ Esperando 5 segundos para estabilizaciÃ³n..."
            sleep 5
            echo ""
            
            echo "ğŸ“Š Estado de la aplicaciÃ³n:"
            pm2 status inmova-app || echo "âš ï¸  No se pudo obtener el estado"
            echo ""
            
            echo "ğŸ“ Ãšltimos 20 logs:"
            pm2 logs inmova-app --lines 20 --nostream || echo "âš ï¸  No se pudieron obtener los logs"
            echo ""
            
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  ğŸ‰ Â¡Proceso Completado!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ§ª PRUEBA EL LOGIN AHORA:"
            echo "   1. Ve a: https://www.inmova.app"
            echo "   2. Click en 'Iniciar SesiÃ³n'"
            echo "   3. Usa: admin@inmova.app / Admin2025!"
            echo "   4. DeberÃ­as acceder al dashboard sin errores"
            echo ""
          ENDSSH
          
          echo ""
          echo "âœ… Â¡NextAuth configurado exitosamente en producciÃ³n!"
          echo ""
          echo "ğŸ”— Verifica el login en: https://www.inmova.app"
          echo ""

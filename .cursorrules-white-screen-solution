# ğŸ¯ CURSORRULES: SOLUCIÃ“N DEFINITIVA PANTALLA BLANCA

## ğŸ“‹ CONTEXTO DEL PROBLEMA

**SÃ­ntoma:** La aplicaciÃ³n carga inicialmente, pero despuÃ©s de ~500ms la pantalla se pone completamente blanca.

**Causa RaÃ­z:** Errores de JavaScript no capturados que rompen el Ã¡rbol de componentes de React, sin Error Boundary efectivo que muestre UI de fallback.

## ğŸ› ï¸ SOLUCIÃ“N IMPLEMENTADA

### Arquitectura de la SoluciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           React Component Tree              â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  EnhancedErrorBoundary (OUTER)      â”‚  â”‚
â”‚  â”‚  - Captura errores de providers     â”‚  â”‚
â”‚  â”‚  - UI garantizada con inline styles â”‚  â”‚
â”‚  â”‚                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  WhiteScreenMonitor            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Detecta pantalla blanca     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Monitoreo cada 5s           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - RecuperaciÃ³n automÃ¡tica     â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  Providers (SessionProvider,   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  QueryProvider, ThemeProvider) â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  {children}                    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Componentes Clave

#### 1. EnhancedErrorBoundary
**UbicaciÃ³n:** `components/ui/enhanced-error-boundary.tsx`

**Responsabilidades:**
- Capturar TODOS los errores de JavaScript en el Ã¡rbol de componentes
- Mostrar UI de error garantizada (inline styles, no CSS externo)
- Proveer mÃºltiples opciones de recuperaciÃ³n (reset, reload, home)
- Prevenir loops infinitos con contador de errores
- Logging detallado para debugging

**Uso:**
```typescript
import { EnhancedErrorBoundary } from '@/components/ui/enhanced-error-boundary';

<EnhancedErrorBoundary 
  onError={(error, errorInfo) => {
    console.error('Error capturado:', error);
    // Log a Sentry, etc.
  }}
>
  <App />
</EnhancedErrorBoundary>
```

#### 2. WhiteScreenDetector
**UbicaciÃ³n:** `lib/white-screen-detector.ts`

**Responsabilidades:**
- Detectar pantalla blanca mediante 6 checks diferentes
- Monitoreo continuo cada 5 segundos
- RecuperaciÃ³n automÃ¡tica (re-render forzado)
- Mostrar UI de emergencia si falla recuperaciÃ³n
- Logging de eventos para anÃ¡lisis

**Checks realizados:**
1. âœ… `hasBodyContent`: Verificar que el body tenga hijos
2. âœ… `hasVisibleElements`: Contar elementos visibles (> 10)
3. âœ… `hasVisibleText`: Verificar texto visible (> 20 chars)
4. âœ… `hasProperHeight`: Verificar altura del body (> 100px)
5. âœ… `hasReactRoot`: Verificar presencia de React root
6. âœ… `hasWhiteBackground`: Detectar fondo blanco

**Uso:**
```typescript
import { WhiteScreenDetector } from '@/lib/white-screen-detector';

const detector = WhiteScreenDetector.getInstance();
detector.start((details) => {
  console.error('Pantalla blanca detectada:', details);
  // Enviar a monitoreo
});
```

#### 3. WhiteScreenMonitor Component
**UbicaciÃ³n:** `components/WhiteScreenMonitor.tsx`

**Responsabilidades:**
- Integrar WhiteScreenDetector en el Ã¡rbol de componentes
- Activar solo en producciÃ³n (o con flag)
- Reportar eventos a servicios de monitoreo

**Uso:**
```typescript
<Providers>
  <WhiteScreenMonitor />
  {children}
</Providers>
```

## ğŸ§ª TESTING CON PLAYWRIGHT

### Suite de Tests
**UbicaciÃ³n:** `e2e/white-screen-detection.spec.ts`

**Tests incluidos:**
1. âœ… Carga sin pantalla blanca
2. âœ… Mantiene contenido despuÃ©s de 500ms
3. âœ… Mantiene contenido despuÃ©s de 2500ms
4. âœ… Muestra error boundary en lugar de pantalla blanca
5. âœ… Se recupera de errores de hidrataciÃ³n
6. âœ… Maneja navegaciÃ³n sin pantalla blanca
7. âœ… Detecta pantalla blanca simulada
8. âœ… Monitorea continuamente durante interacciones
9. âœ… Carga en menos de 3 segundos
10. âœ… Muestra contenido progresivamente (no blanco durante carga)

### Ejecutar Tests

```bash
# Todos los tests
npx playwright test e2e/white-screen-detection.spec.ts

# Con UI mode
npx playwright test e2e/white-screen-detection.spec.ts --ui

# Solo un test especÃ­fico
npx playwright test e2e/white-screen-detection.spec.ts -g "debe cargar sin pantalla blanca"

# Generar report
npx playwright test e2e/white-screen-detection.spec.ts --reporter=html
```

### Helper de DetecciÃ³n

```typescript
async function checkForWhiteScreen(page: Page): Promise<boolean> {
  return await page.evaluate(() => {
    const visibleElements = Array.from(document.querySelectorAll('*'))
      .filter(el => {
        const style = window.getComputedStyle(el);
        return style.display !== 'none' && 
               style.visibility !== 'hidden' && 
               style.opacity !== '0';
      });

    const bodyText = document.body.innerText?.trim() || '';
    const bodyHeight = document.body.offsetHeight;
    const bodyBg = window.getComputedStyle(document.body).backgroundColor;
    const isWhiteBg = bodyBg === 'rgb(255, 255, 255)' || bodyBg === 'white';

    return isWhiteBg && (
      visibleElements.length < 10 ||
      bodyText.length < 20 ||
      bodyHeight < 100
    );
  });
}
```

## ğŸš¨ PREVENCIÃ“N DE PROBLEMAS COMUNES

### 1. Errores de HidrataciÃ³n

**âŒ PROBLEMA:**
```typescript
// Mismatch entre server y client
<div>{new Date().toString()}</div>
<div>{Math.random()}</div>
```

**âœ… SOLUCIÃ“N:**
```typescript
// Usar componentes client-side con hydration fix
'use client';

export function ClientOnlyDate() {
  const [date, setDate] = useState<string | null>(null);
  
  useEffect(() => {
    setDate(new Date().toString());
  }, []);
  
  if (!date) return <div>Cargando...</div>;
  return <div>{date}</div>;
}
```

### 2. Errores en Providers

**âŒ PROBLEMA:**
```typescript
// localStorage undefined en SSR
const ThemeProvider = ({ children }) => {
  const [theme, setTheme] = useState(localStorage.theme); // âŒ Crash en SSR
  return <ThemeContext.Provider value={theme}>{children}</ThemeContext.Provider>;
};
```

**âœ… SOLUCIÃ“N:**
```typescript
'use client';

const ThemeProvider = ({ children }) => {
  const [theme, setTheme] = useState<string | null>(null);
  
  useEffect(() => {
    // Solo en cliente
    setTheme(localStorage.getItem('theme') || 'light');
  }, []);
  
  return <ThemeContext.Provider value={theme}>{children}</ThemeContext.Provider>;
};
```

### 3. Dynamic Imports Sin Error Handling

**âŒ PROBLEMA:**
```typescript
const HeavyComponent = dynamic(() => import('./Heavy'), {
  loading: () => null, // âŒ No loading state
});
```

**âœ… SOLUCIÃ“N:**
```typescript
const HeavyComponent = dynamic(() => import('./Heavy'), {
  loading: () => <LoadingSpinner />,
  ssr: false,
});

// En el componente que lo usa
<ErrorBoundary fallback={<ErrorFallback />}>
  <HeavyComponent />
</ErrorBoundary>
```

### 4. CSS que Oculta Contenido

**âŒ PROBLEMA:**
```css
/* Si .loaded nunca se aplica, queda invisible */
body {
  opacity: 0;
  transition: opacity 0.3s;
}

body.loaded {
  opacity: 1;
}
```

**âœ… SOLUCIÃ“N:**
```css
/* Opacidad por defecto visible */
body {
  opacity: 1;
  transition: opacity 0.3s;
}

body.loading {
  opacity: 0.5; /* Visible pero atenuado */
}
```

## ğŸ“Š MONITOREO Y LOGGING

### IntegraciÃ³n con Sentry

```typescript
// components/WhiteScreenMonitor.tsx
import * as Sentry from '@sentry/nextjs';

export function WhiteScreenMonitor() {
  const { start } = useWhiteScreenDetector();

  useEffect(() => {
    start((details) => {
      // Log a Sentry
      Sentry.captureMessage('White Screen Detected', {
        level: 'error',
        extra: {
          ...details,
          userAgent: navigator.userAgent,
          url: window.location.href,
        },
        tags: {
          type: 'white_screen',
          recovery_attempted: true,
        },
      });
    });
  }, [start]);

  return null;
}
```

### Custom Logging Endpoint

```typescript
// app/api/log-error/route.ts
import { NextRequest, NextResponse } from 'next/server';

export async function POST(req: NextRequest) {
  const body = await req.json();
  
  // Log a base de datos, servicio externo, etc.
  console.error('[API] White Screen Detected:', body);
  
  // Guardar en BD
  await prisma.errorLog.create({
    data: {
      type: 'WHITE_SCREEN',
      details: body,
      userAgent: req.headers.get('user-agent'),
      timestamp: new Date(),
    },
  });
  
  return NextResponse.json({ success: true });
}
```

## ğŸ”§ CONFIGURACIÃ“N DE VARIABLES DE ENTORNO

```env
# .env.local (Development)
NEXT_PUBLIC_FORCE_WHITE_SCREEN_MONITOR=true

# .env.production
NEXT_PUBLIC_FORCE_WHITE_SCREEN_MONITOR=false  # Se activa automÃ¡ticamente en prod
```

## ğŸ“ˆ MÃ‰TRICAS Y KPIs

### Indicadores de Ã‰xito

1. **Error Capture Rate**: 100% de errores capturados por ErrorBoundary
2. **White Screen Incidents**: 0 reportes de pantalla blanca
3. **Auto-Recovery Rate**: > 80% de casos se recuperan automÃ¡ticamente
4. **Mean Time to Recovery (MTTR)**: < 5 segundos
5. **User-Initiated Reloads**: < 5% de usuarios necesitan recargar

### Dashboards de Monitoreo

```typescript
// Query para Sentry
sentryEvent.type === 'white_screen' 
  && sentryEvent.timestamp > last_7_days
```

## ğŸ¯ CHECKLIST DE IMPLEMENTACIÃ“N

### Fase 1: InstalaciÃ³n
- [x] Copiar `EnhancedErrorBoundary` a proyecto
- [x] Copiar `WhiteScreenDetector` a proyecto
- [x] Copiar `WhiteScreenMonitor` a proyecto
- [x] Actualizar `Providers` para usar nuevos componentes

### Fase 2: Testing
- [x] Copiar suite de tests de Playwright
- [x] Ejecutar tests localmente
- [x] Verificar que todos los tests pasan
- [x] Revisar screenshots generados

### Fase 3: Despliegue
- [ ] Deploy a staging
- [ ] Verificar en staging (24 horas)
- [ ] Deploy a producciÃ³n
- [ ] Monitorear logs (1 semana)

### Fase 4: OptimizaciÃ³n
- [ ] Analizar logs de white screen detection
- [ ] Optimizar estrategias de recuperaciÃ³n
- [ ] Ajustar thresholds de detecciÃ³n
- [ ] Documentar casos edge

## ğŸš€ COMANDOS RÃPIDOS

```bash
# Ejecutar tests
npm run test:e2e:white-screen

# Con UI para debugging
npm run test:e2e:white-screen:ui

# Solo verificar carga de landing
npx playwright test -g "debe cargar la landing page"

# Generar report HTML
npx playwright test e2e/white-screen-detection.spec.ts --reporter=html
```

## ğŸ“š RECURSOS Y REFERENCIAS

- [React Error Boundaries Docs](https://react.dev/reference/react/Component#catching-rendering-errors-with-an-error-boundary)
- [Playwright Testing Best Practices](https://playwright.dev/docs/best-practices)
- [Next.js Error Handling](https://nextjs.org/docs/advanced-features/error-handling)
- [Sentry React Integration](https://docs.sentry.io/platforms/javascript/guides/react/)
- [Web Vitals](https://web.dev/vitals/)

## ğŸ› TROUBLESHOOTING

### Problema: Tests fallan con "pantalla blanca detectada"

**SoluciÃ³n:**
1. Verificar que EnhancedErrorBoundary estÃ¡ en Providers
2. Verificar que no hay CSS que oculte contenido
3. Revisar logs de consola en el test
4. Tomar screenshot para anÃ¡lisis visual

### Problema: WhiteScreenMonitor no se activa

**SoluciÃ³n:**
1. Verificar NODE_ENV=production o flag activado
2. Verificar que el componente estÃ¡ montado
3. Revisar logs de consola para errores
4. Verificar que el detector no estÃ¡ en stop()

### Problema: Recovery UI no aparece

**SoluciÃ³n:**
1. Verificar que pasan > 3 segundos despuÃ©s de detecciÃ³n
2. Verificar que no hay overlay duplicado (#white-screen-recovery)
3. Revisar logs de attemptRecovery()
4. Verificar que document.body existe

## ğŸ“ CHANGELOG

### v1.0.0 (2 Enero 2026)
- âœ… ImplementaciÃ³n inicial de EnhancedErrorBoundary
- âœ… ImplementaciÃ³n de WhiteScreenDetector
- âœ… ImplementaciÃ³n de WhiteScreenMonitor
- âœ… Suite completa de tests de Playwright
- âœ… DocumentaciÃ³n completa
- âœ… IntegraciÃ³n con Providers

---

**Mantenido por:** Equipo Inmova  
**Ãšltima actualizaciÃ³n:** 2 de Enero de 2026  
**VersiÃ³n:** 1.0.0  
**Estado:** âœ… ProducciÃ³n